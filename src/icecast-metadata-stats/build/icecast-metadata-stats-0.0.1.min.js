/*! 
 * Copyright 2021 Ethan Halsall
 * https://github.com/eshaz/icecast-metadata-js
 *
 * This file is part of icecast-metadata-stats.
 *
 * icecast-metadata-stats free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * icecast-metadata-stats distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
var IcecastMetadataStats;(()=>{var t={764:t=>{const s=()=>{};t.exports=class{constructor({icyBr:t,onMetadataUpdate:e=s,onMetadataEnqueue:i=s}){this.t=t,this.i=e,this.h=i,this.l=!0,this.u=[]}get metadataQueue(){return this.u.map((({m:t,...s})=>s))}addMetadata({metadata:t,stats:s},e,i=0){this.g(t,e,i+this.getTimeByBytes(s.currentStreamPosition))}getTimeByBytes(t){return this.t?t/(125*this.t):0}purgeMetadataQueue(){this.u.forEach((t=>clearTimeout(t.m))),this.u=[]}g(t,s,e){const i={metadata:t,timestampOffset:s,timestamp:e};this.u.push(i),this.h(t,s,e),this.l?(this.p(),this.l=!1):i.m=setTimeout((()=>{this.p()}),1e3*(s-e))}p(){const{metadata:t,timestampOffset:s,timestamp:e}=this.u.shift();this.i(t,s,e)}}},420:(t,s,e)=>{const i=e(395),a=e(103),r=e(361),n=e(399);t.exports=class{constructor({metadataTypes:t=["icy"],...s}={}){const e=t.includes("icy"),h=t.includes("ogg");this.I=e&&h?new n(s):h?new r(s):e?new a(s):new i(s)}static parseIcyMetadata(t){return a.parseIcyMetadata(t)}get icyMetaInt(){return this.I.icyMetaInt}*iterator(t){yield*this.I.iterator(t)}readAll(t){this.I.readAll(t)}async*asyncIterator(t){return yield*this.I.asyncIterator(t)}async asyncReadAll(t){return this.I.asyncReadAll(t)}}},705:(t,s,e)=>{const i=e(420),a=()=>{};class r{constructor(t,{icyMetaInt:s,onStream:e=a,...n}){let h;this.M=new ReadableStream({async start(a){h=new i({...n,icyMetaInt:parseInt(t.headers.get("Icy-MetaInt"))||s,onStream:async t=>(a.enqueue(t.stream),e(t))});for await(const s of r.asyncIterator(t.body))await h.asyncReadAll(s);a.close()}}),this.A=h}get icyMetaInt(){return this.A.icyMetaInt}get readableStream(){return this.M}async startReading(){try{for await(const t of r.asyncIterator(this.M));}catch(t){if("AbortError"!==t.name)throw t}}static asyncIterator(t){const s=t.getReader();return{[Symbol.asyncIterator]:()=>({next:()=>s.read()})}}}t.exports=r},399:(t,s,e)=>{const i=e(103),a=e(361);t.exports=class{constructor(t){const{onStream:s,...e}=t;this._=new a(t),this.S=new i(e)}get icyMetaInt(){return this.S.icyMetaInt}*iterator(t){for(const s of this.S.iterator(t))s.stream?yield*this._.iterator(s.stream):yield s}readAll(t){for(const s of this.S.iterator(t))s.stream&&this._.readAll(s.stream)}async*asyncIterator(t){for await(const s of this.S.asyncIterator(t))if(s.stream)for await(const t of this._.asyncIterator(s.stream))yield t;else yield s}async asyncReadAll(t){for await(const s of this.S.iterator(t))s.stream&&await this._.asyncReadAll(s.stream)}}},103:(t,s,e)=>{const i=e(395);class a extends i{constructor({icyMetaInt:t,icyDetectionTimeout:s=2e3,...e}){super(e),this.v=t,this.C=s,this.T=this.B(),this.T.next()}*B(){if(yield*this.R())for(;;)this.$=this.v,yield*this.D(),yield*this.O(),this.$&&(yield*this.L());this.$=1/0,yield*this.D()}static parseIcyMetadata(t){const s=/(?<key>[^\0]+?)='(?<val>[^\0]*?)(;$|';|'$|$)/,e={};for(const i of t.match(new RegExp(s,"g"))||[]){const t=i.match(s);t&&(e[t.groups.key]=t.groups.val)}return e}get icyMetaInt(){return this.v}*R(){if(this.v>0)return!0;if(!this.C)return!1;this.P("Passed in Icy-MetaInt is invalid. Attempting to detect ICY Metadata.","See https://github.com/eshaz/icecast-metadata-js for information on how to properly request ICY Metadata.");const t=[null,83,116,114,101,97,109,84,105,116,108,101,61],s=Date.now();let e=0;for(;s+this.C>Date.now();){this.N=i.G(this.N,yield*this.j());t:for(;e<this.N.length-t.length;){for(let s=1;s<t.length;s++)if(this.N[s+e]!==t[s]){e++;continue t}return this.P(`Found ICY Metadata! Setting Icy-MetaInt to ${e}.`),this.v=e,!0}}return this.P("ICY Metadata not detected, but continuing anyway. Audio errors will occur if there is ICY metadata.",`Searched ${this.N.length} bytes for ${(Date.now()-s)/1e3} seconds.`,"Try increasing the `icyDetectionTimeout` value if ICY metadata is present in the stream."),this.U("icy"),!1}*D(){for(this.Y.currentStreamBytesRemaining=this.$;this.$;)yield*this.V(yield*super.k())}*O(){this.$=1;do{this.$=16*(yield*this.k())[0]}while(1===this.$);this.Y.addMetadataLengthBytes(1)}*L(){this.Y.currentMetadataBytesRemaining=this.$;const t=yield*this.k(this.$);this.Y.addMetadataBytes(t.length),yield*this.q(a.parseIcyMetadata(this.F.decode(t)))}}t.exports=a},395:(t,s,e)=>{const i=e(792).TextDecoder||TextDecoder,a=e(4),r=()=>{};class n{constructor(t){this.$=0,this.H=0,this.N=new Uint8Array(0),this.Y=new a,this.F=new i("utf-8"),this.J=t.onStream||r,this.K=t.onMetadata||r,this.U=t.onMetadataFailed||r,this.W=t.onError||r,this.X=t.enableLogging||!1,this.Z=Promise.resolve(),this.tt=Promise.resolve(),this.T=this.st(),this.T.next()}*st(){for(this.$=1/0;;)yield*this.V(yield*this.k())}static G(t,s){const e=new Uint8Array(t.length+s.length);return e.set(t),e.set(s,t.length),e}*iterator(t){for(let s=this.T.next(t);s.value;s=this.T.next())yield s.value}readAll(t){for(let s=this.T.next(t);s.value;s=this.T.next());}async*asyncIterator(t){for(let s=this.T.next(t);s.value;s=this.T.next())await this.Z,await this.tt,yield s.value}async asyncReadAll(t){for(let s=this.T.next(t);s.value;s=this.T.next())await this.Z,await this.tt}P(...t){this.X&&console.warn("icecast-metadata-js",t.reduce(((t,s)=>t+"\n  "+s),"")),this.W(...t)}*V(t){this.Y.addStreamBytes(t.length);const s={stream:t,stats:this.Y.stats};this.Z=this.J(s),yield s}*q(t){const s={metadata:t,stats:this.Y.stats};this.tt=this.K(s),yield s}*k(t=0){for(this.H===this.N.length&&(this.N=yield*this.j(),this.H=0);this.N.length-this.H<t;)this.N=n.G(this.N,yield*this.j());const s=this.N.subarray(this.H,(t||this.$)+this.H);return this.Y.addBytes(s.length),this.$=s.length<this.$?this.$-s.length:0,this.H+=s.length,s}*j(){let t;do{t=yield}while(!t||0===t.length);return this.Y.addCurrentBytesRemaining(t.length),t}}t.exports=n},361:(t,s,e)=>{const i=e(395);t.exports=class extends i{constructor(t){super(t),this.T=this.et(),this.T.next()}*et(){if(yield*this.it()){const t=yield*this.at();if(t)for(;yield*this.it();)yield*this.L(t),yield*this.D()}this.$=1/0,yield*this.D()}rt(t,s=0){return new DataView(Uint8Array.from([...t.subarray(s,s+4)]).buffer).getUint32(0,!0)}nt(t,s){return String.fromCharCode(...s).match(t)}*it(){let t=[];for(;t.length<=65307;){const s=yield*super.k(5);if(79===s[0]&&103===s[1]&&103===s[2]&&83===s[3]&&!(248&s[5])){this.H-=5,this.$+=5,this.Y.ht-=5,this.Y.ot+=5;break}t.push(s[0]),this.H-=4,this.Y.ht-=4,this.Y.ot+=4}if(t.length&&(yield*this.V(Uint8Array.from(t))),t.length>65307)return this.P("This stream is not an OGG stream. No OGG metadata will be returned.","See https://github.com/eshaz/icecast-metadata-js for information on OGG metadata."),this.U("ogg"),!1;const s=yield*this.k(27),e=yield*this.k(s[26]);return this.$=e.reduce(((t,s)=>t+s),0),!0}*at(){const t=yield*this.k(8);return yield*this.D(),this.nt(/\x7fFLAC/,t.subarray(0,5))?{regex:/^[\x84|\x04]/,length:4}:this.nt(/OpusHead/,t.subarray(0,8))?{regex:/OpusTags/,length:8}:this.nt(/\x01vorbis/,t.subarray(0,7))?{regex:/\x03vorbis/,length:7}:void 0}*L({regex:t,length:s}){this.nt(t,yield*this.k(s))&&(yield*this.q(yield*this.ct()))}*D(){for(;this.$;)yield*this.k()}*k(t){const s=yield*super.k(t);return yield*this.V(s),s}*j(){const t=yield*super.j();return this.Y.currentStreamBytesRemaining=t.length,t}*ct(){const t=this.rt(yield*this.k(4));this.Y.addMetadataBytes(4);const s=this.F.decode(yield*this.k(t));this.Y.addMetadataBytes(t);const e=this.rt(yield*this.k(4));this.Y.addMetadataBytes(4);const i=[];for(let t=0;t<e;t++){const t=yield*this.k(4);this.Y.addMetadataBytes(4),i.push(yield*this.k(this.rt(t))),this.Y.addMetadataBytes(i[i.length-1].length)}return this.Y.currentMetadataBytesRemaining=0,i.reduce(((t,s)=>{const e=s.indexOf(61),i=String.fromCharCode(...s.subarray(0,e)).toUpperCase(),a=this.F.decode(s.subarray(e+1));return t[i]=t[i]?`${t[i]}; ${a}`:a,t}),{VENDOR_STRING:s})}}},4:t=>{t.exports=class{constructor(){this.ht=0,this.dt=0,this.lt=0,this.yt=0,this.ot=0,this.ut=0,this.gt=0}get stats(){return{totalBytesRead:this.ht,streamBytesRead:this.dt,metadataLengthBytesRead:this.lt,metadataBytesRead:this.yt,currentBytesRemaining:this.ot,currentStreamBytesRemaining:this.ut,currentMetadataBytesRemaining:this.gt}}set currentStreamBytesRemaining(t){this.ut+=t}set currentMetadataBytesRemaining(t){this.gt=t}addBytes(t){this.ht+=t,this.ot-=t}addStreamBytes(t){this.dt+=t,this.ut-=t}addMetadataLengthBytes(t){this.lt+=t}addMetadataBytes(t){this.yt+=t,this.gt-=t}addCurrentBytesRemaining(t){this.ot+=t}}},792:()=>{}},s={};function e(i){var a=s[i];if(void 0!==a)return a.exports;var r=s[i]={exports:{}};return t[i](r,r.exports,e),r.exports}e.n=t=>{var s=t&&t.ft?()=>t.default:()=>t;return e.d(s,{a:s}),s},e.d=(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},e.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s);var i={};(()=>{"use strict";e.d(i,{default:()=>h});e(764),e(420);var t=e(705),s=e.n(t);const a=()=>{},r="stopped",n="running";class h{constructor(t,s={}){this.wt=t;const e=this.wt.split("/");e.pop();const i=e.join("/");this.It=s.icestatsEndpoint||`${i}/status-json.xsl`,this.Mt=s.statsEndpoint||`${i}/stats`,this.bt=s.nextsongsEndpoint||`${i}/nextsongs`,this.xt=s.sevenhtmlEndpoint||`${i}/7.html`,this.At=s.sources||["icestats","stats","nextsongs","sevenhtml","icy","ogg"],this.v=s.icyMetaInt,this.C=s.icyDetectionTimeout,this._t=1e3*(s.interval||30),this.St=s.onStats||a,this.vt=s.onStatsFetch||a,this.Ct=new AbortController,this.Tt=new AbortController,this.Bt=new AbortController,this.Rt=new AbortController,this.$t=new AbortController,this.Dt=new AbortController,this.Et=r}static xml2Json(t){const s=t=>{if(!t.children.length)return Number.isNaN(Number(t.innerHTML))?t.innerHTML:Number(t.innerHTML);const e={};for(const i of t.children)i.nodeName in e?Array.isArray(e[i.nodeName])?e[i.nodeName].push(s(i)):e[i.nodeName]=[e[i.nodeName],s(i)]:e[i.nodeName]=s(i);return e};return s((t=>(new DOMParser).parseFromString(t,"application/xml"))(t))}get state(){return this.Et}get icestatsEndpoint(){return this.It}get statsEndpoint(){return this.Mt}get nextsongsEndpoint(){return this.bt}get sevenhtmlEndpoint(){return this.xt}start(){this.Et===r&&(this.Et=n,this.getMetadata(),this.Ot=setInterval((()=>{this.getMetadata()}),this._t))}stop(){this.Et!==r&&(this.Et=r,clearInterval(this.Ot),this.Ct.abort(),this.Tt.abort(),this.Bt.abort(),this.Rt.abort(),this.Dt.abort())}async getMetadata(){if(this.Et===n){this.vt(this.At);const t=[];this.At.includes("icestats")&&t.push(this.getIcestats()),this.At.includes("sevenhtml")&&t.push(this.getSevenhtml()),this.At.includes("stats")&&t.push(this.getStats()),this.At.includes("nextsongs")&&t.push(this.getNextsongs()),this.At.includes("icy")&&t.push(this.getIcyMetadata()),this.At.includes("ogg")&&t.push(this.getOggMetadata());const s=await Promise.all(t).then((t=>t.reduce(((t,s)=>({...t,...s})),{})));return this.Et=n,this.St(s),s}}async getIcestats(){return this.Lt({endpoint:this.It,controller:this.Bt,mapper:t=>t.json()}).then((t=>({icestats:t&&t.icestats}))).finally((()=>{this.Bt=new AbortController}))}async getSevenhtml(){return this.Lt({endpoint:this.xt,controller:this.Dt,mapper:async t=>(await t.text()).match(/(.*?)<\/body>/gi).map((t=>{const s=t.match(/(<body>|,)(?<stats>.*)<\/body>/i).groups.stats.split(",");return 7===s.length?{StreamTitle:s[6],currentListeners:parseInt(s[4]),peakListeners:parseInt(s[2]),maxListeners:parseInt(s[3]),bitrate:parseInt(s[5]),status:parseInt(s[1]),serverListeners:parseInt(s[0])}:{StreamTitle:s[4],currentListeners:parseInt(s[2]),peakListeners:parseInt(s[0]),maxListeners:parseInt(s[1]),bitrate:parseInt(s[3])}}))}).then((t=>({sevenhtml:t}))).finally((()=>{this.Dt=new AbortController}))}async getStats(){return this.Lt({endpoint:this.Mt,controller:this.Rt,mapper:async t=>t.text().then((t=>h.xml2Json(t).SHOUTCASTSERVER.STREAMSTATS))}).then((t=>({stats:t}))).finally((()=>{this.Rt=new AbortController}))}async getNextsongs(){return this.Lt({endpoint:this.bt,controller:this.$t,mapper:async t=>t.text().then((t=>h.xml2Json(t).SHOUTCASTSERVER.NEXTSONGS))}).then((t=>({nextsongs:t}))).finally((()=>{this.$t=new AbortController}))}async getIcyMetadata(){return this.Pt({endpoint:this.wt,controller:this.Ct,metadataType:"icy",headers:{"Icy-MetaData":1}}).finally((()=>{this.Ct=new AbortController}))}async getOggMetadata(){return this.Pt({endpoint:this.wt,controller:this.Tt,metadataType:"ogg"}).finally((()=>{this.Tt=new AbortController}))}async Pt({endpoint:t,controller:e,headers:i,metadataType:a}){return this.Lt({endpoint:t,controller:e,headers:i,mapper:async t=>new Promise((i=>{new(s())(t,{onMetadata:({metadata:t})=>{e.abort(),i(t)},onMetadataFailed:()=>{e.abort(),i()},metadataTypes:a,icyMetaInt:this.v,icyDetectionTimeout:this.C}).startReading()}))}).then((t=>({[a]:t})))}async Lt({endpoint:t,controller:s,mapper:e,headers:i={}}){return this.Et="fetching",fetch(t,{method:"GET",headers:i,signal:s.signal}).then((t=>{if(!t.ok)throw new Error(`HTTP Error ${t.status}`);return t})).then(e).catch((s=>{"AbortError"!==s.name&&console.warn(`Failed to fetch ${t}`,s)}))}}})(),IcecastMetadataStats=i.default})();
//# sourceMappingURL=icecast-metadata-stats-0.0.1.min.js.map