/*! 
 * Copyright 2021 Ethan Halsall
 * https://github.com/eshaz/icecast-metadata-js
 *
 * This file is part of icecast-metadata-player.
 *
 * icecast-metadata-player free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * icecast-metadata-player distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
var IcecastMetadataPlayer;(()=>{var t={344:t=>{const e=()=>{};t.exports=class{constructor({icyBr:t,onMetadataUpdate:s=e,onMetadataEnqueue:i=e}){this.t=t,this.i=s,this.h=i,this.l=!0,this.u=[]}get metadataQueue(){return this.u.map((({m:t,...e})=>e))}addMetadata({metadata:t,stats:e},s,i=0){this.p(t,s,i+this.getTimeByBytes(e.currentStreamPosition))}getTimeByBytes(t){return this.t?t/(125*this.t):0}purgeMetadataQueue(){this.u.forEach((t=>clearTimeout(t.m))),this.u=[]}p(t,e,s){const i={metadata:t,timestampOffset:e,timestamp:s};this.u.push(i),this.h(t,e,s),this.l?(this.g(),this.l=!1):i.m=setTimeout((()=>{this.g()}),1e3*(e-s))}g(){const{metadata:t,timestampOffset:e,timestamp:s}=this.u.shift();this.i(t,e,s)}}},780:(t,e,s)=>{const i=s(660),n=s(690),r=s(491),a=s(555);t.exports=class{constructor({metadataTypes:t=["icy"],...e}={}){const s=t.includes("icy"),h=t.includes("ogg");this.S=s&&h?new a(e):h?new r(e):s?new n(e):new i(e)}static parseIcyMetadata(t){return n.parseIcyMetadata(t)}get icyMetaInt(){return this.S.icyMetaInt}*iterator(t){yield*this.S.iterator(t)}readAll(t){this.S.readAll(t)}async*asyncIterator(t){return yield*this.S.asyncIterator(t)}async asyncReadAll(t){return this.S.asyncReadAll(t)}}},555:(t,e,s)=>{const i=s(690),n=s(491);t.exports=class{constructor(t){const{onStream:e,...s}=t;this.v=new n(t),this.M=new i(s)}get icyMetaInt(){return this.M.icyMetaInt}*iterator(t){for(const e of this.M.iterator(t))e.stream?yield*this.v.iterator(e.stream):yield e}readAll(t){for(const e of this.M.iterator(t))e.stream&&this.v.readAll(e.stream)}async*asyncIterator(t){for await(const e of this.M.asyncIterator(t))if(e.stream)for await(const t of this.v.asyncIterator(e.stream))yield t;else yield e}async asyncReadAll(t){for await(const e of this.M.iterator(t))e.stream&&await this.v.asyncReadAll(e.stream)}}},690:(t,e,s)=>{const i=s(660);class n extends i{constructor({icyMetaInt:t,icyDetectionTimeout:e=2e3,...s}){super(s),this.I=t,this.A=e,this.B=this.C(),this.B.next()}*C(){if(yield*this.L())for(;;)this._=this.I,yield*this.T(),yield*this.D(),this._&&(yield*this.R());this._=1/0,yield*this.T()}static parseIcyMetadata(t){const e=/(?<key>[^\0]+?)='(?<val>[^\0]*?)(;$|';|'$|$)/,s={};for(const i of t.match(new RegExp(e,"g"))||[]){const t=i.match(e);t&&(s[t.groups.key]=t.groups.val)}return s}get icyMetaInt(){return this.I}*L(){if(this.I>0)return!0;if(!this.A)return!1;this.P("Passed in Icy-MetaInt is invalid. Attempting to detect ICY Metadata.","See https://github.com/eshaz/icecast-metadata-js for information on how to properly request ICY Metadata.");const t=[null,83,116,114,101,97,109,84,105,116,108,101,61],e=Date.now();let s=0;for(;e+this.A>Date.now();){this.F=i.k(this.F,yield*this.U());t:for(;s<this.F.length-t.length;){for(let e=1;e<t.length;e++)if(this.F[e+s]!==t[e]){s++;continue t}return this.P(`Found ICY Metadata! Setting Icy-MetaInt to ${s}.`),this.I=s,!0}}return this.P("ICY Metadata not detected, but continuing anyway. Audio errors will occur if there is ICY metadata.",`Searched ${this.F.length} bytes for ${(Date.now()-e)/1e3} seconds.`,"Try increasing the `icyDetectionTimeout` value if ICY metadata is present in the stream."),this.O("icy"),!1}*T(){for(this.V.currentStreamBytesRemaining=this._;this._;)yield*this.W(yield*super.H())}*D(){this._=1;do{this._=16*(yield*this.H())[0]}while(1===this._);this.V.addMetadataLengthBytes(1)}*R(){this.V.currentMetadataBytesRemaining=this._;const t=yield*this.H(this._);this.V.addMetadataBytes(t.length),yield*this.N(n.parseIcyMetadata(this.$.decode(t)))}}t.exports=n},660:(t,e,s)=>{const i=s(103).TextDecoder||TextDecoder,n=s(8),r=()=>{};class a{constructor(t){this._=0,this.q=0,this.F=new Uint8Array(0),this.V=new n,this.$=new i("utf-8"),this.j=t.onStream||r,this.G=t.onMetadata||r,this.O=t.onMetadataFailed||r,this.K=t.onError||r,this.Y=t.enableLogging||!1,this.J=Promise.resolve(),this.Z=Promise.resolve(),this.B=this.X(),this.B.next()}*X(){for(this._=1/0;;)yield*this.W(yield*this.H())}static k(t,e){const s=new Uint8Array(t.length+e.length);return s.set(t),s.set(e,t.length),s}*iterator(t){for(let e=this.B.next(t);e.value;e=this.B.next())yield e.value}readAll(t){for(let e=this.B.next(t);e.value;e=this.B.next());}async*asyncIterator(t){for(let e=this.B.next(t);e.value;e=this.B.next())await this.J,await this.Z,yield e.value}async asyncReadAll(t){for(let e=this.B.next(t);e.value;e=this.B.next())await this.J,await this.Z}P(...t){this.Y&&console.warn("icecast-metadata-js",t.reduce(((t,e)=>t+"\n  "+e),"")),this.K(...t)}*W(t){this.V.addStreamBytes(t.length);const e={stream:t,stats:this.V.stats};this.J=this.j(e),yield e}*N(t){const e={metadata:t,stats:this.V.stats};this.Z=this.G(e),yield e}*H(t=0){for(this.q===this.F.length&&(this.F=yield*this.U(),this.q=0);this.F.length-this.q<t;)this.F=a.k(this.F,yield*this.U());const e=this.F.subarray(this.q,(t||this._)+this.q);return this.V.addBytes(e.length),this._=e.length<this._?this._-e.length:0,this.q+=e.length,e}*U(){let t;do{t=yield}while(!t||0===t.length);return this.V.addCurrentBytesRemaining(t.length),t}}t.exports=a},491:(t,e,s)=>{const i=s(660);t.exports=class extends i{constructor(t){super(t),this.B=this.tt(),this.B.next()}*tt(){if(yield*this.et()){const t=yield*this.st();if(t)for(;yield*this.et();)yield*this.R(t),yield*this.T()}this._=1/0,yield*this.T()}it(t,e=0){return new DataView(Uint8Array.from([...t.subarray(e,e+4)]).buffer).getUint32(0,!0)}nt(t,e){return String.fromCharCode(...e).match(t)}*et(){let t=[];for(;t.length<=65307;){const e=yield*super.H(5);if(79===e[0]&&103===e[1]&&103===e[2]&&83===e[3]&&!(248&e[5])){this.q-=5,this._+=5,this.V.rt-=5,this.V.at+=5;break}t.push(e[0]),this.q-=4,this.V.rt-=4,this.V.at+=4}if(t.length&&(yield*this.W(Uint8Array.from(t))),t.length>65307)return this.P("This stream is not an OGG stream. No OGG metadata will be returned.","See https://github.com/eshaz/icecast-metadata-js for information on OGG metadata."),this.O("ogg"),!1;const e=yield*this.H(27),s=yield*this.H(e[26]);return this._=s.reduce(((t,e)=>t+e),0),!0}*st(){const t=yield*this.H(8);return yield*this.T(),this.nt(/\x7fFLAC/,t.subarray(0,5))?{regex:/^[\x84|\x04]/,length:4}:this.nt(/OpusHead/,t.subarray(0,8))?{regex:/OpusTags/,length:8}:this.nt(/\x01vorbis/,t.subarray(0,7))?{regex:/\x03vorbis/,length:7}:void 0}*R({regex:t,length:e}){this.nt(t,yield*this.H(e))&&(yield*this.N(yield*this.ht()))}*T(){for(;this._;)yield*this.H()}*H(t){const e=yield*super.H(t);return yield*this.W(e),e}*U(){const t=yield*super.U();return this.V.currentStreamBytesRemaining=t.length,t}*ht(){const t=this.it(yield*this.H(4));this.V.addMetadataBytes(4);const e=this.$.decode(yield*this.H(t));this.V.addMetadataBytes(t);const s=this.it(yield*this.H(4));this.V.addMetadataBytes(4);const i=[];for(let t=0;t<s;t++){const t=yield*this.H(4);this.V.addMetadataBytes(4),i.push(yield*this.H(this.it(t))),this.V.addMetadataBytes(i[i.length-1].length)}return this.V.currentMetadataBytesRemaining=0,i.reduce(((t,e)=>{const s=e.indexOf(61),i=String.fromCharCode(...e.subarray(0,s)).toUpperCase(),n=this.$.decode(e.subarray(s+1));return t[i]=t[i]?`${t[i]}; ${n}`:n,t}),{VENDOR_STRING:e})}}},8:t=>{t.exports=class{constructor(){this.rt=0,this.ot=0,this.ct=0,this.dt=0,this.at=0,this.lt=0,this.ut=0}get stats(){return{totalBytesRead:this.rt,streamBytesRead:this.ot,metadataLengthBytesRead:this.ct,metadataBytesRead:this.dt,currentBytesRemaining:this.at,currentStreamBytesRemaining:this.lt,currentMetadataBytesRemaining:this.ut}}set currentStreamBytesRemaining(t){this.lt+=t}set currentMetadataBytesRemaining(t){this.ut=t}addBytes(t){this.rt+=t,this.at-=t}addStreamBytes(t){this.ot+=t,this.lt-=t}addMetadataLengthBytes(t){this.ct+=t}addMetadataBytes(t){this.dt+=t,this.ut-=t}addCurrentBytesRemaining(t){this.at+=t}}},103:()=>{}},e={};function s(i){var n=e[i];if(void 0!==n)return n.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,s),r.exports}s.n=t=>{var e=t&&t.ft?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var i={};(()=>{"use strict";s.d(i,{default:()=>Ze});var t=s(344),e=s.n(t),n=s(780),r=s.n(n);const a=()=>{};class h{constructor(t,{icyMetaInt:e,onStream:s=a,...i}){let n;this.yt=new ReadableStream({async start(a){n=new(r())({...i,icyMetaInt:parseInt(t.headers.get("Icy-MetaInt"))||e,onStream:async t=>(a.enqueue(t.stream),s(t))});for await(const e of h.asyncIterator(t.body))await n.asyncReadAll(e);a.close()}}),this.wt=n}get icyMetaInt(){return this.wt.icyMetaInt}get readableStream(){return this.yt}async startReading(){try{for await(const t of h.asyncIterator(this.yt));}catch(t){if("AbortError"!==t.name)throw t}}static asyncIterator(t){const e=t.getReader();return{[Symbol.asyncIterator]:()=>({next:()=>e.read()})}}}const o=()=>{},c=new WeakMap,d="loading",l="playing",u="stopping",f="stopped",m="retrying",y="play",w="load",p="streamstart",g="stream",b="streamend",S="metadata",v="metadataenqueue",M="codecupdate",E="stop",I="retry",A="retrytimeout",B="warn",C="error",L=Symbol(),_=Symbol(),x=Symbol(),T=Symbol(),D=Symbol(),R=Symbol(),z=Symbol(),P=Symbol(),F=Symbol(),k=Symbol(),U=Symbol(),O=Symbol(),V=Symbol(),W=Symbol(),H=Symbol(),N=Symbol(),$=Symbol();class q{constructor(){this.gt=[]}hasEventListener(t,e){return this.gt.some((s=>s.type===t&&s.listener===e))}addEventListener(t,e,s={}){return this.hasEventListener(t,e)||this.gt.push({type:t,listener:e,options:s}),this}removeEventListener(t,e){const s=this.gt.findIndex((s=>s.type===t&&s.listener===e));return s>=0&&this.gt.splice(s,1),this}removeEventListeners(){return this.gt=[],this}dispatchEvent(t){return this.gt.filter((e=>e.type===t.type)).forEach((e=>{const{type:s,listener:i,options:{once:n}}=e;i.call(this,t),!0===n&&this.removeEventListener(s,i)})),this}}const j=(...t)=>{console.error("codec-parser",t.reduce(((t,e)=>t+"\n  "+e),""))},G=t=>{let e=new Int32Array(256);for(let s=0;s<256;s++){let i=s;for(let e=8;e>0;e--)i=t(i);e[s]=i}return e},K=G((t=>128&t?7^t<<1:t<<1)),Y=G((t=>1&t?3988292384^t>>>1:t>>>1)),Q=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15],J=t=>Q[15&t]<<4|Q[t>>4];class Z{constructor(t){this.bt=t,this.St=8*t.length}set position(t){this.St=t}get position(){return this.St}read(t){const e=Math.floor(this.St/8),s=this.St%8;this.St-=t;return(J(this.bt[e-1])<<8)+J(this.bt[e])>>7-s&255}}const X=new WeakMap,tt=new WeakMap,et=new WeakMap;class st{constructor(t){this.vt=t,this.reset()}static getKey(t){return String.fromCharCode(...t)}enable(){this.Mt=!0}reset(){this.Et=new Map,this.It=new WeakMap,this.Mt=!1}getHeader(t){const e=this.Et.get(t);return e&&t!==this.At&&(this.At=t,this.vt({...this.It.get(e)})),e}setHeader(t,e,s){this.Mt&&(t!==this.At&&(this.At=t,this.vt({...s})),this.Et.set(t,e),this.It.set(e,s))}}class it{constructor(t){this.Et=new st(t)}syncFrame(t,e=0){let s=new this.Frame(t.subarray(e),this.Et);for(;!s.header&&e+this.Bt<t.length;)e+=et.get(s).length||1,s=new this.Frame(t.subarray(e),this.Et);return{frame:s,remainingData:e}}fixedLengthFrame(t){return this.fixedLengthFrameSync(t,!1)}fixedLengthFrameSync(t,e=!0){let{frame:s,remainingData:i}=this.syncFrame(t),n=[];for(;X.get(s.header)&&et.get(s).length+i+this.Bt<t.length;){const r=new this.Frame(t.subarray(et.get(s).length+i),this.Et);if(r.header||!e){if(this.Et.enable(),n.push(s),i+=et.get(s).length,s=r,!X.get(s.header))break}else{this.Et.reset(),i++;const e=this.syncFrame(t,i);i+=e.remainingData,s=e.frame}}return{frames:n,remainingData:i}}}class nt{constructor(t,e,s){this.data=e||[],this.header=t,this.samples=s,this.duration=t&&s&&this.samples/this.header.sampleRate*1e3,this.frameNumber=void 0,this.totalBytesOut=void 0,this.totalSamples=void 0,this.totalDuration=void 0,et.set(this,{length:this.data.length})}}class rt{constructor(t,e){tt.set(this,t),X.set(this,e),this.bitDepth=t.bitDepth,this.channels=t.channels,this.sampleRate=t.sampleRate}}const at={0:["free","free","free","free","free"],16:[32,32,32,32,8],32:[64,48,40,48,16],48:[96,56,48,56,24],64:[128,64,56,64,32],80:[160,80,64,80,40],96:[192,96,80,96,48],112:[224,112,96,112,56],128:[256,128,112,128,64],144:[288,160,128,144,80],160:[320,192,160,160,96],176:[352,224,192,176,112],192:[384,256,224,192,128],208:[416,320,256,224,144],224:[448,384,320,256,160],240:["bad","bad","bad","bad","bad"]},ht={0:"bands 4 to 31",16:"bands 8 to 31",32:"bands 12 to 31",48:"bands 16 to 31"},ot={0:{description:"reserved"},2:{description:"Layer III",framePadding:1,modeExtensions:{0:"Intensity stereo off, MS stereo off",16:"Intensity stereo on, MS stereo off",32:"Intensity stereo off, MS stereo on",48:"Intensity stereo on, MS stereo on"},v1:{bitrateIndex:2,samples:1152},v2:{bitrateIndex:4,samples:576}},4:{description:"Layer II",framePadding:1,modeExtensions:ht,samples:1152,v1:{bitrateIndex:1},v2:{bitrateIndex:4}},6:{description:"Layer I",framePadding:4,modeExtensions:ht,samples:384,v1:{bitrateIndex:0},v2:{bitrateIndex:3}}},ct={0:{description:"MPEG Version 2.5 (later extension of MPEG 2)",layers:"v2",sampleRates:{0:11025,4:12e3,8:8e3,12:"reserved"}},8:{description:"reserved"},16:{description:"MPEG Version 2 (ISO/IEC 13818-3)",layers:"v2",sampleRates:{0:22050,4:24e3,8:16e3,12:"reserved"}},24:{description:"MPEG Version 1 (ISO/IEC 11172-3)",layers:"v1",sampleRates:{0:44100,4:48e3,8:32e3,12:"reserved"}}},dt={0:"16bit CRC",1:"none"},lt={0:"none",1:"50/15 ms",2:"reserved",3:"CCIT J.17"},ut={0:{channels:2,description:"Stereo"},64:{channels:2,description:"Joint stereo"},128:{channels:2,description:"Dual channel"},192:{channels:1,description:"Single channel (Mono)"}};class ft extends rt{static getHeader(t,e){const s={};if(t.length<4)return new ft(s,!1);const i=st.getKey(t.subarray(0,4)),n=e.getHeader(i);if(n)return new ft(n,!0);if(255!==t[0]||t[1]<224)return null;const r=24&t[1],a=6&t[1],h=1&t[1];s.length=4;const o=ct[r];if("reserved"===o.description)return null;if("reserved"===ot[a].description)return null;const c={...ot[a],...ot[a][o.layers]};s.mpegVersion=o.description,s.layer=c.description,s.samples=c.samples,s.protection=dt[h];const d=240&t[2],l=12&t[2],u=2&t[2],f=1&t[2];if(s.bitrate=at[d][c.bitrateIndex],"bad"===s.bitrate)return null;if(s.sampleRate=o.sampleRates[l],"reserved"===s.sampleRate)return null;if(s.framePadding=u>>1&&c.framePadding,s.isPrivate=!!f,s.frameLength=Math.floor(125*s.bitrate*s.samples/s.sampleRate+s.framePadding),!s.frameLength)return null;const m=192&t[3],y=48&t[3],w=8&t[3],p=4&t[3],g=3&t[3];if(s.channelMode=ut[m].description,s.channels=ut[m].channels,s.modeExtension=c.modeExtensions[y],s.isCopyrighted=!!(w>>3),s.isOriginal=!!(p>>2),s.emphasis=lt[g],"reserved"===s.emphasis)return null;s.bitDepth=16;const{length:b,frameLength:S,samples:v,...M}=s;return e.setHeader(i,s,M),new ft(s,!0)}constructor(t,e){super(t,e),this.bitrate=t.bitrate,this.channelMode=t.channelMode,this.emphasis=t.emphasis,this.framePadding=t.framePadding,this.isCopyrighted=t.isCopyrighted,this.isOriginal=t.isOriginal,this.isPrivate=t.isPrivate,this.layer=t.layer,this.modeExtension=t.modeExtension,this.mpegVersion=t.mpegVersion,this.protection=t.protection}}class mt extends nt{constructor(t,e){const s=ft.getHeader(t,e);super(s,s&&t.subarray(0,tt.get(s).frameLength),s&&tt.get(s).samples)}}class yt extends it{constructor(t,e){super(t),this.Frame=mt,this.Bt=4,e(this.codec)}get codec(){return"mpeg"}parseFrames(t){return this.fixedLengthFrameSync(t)}}const wt={0:"MPEG-4",8:"MPEG-2"},pt={0:"valid",2:"bad",4:"bad",6:"bad"},gt={0:"16bit CRC",1:"none"},bt={0:"AAC Main",64:"AAC LC (Low Complexity)",128:"AAC SSR (Scalable Sample Rate)",192:"AAC LTP (Long Term Prediction)"},St={0:96e3,4:88200,8:64e3,12:48e3,16:44100,20:32e3,24:24e3,28:22050,32:16e3,36:12e3,40:11025,44:8e3,48:7350,52:"reserved",56:"reserved",60:"frequency is written explicitly"},vt={0:{channels:0,description:"Defined in AOT Specific Config"},64:{channels:1,description:"front-center"},128:{channels:2,description:"front-left, front-right"},192:{channels:3,description:"front-center, front-left, front-right"},256:{channels:4,description:"front-center, front-left, front-right, back-center"},320:{channels:5,description:"front-center, front-left, front-right, back-left, back-right"},384:{channels:6,description:"front-center, front-left, front-right, back-left, back-right, LFE-channel"},448:{channels:8,description:"front-center, front-left, front-right, side-left, side-right, back-left, back-right, LFE-channel"}};class Mt extends rt{static getHeader(t,e){const s={};if(t.length<7)return new Mt(s,!1);const i=st.getKey([t[0],t[1],t[2],111111100&t[3]]),n=e.getHeader(i);if(n)Object.assign(s,n);else{if(255!==t[0]||t[1]<240)return null;const e=8&t[1],i=6&t[1],n=1&t[1];if(s.mpegVersion=wt[e],s.layer=pt[i],"bad"===s.layer)return null;s.protection=gt[n],s.length=n?7:9,s.profileBits=192&t[2],s.sampleRateBits=60&t[2];const r=2&t[2];if(s.profile=bt[s.profileBits],s.sampleRate=St[s.sampleRateBits],"reserved"===s.sampleRate)return null;s.isPrivate=!!(r>>1),s.channelModeBits=448&new DataView(Uint8Array.of(t[2],t[3]).buffer).getUint16(),s.channelMode=vt[s.channelModeBits].description,s.channels=vt[s.channelModeBits].channels;const a=32&t[3],h=8&t[3],o=8&t[3],c=4&t[3];s.isOriginal=!!(a>>5),s.isHome=!!(h>>4),s.copyrightId=!!(o>>3),s.copyrightIdStart=!!(c>>2),s.bitDepth=16}const r=262112&new DataView(Uint8Array.of(0,t[3],t[4],t[5]).buffer).getUint32();if(s.frameLength=r>>5,!s.frameLength)return null;const a=8188&new DataView(Uint8Array.of(t[5],t[6]).buffer).getUint16();if(s.bufferFullness=8188===a?"VBR":a>>2,s.numberAACFrames=3&t[6],s.samples=1024,!n){const{length:t,channelModeBits:n,profileBits:r,sampleRateBits:a,frameLength:h,bufferFullness:o,numberAACFrames:c,samples:d,...l}=s;e.setHeader(i,s,l)}return new Mt(s,!0)}constructor(t,e){super(t,e),this.copyrightId=t.copyrightId,this.copyrightIdStart=t.copyrightIdStart,this.channelMode=t.channelMode,this.bufferFullness=t.bufferFullness,this.isHome=t.isHome,this.isOriginal=t.isOriginal,this.isPrivate=t.isPrivate,this.layer=t.layer,this.length=t.length,this.mpegVersion=t.mpegVersion,this.numberAACFrames=t.numberAACFrames,this.profile=t.profile,this.protection=t.protection}get audioSpecificConfig(){const t=tt.get(this),e=t.profileBits+64<<5|t.sampleRateBits<<5|t.channelModeBits>>3,s=new Uint8Array(2);return new DataView(s.buffer).setUint16(0,e,!1),s}}class Et extends nt{constructor(t,e){const s=Mt.getHeader(t,e);super(s,s&&t.subarray(0,tt.get(s).frameLength),s&&tt.get(s).samples)}}class It extends it{constructor(t,e){super(t),this.Frame=Et,this.Bt=9,e(this.codec)}get codec(){return"aac"}parseFrames(t){return this.fixedLengthFrameSync(t)}}class At{static getHeader(t){const e={};if(t.length<28)return new At(e,!1);const s=new DataView(Uint8Array.of(...t.subarray(0,28)).buffer);if(1332176723!==s.getUint32(0))return null;e.streamStructureVersion=t[4];const i=248&t[5],n=4&t[5],r=2&t[5],a=1&t[5];if(i)return null;e.isContinuedPacket=!!(n>>2),e.isFirstPage=!!(r>>1),e.isLastPage=!!a;try{e.absoluteGranulePosition=s.getBigInt64(6,!0)}catch{}e.streamSerialNumber=s.getInt32(14,!0),e.pageSequenceNumber=s.getInt32(18,!0),e.pageChecksum=s.getInt32(22,!0);const h=t[26];if(e.length=h+27,e.length>t.length)return new At(e,!1);e.frameLength=0,e.pageSegmentTable=[],e.pageSegmentBytes=t.subarray(27,e.length);let o=0;for(const t of e.pageSegmentBytes)e.frameLength+=t,o+=t,255!==t&&(e.pageSegmentTable.push(o),o=0);return new At(e,!0)}constructor(t,e){tt.set(this,t),X.set(this,e),this.absoluteGranulePosition=t.absoluteGranulePosition,this.isContinuedPacket=t.isContinuedPacket,this.isFirstPage=t.isFirstPage,this.isLastPage=t.isLastPage,this.pageSegmentTable=t.pageSegmentTable,this.pageSequenceNumber=t.pageSequenceNumber,this.pageChecksum=t.pageChecksum,this.streamSerialNumber=t.streamSerialNumber}}class Bt extends nt{constructor(t){const e=At.getHeader(t),s=tt.get(e);if(super(e,e?t.subarray(s.length,s.length+s.frameLength):[]),X.get(e)){let i=s.length;this.segments=e.pageSegmentTable.map((e=>{const s=t.subarray(i,i+e);return i+=e,s})),this.length=s.length+s.frameLength,et.set(this,{length:this.length})}}}const Ct={0:"Fixed",1:"Variable"},Lt={0:"reserved",16:192,32:576,48:1152,64:2304,80:4608,96:"8-bit (blocksize-1) end of header",112:"16-bit (blocksize-1) end of header",128:256,144:512,160:1024,176:2048,192:4096,208:8192,224:16384,240:32768},_t={0:"invalid",1:88200,2:176400,3:192e3,4:8e3,5:16e3,6:22050,7:24e3,8:32e3,9:44100,10:48e3,11:96e3,12:"get 8 bit sample rate (in kHz) from end of header",13:"get 16 bit sample rate (in Hz) from end of header",14:"get 16 bit sample rate (in tens of Hz) from end of header",15:"invalid"},xt={0:{channels:1,description:"mono"},16:{channels:2,description:"left, right"},32:{channels:3,description:"left, right, center"},48:{channels:4,description:"front left, front right, back left, back right"},64:{channels:5,description:"front left, front right, front center, back/surround left, back/surround right"},80:{channels:6,description:"front left, front right, front center, LFE, back/surround left, back/surround right"},96:{channels:7,description:"front left, front right, front center, LFE, back center, side left, side right"},112:{channels:8,description:"front left, front right, front center, LFE, back left, back right, side left, side right"},128:{channels:2,description:"left/side stereo: channel 0 is the left channel, channel 1 is the side(difference) channel"},144:{channels:2,description:"right/side stereo: channel 0 is the side(difference) channel, channel 1 is the right channel"},160:{channels:2,description:"mid/side stereo: channel 0 is the mid(average) channel, channel 1 is the side(difference) channel"},176:"reserved",192:"reserved",208:"reserved",224:"reserved",240:"reserved"},Tt={0:"get from STREAMINFO metadata block",2:8,4:12,6:"reserved",8:16,10:20,12:24,14:"reserved"};class Dt extends rt{static decodeUTF8Int(t){if(t[0]<128)return{value:t[0],next:1};if(255===t)return null;let e,s=2,i=224;for(;(t[0]&i)!=(i<<1&255)&&s<7;)s++,i|=i>>1;if(7===s)return null;const n=6*(s-1);e=t[0]&(255^i)<<n;for(let i=1;i<s;i++)e|=(63&t[i])<<n-6*i;return{value:e,next:s}}static getHeader(t,e){const s={};if(t.length<6)return new Dt(s,!1);const i=st.getKey(t.subarray(0,4)),n=e.getHeader(i);if(n)Object.assign(s,n);else{if(255!==t[0]||248!==t[1]&&249!==t[1])return null;s.length=2,s.blockingStrategyBits=1&t[1],s.blockingStrategy=Ct[s.blockingStrategyBits],s.length++;const e=240&t[2],i=15&t[2];if(s.blockSize=Lt[e],"reserved"===s.blockSize)return null;if(s.sampleRate=_t[i],"invalid"===s.sampleRate)return null;if(s.length++,1&t[3])return null;const n=240&t[3],r=14&t[3],a=xt[n];if("reserved"===a)return null;if(s.channels=a.channels,s.channelMode=a.description,s.bitDepth=Tt[r],"reserved"===s.bitDepth)return null}if(s.length=5,t.length<s.length+8)return new Dt(s,!1);const r=Dt.decodeUTF8Int(t.subarray(4));if(!r)return null;if(s.blockingStrategyBits?s.sampleNumber=r.value:s.frameNumber=r.value,s.length+=r.next,"string"==typeof s.blockSize)if(96===blockSizeBits){if(t.length<s.length)return new Dt(s,!1);s.blockSize=t[s.length-1]-1,s.length+=1}else if(112===blockSizeBits){if(t.length<=s.length)return new Dt(s,!1);s.blockSize=(t[s.length-1]<<8)+t[s.length]-1,s.length+=2}if(s.samples=s.blockSize,"string"==typeof s.sampleRate)if(12===sampleRateBits){if(t.length<s.length)return new Dt(s,!1);s.sampleRate=t[s.length-1]-1,s.length+=1}else if(13===sampleRateBits){if(t.length<=s.length)return new Dt(s,!1);s.sampleRate=(t[s.length-1]<<8)+t[s.length]-1,s.length+=2}else if(14===sampleRateBits){if(t.length<=s.length)return new Dt(s,!1);s.sampleRate=(t[s.length-1]<<8)+t[s.length]-1,s.length+=2}if(t.length<s.length)return new Dt(s,!1);if(s.crc=t[s.length-1],s.crc!==(t=>{let e;for(const s of t)e=255&K[255&(e^s)];return e})(t.subarray(0,s.length-1)))return null;if(!n){const{blockingStrategyBits:t,frameNumber:n,sampleNumber:r,samples:a,crc:h,length:o,...c}=s;e.setHeader(i,s,c)}return s}constructor(t,e){super(t,e),this.channelMode=t.channelMode,this.blockingStrategy=t.blockingStrategy,this.blockSize=t.blockSize,this.frameNumber=t.frameNumber,this.sampleNumber=t.sampleNumber,this.streamInfo=void 0}}class Rt extends nt{constructor(t,e,s){const i=new Dt(e,!0);i&&(i.streamInfo=s),super(i,t,i&&tt.get(i).samples)}}class zt extends it{constructor(t){super(t),this.Frame=Rt}get codec(){return"flac"}parseFrames(t){return 0===t.header.pageSequenceNumber?(this.Et.enable(),this.Ct=t.data.subarray(13),{frames:[],remainingData:0}):1===t.header.pageSequenceNumber?{frames:[],remainingData:0}:{frames:t.segments.filter((t=>255===t[0])).map((t=>new Rt(t,Dt.getHeader(t,this.Et),this.Ct))),remainingData:0}}}const Pt={0:["monophonic (mono)","stereo (left, right)"],1:["monophonic (mono)","stereo (left, right)","linear surround (left, center, right)","quadraphonic (front left, front right, rear left, rear right)","5.0 surround (front left, front center, front right, rear left, rear right)","5.1 surround (front left, front center, front right, rear left, rear right, LFE)","6.1 surround (front left, front center, front right, side left, side right, rear center, LFE)","7.1 surround (front left, front center, front right, side left, side right, rear left, rear right, LFE)"]};class Ft extends rt{static getHeader(t,e){const s={};if(t.length<19)return new Ft(s,!1);const i=st.getKey(t.subarray(0,19)),n=e.getHeader(i);if(n)Object.assign(s,n);else{if(79!==t[0]||112!==t[1]||117!==t[2]||115!==t[3]||72!==t[4]||101!==t[5]||97!==t[6]||100!==t[7])return null;if(1!==t[8])return null;const e=new DataView(Uint8Array.of(...t.subarray(0,19)).buffer);if(s.bitDepth=16,s.length=19,s.channels=t[9],s.preSkip=e.getUint16(10,!0),s.inputSampleRate=e.getUint32(12,!0),s.sampleRate=48e3,s.outputGain=e.getInt16(16,!0),s.channelMappingFamily=t[18],!s.channelMappingFamily in Pt)return null;if(s.channelMode=Pt[s.channelMappingFamily][s.channels-1],!s.channelMode)return null}if(0!==s.channelMappingFamily){if(s.length+=2+s.channels,t.length<s.length)return new Ft(s,!1);s.streamCount=t[19],s.coupledStreamCount=t[20],s.channelMappingTable=t.subarray(21,s.channels+21)}if(s.data=Uint8Array.of(...t.subarray(0,s.length)),!n){const{length:t,data:n,channelMappingFamily:r,...a}=s;e.setHeader(i,s,a)}return new Ft(s,!0)}constructor(t,e){super(t,e),this.data=t.data,this.channelMappingFamily=t.channelMappingFamily,this.channelMode=t.channelMode,this.coupledStreamCount=t.coupledStreamCount,this.preSkip=t.preSkip,this.outputGain=t.outputGain,this.inputSampleRate=t.inputSampleRate,this.streamCount=t.streamCount,this.channelMappingTable=t.channelMappingTable}}const kt={0:{mode:"SILK-only",bandwidth:"NB",frameSize:10},8:{mode:"SILK-only",bandwidth:"NB",frameSize:20},16:{mode:"SILK-only",bandwidth:"NB",frameSize:40},24:{mode:"SILK-only",bandwidth:"NB",frameSize:60},32:{mode:"SILK-only",bandwidth:"MB",frameSize:10},40:{mode:"SILK-only",bandwidth:"MB",frameSize:20},48:{mode:"SILK-only",bandwidth:"MB",frameSize:40},56:{mode:"SILK-only",bandwidth:"MB",frameSize:60},64:{mode:"SILK-only",bandwidth:"WB",frameSize:10},72:{mode:"SILK-only",bandwidth:"WB",frameSize:20},80:{mode:"SILK-only",bandwidth:"WB",frameSize:40},88:{mode:"SILK-only",bandwidth:"WB",frameSize:60},96:{mode:"Hybrid",bandwidth:"SWB",frameSize:10},104:{mode:"Hybrid",bandwidth:"SWB",frameSize:20},112:{mode:"Hybrid",bandwidth:"FB",frameSize:10},120:{mode:"Hybrid",bandwidth:"FB",frameSize:20},128:{mode:"CELT-only",bandwidth:"NB",frameSize:2.5},136:{mode:"CELT-only",bandwidth:"NB",frameSize:5},144:{mode:"CELT-only",bandwidth:"NB",frameSize:10},152:{mode:"CELT-only",bandwidth:"NB",frameSize:20},160:{mode:"CELT-only",bandwidth:"WB",frameSize:2.5},168:{mode:"CELT-only",bandwidth:"WB",frameSize:5},176:{mode:"CELT-only",bandwidth:"WB",frameSize:10},184:{mode:"CELT-only",bandwidth:"WB",frameSize:20},192:{mode:"CELT-only",bandwidth:"SWB",frameSize:2.5},200:{mode:"CELT-only",bandwidth:"SWB",frameSize:5},208:{mode:"CELT-only",bandwidth:"SWB",frameSize:10},216:{mode:"CELT-only",bandwidth:"SWB",frameSize:20},224:{mode:"CELT-only",bandwidth:"FB",frameSize:2.5},232:{mode:"CELT-only",bandwidth:"FB",frameSize:5},240:{mode:"CELT-only",bandwidth:"FB",frameSize:10},248:{mode:"CELT-only",bandwidth:"FB",frameSize:20}};class Ut extends nt{static getPacket(t){const e={config:kt[248&t[0]],channels:4&t[0]?2:1,code:3&t[0]};switch(e.code){case 0:return e.frameCount=1,e;case 1:case 2:return e.frameCount=2,e;case 3:return e.isVbr=Boolean(128&t[1]),e.hasOpusPadding=Boolean(64&t[1]),e.frameCount=63&t[1],e}}constructor(t,e){let s=new Ft(e,!0);const i=Ut.getPacket(t);super(s,t,s&&i.config.frameSize*i.frameCount/1e3*s.sampleRate)}}class Ot extends it{constructor(t,e){super(t),this.Frame=Ut,this.Lt=null,this.Bt=26}get codec(){return"opus"}parseFrames(t){return 0===t.header.pageSequenceNumber?(this.Et.enable(),this.Lt=Ft.getHeader(t.data,this.Et),{frames:[],remainingData:0}):1===t.header.pageSequenceNumber?{frames:[],remainingData:0}:{frames:t.segments.map((t=>new Ut(t,this.Lt))),remainingData:0}}}class Vt extends nt{constructor(t,e,s){super(e,t,s)}}const Wt={6:64,7:128,8:256,9:512,10:1024,11:2048,12:4096,13:8192};class Ht extends rt{static getHeader(t,e){const s={length:30};if(t.length<30)return new Ht(s,!1);const i=st.getKey(t.subarray(0,30)),n=e.getHeader(i);if(n)return new Ht(n,!0);if(1!==t[0]||118!==t[1]||111!==t[2]||114!==t[3]||98!==t[4]||105!==t[5]||115!==t[6])return null;s.data=Uint8Array.of(...t.subarray(0,30));const r=new DataView(s.data.buffer);if(s.version=r.getUint32(7,!0),0!==s.version)return null;if(s.channels=t[11],s.sampleRate=r.getUint32(12,!0),s.bitrateMaximum=r.getInt32(16,!0),s.bitrateNominal=r.getInt32(20,!0),s.bitrateMinimum=r.getInt32(24,!0),s.blocksize1=Wt[(240&t[28])>>4],s.blocksize0=Wt[15&t[28]],t[!0])return null;s.bitDepth=32;{const{length:t,data:n,version:r,...a}=s;e.setHeader(i,s,a)}return new Ht(s,!0)}constructor(t,e){super(t,e),this.bitrateMaximum=t.bitrateMaximum,this.bitrateMinimum=t.bitrateMinimum,this.bitrateNominal=t.bitrateNominal,this.blocksize0=t.blocksize0,this.blocksize1=t.blocksize1,this.data=t.data,this.vorbisComments=void 0,this.vorbisSetup=void 0}}class Nt extends it{constructor(t){super(t),this.Frame=Vt,this.Bt=29,this.Lt=null,this._t={count:0},this.xt=0,this.Tt=0}get codec(){return"vorbis"}parseFrames(t){return 0===t.header.pageSequenceNumber?(this.Et.enable(),this.Lt=Ht.getHeader(t.data,this.Et),{frames:[],remainingData:0}):1===t.header.pageSequenceNumber?(this.Lt.vorbisComments=t.segments[0],this.Lt.vorbisSetup=t.segments[1],this._t=this.Dt(t.segments[1]),{frames:[],remainingData:0}):{frames:t.segments.map((t=>new Vt(t,this.Lt,this.Rt(t)))),remainingData:0}}Rt(t){const e=t[0]>>1,s=this._t[e&this._t.mask];s&&(this.xt=e&this._t.prevMask?this.Lt.blocksize1:this.Lt.blocksize0),this.Tt=s?this.Lt.blocksize1:this.Lt.blocksize0;const i=this.xt+this.Tt>>2;return this.xt=this.Tt,i}Dt(t){const e=new Z(t);let s,i={count:0};for(;1!=(1&e.read(1)););for(;i.count<64&&e.position>0;){const t=J(e.read(8));if(t in i&&(1!==i.count||0!==t))throw j("received duplicate mode mapping, failed to parse vorbis modes"),new Error("Failed to read Vorbis stream");let n=0;for(;0===e.read(8)&&n++<3;);if(4!==n){if(1+((126&J(s))>>1)!==i.count)throw j("mode count did not match actual modes, failed to parse vorbis modes"),new Error("Failed to read Vorbis stream");break}s=e.read(7),i[t]=1&s,e.position+=6,i.count++}return i.mask=(1<<Math.log2(i.count))-1,i.prevMask=1+(1|i.mask),i}}class $t extends it{constructor(t,e){super(),this.vt=t,this.zt=e,this.Frame=Bt,this.Bt=283,this.Pt=null}get codec(){return this.Pt||""}Ft(t,e){this.Pt!==t&&(this.kt=new e(this.vt),this.Pt=t,this.zt(t))}checkForIdentifier({data:t}){const e=String.fromCharCode(...t.subarray(0,8));switch(e){case"fishead\0":case"fisbone\0":return!1;case"OpusHead":return this.Ft("opus",Ot),!0;case/^\x7fFLAC/.test(e)&&e:return this.Ft("flac",zt),!0;case/^\x01vorbis/.test(e)&&e:return this.Ft("vorbis",Nt),!0;default:return!0}}parseFrames(t){const e=this.fixedLengthFrame(t);return{frames:e.frames.filter((t=>this.checkForIdentifier(t)&&this.Pt)).flatMap((t=>this.kt.parseFrames(t).frames)),remainingData:e.remainingData}}}const qt=()=>{};const jt=class{constructor(t,{onCodecUpdate:e,onCodec:s}={}){if(this.Ut=t,this.vt=e||qt,this.zt=s||qt,this.Ut.match(/aac/))this.Ot=new It(this.vt,this.zt);else if(this.Ut.match(/mpeg/))this.Ot=new yt(this.vt,this.zt);else{if(!this.Ut.match(/ogg/))throw new Error(`Unsupported Codec ${t}`);this.Ot=new $t(this.vt,this.zt)}this.Vt=0,this.Wt=0,this.Ht=0,this.Nt=[],this.$t=new Uint8Array(0),this.B=this.B(),this.B.next()}get codec(){return this.Ot.codec}*iterator(t){for(let e=this.B.next(t);e.value;e=this.B.next())yield e.value}*B(){let t=[];for(;;)yield*this.qt(t),t=this.jt()}*qt(t){for(const e of t)yield e;let e;do{e=yield}while(!e);this.$t=((...t)=>{const e=new Uint8Array(t.reduce(((t,e)=>t+e.length),0));return t.reduce(((t,s)=>(e.set(s,t),t+s.length)),0),e})(this.$t,e)}jt(){const{frames:t,remainingData:e}=this.Ot.parseFrames(this.$t);return this.$t=this.$t.subarray(e),t.map((t=>(t.frameNumber=this.Vt++,t.totalBytesOut=this.Wt,t.totalSamples=this.Ht,t.totalDuration=this.Ht/t.header.sampleRate*1e3,t.crc32=(t=>{let e;for(const s of t)e=Y[255&(e^s)]^e>>>8;return-1^e})(t.data),this.Wt+=t.data.length,this.Ht+=t.samples,t)))}};class Gt{constructor({name:t,contents:e=[],children:s=[]}){this.Gt=t,this.Kt=e,this.Yt=s}static stringToByteArray(t){return[...t].map((t=>t.charCodeAt(0)))}static getFloat64(t){const e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,t),e}static getUint64(t){const e=new Uint8Array(8);return new DataView(e.buffer).setBigUint64(0,BigInt(t)),e}static getUint32(t){const e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t),e}static getUint16(t){const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t),e}static getInt16(t){const e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,t),e}static*flatten(t){for(const e of t)Array.isArray(e)?yield*Gt.flatten(e):yield e}get contents(){const t=new Uint8Array(this.length),e=this.Qt();let s=0;for(const i of Gt.flatten(e))"object"!=typeof i?(t[s]=i,s++):(t.set(i,s),s+=i.length);return t}get length(){return this.Jt()}Qt(){return[this.Kt,...this.Yt.map((t=>t.Qt()))]}Jt(){let t;return t=Array.isArray(this.Kt)?this.Kt.reduce(((t,e)=>t+(void 0===e.length?1:e.length)),0):void 0===this.Kt.length?1:this.Kt.length,t+this.Yt.reduce(((t,e)=>t+e.length),0)}addChild(t){this.Yt.push(t)}}class Kt extends Gt{constructor(t,{contents:e,children:s}={}){super({name:t,contents:e,children:s})}Qt(){return[...this.Zt,...Gt.stringToByteArray(this.Gt),...super.Qt()]}Jt(){return this.Xt||(this.Xt=4+this.Gt.length+super.Jt(),this.Zt=Gt.getUint32(this.Xt)),this.Xt}}class Yt extends Gt{constructor(t,{contents:e,tags:s}={}){super({name:t,contents:e,children:s})}static getLength(t){const e=Gt.getUint32(t);return e.every(((t,e,s)=>0===t&&(s[e]=128,!0))),e}Qt(){return[this.Gt,...this.Zt,...super.Qt()]}Jt(){if(!this.Xt){const t=super.Jt();this.Zt=Yt.getLength(t),this.Xt=1+t+this.Zt.length}return this.Xt}addTag(t){this.addChild(t)}}class Qt{constructor(t){this.Pt=t}getCodecBox(t){switch(this.Pt){case"mp3":return this.getMp4a(t,107);case"mp4a.40.2":return this.getMp4a(t,64);case"opus":return this.getOpus(t);case"flac":return this.getFlaC(t)}}getOpus(t){return new Kt("Opus",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,t.bitDepth,0,0,0,0,Kt.getUint16(t.sampleRate),0,0],children:[new Kt("dOps",{contents:[0,t.channels,Kt.getUint16(t.preSkip),Kt.getUint32(t.inputSampleRate),Kt.getInt16(t.outputGain),t.channelMappingFamily,0!==t.channelMappingFamily?[t.streamCount,t.coupledStreamCount,t.channelMappingTable]:[]]})]})}getFlaC(t){return new Kt("fLaC",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,t.bitDepth,0,0,0,0,Kt.getUint16(t.sampleRate),0,0],children:[new Kt("dfLa",{contents:[0,0,0,0,...t.streamInfo||[128,0,0,34,Kt.getUint16(t.blockSize),Kt.getUint16(t.blockSize),0,0,0,0,0,0,Kt.getUint32(t.sampleRate<<12|t.channels<<8|t.bitDepth-1<<4),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]})]})}getMp4a(t,e){const s=new Yt(4,{contents:[e,21,0,0,0,0,0,0,0,0,0,0,0]});return 64===e&&s.addTag(new Yt(5,{contents:t.audioSpecificConfig})),new Kt("mp4a",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,16,0,0,0,0,Kt.getUint16(t.sampleRate),0,0],children:[new Kt("esds",{contents:[0,0,0,0],children:[new Yt(3,{contents:[0,1,0],tags:[s,new Yt(6,{contents:2})]})]})]})}getInitializationSegment({header:t,samples:e}){return new Gt({children:[new Kt("ftyp",{contents:[Kt.stringToByteArray("iso5"),0,0,2,0,Kt.stringToByteArray("iso6mp41")]}),new Kt("moov",{children:[new Kt("mvhd",{contents:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,232,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]}),new Kt("trak",{children:[new Kt("tkhd",{contents:[0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0]}),new Kt("mdia",{children:[new Kt("mdhd",{contents:[0,0,0,0,0,0,0,0,0,0,0,0,Kt.getUint32(t.sampleRate),0,0,0,0,85,196,0,0]}),new Kt("hdlr",{contents:[0,0,0,0,Kt.stringToByteArray("mhlr"),Kt.stringToByteArray("soun"),0,0,0,0,0,0,0,0,0,0,0,0,0]}),new Kt("minf",{children:[new Kt("stbl",{children:[new Kt("stsd",{contents:[0,0,0,0,0,0,0,1],children:[this.getCodecBox(t)]}),new Kt("stts",{contents:[0,0,0,0,0,0,0,0]}),new Kt("stsc",{contents:[0,0,0,0,0,0,0,0]}),new Kt("stsz",{contents:[0,0,0,0,0,0,0,0,0,0,0,0]}),new Kt("stco",{contents:[0,0,0,0,0,0,0,0]})]})]})]})]}),new Kt("mvex",{children:[new Kt("trex",{contents:[0,0,0,0,0,0,0,1,0,0,0,1,Kt.getUint32(e),0,0,0,0,0,0,0,0]})]})]})]}).contents}getSamplesPerFrame(t){return"mp4a.40.2"===this.Pt?t.map((({data:t,header:e})=>Kt.getUint32(t.length-e.length))):t.map((({data:t})=>Kt.getUint32(t.length)))}getFrameData(t){return"mp4a.40.2"===this.Pt?t.map((({data:t,header:e})=>t.subarray(e.length))):t.map((({data:t})=>t))}getMediaSegment(t){return new Gt({children:[new Kt("moof",{children:[new Kt("mfhd",{contents:[0,0,0,0,0,0,0,0]}),new Kt("traf",{children:[new Kt("tfhd",{contents:[0,2,0,0,0,0,0,1]}),new Kt("tfdt",{contents:[0,0,0,0,0,0,0,0]}),new Kt("trun",{contents:[0,0,2,1,Kt.getUint32(t.length),Kt.getUint32(92+4*t.length),...this.getSamplesPerFrame(t)]})]})]}),new Kt("mdat",{contents:this.getFrameData(t)})]}).contents}}const Jt=(...t)=>t.flatMap((t=>{const e=[];for(let s=t.length;s>=0;s-=255)e.push(s>=255?255:s);return e}));class Zt extends Gt{constructor(t,{contents:e,children:s,isUnknownLength:i=!1}={}){super({name:t,contents:e,children:s}),this.te=i}static getUintVariable(t){let e;if(t<127)e=[128|t];else if(t<16383)e=Gt.getUint16(t),e[0]|=64;else if(t<2097151)e=Gt.getUint32(t).subarray(1),e[0]|=32;else if(t<268435455)e=Gt.getUint32(t),e[0]|=16;else if(t<34359738367)e=Gt.getUint64(t).subarray(3),e[0]|=8;else if(t<4398046511103)e=Gt.getUint64(t).subarray(2),e[0]|=4;else if(t<562949953421311)e=Gt.getUint64(t).subarray(1),e[0]|=2;else if(t<72057594037927940)e=Gt.getUint64(t),e[0]|=1;else if("number"!=typeof t||isNaN(t))throw((...t)=>{console.error("mse-audio-wrapper",t.reduce(((t,e)=>t+"\n  "+e),""))})(`EBML Variable integer must be a number, instead received ${t}`),new Error("mse-audio-wrapper: Unable to encode WEBM");return e}Qt(){return[...this.Gt,...this.Zt,...super.Qt()]}Jt(){return this.Xt||(this.ee=super.Jt(),this.Zt=this.te?[1,255,255,255,255,255,255,255]:Zt.getUintVariable(this.ee),this.Xt=this.Gt.length+this.Zt.length+this.ee),this.Xt}}const Xt=[225],te=[98,100],ee=[159],se=[31,67,182,117],ie=[86,170],ne=[134],re=[99,162],ae=[66,130],he=[66,133],oe=[66,135],ce=[26,69,223,163],de=[66,242],le=[66,243],ue=[66,247],fe=[66,134],me=[156],ye=[21,73,169,102],we=[77,128],pe=[181],ge=[86,187],be=[24,83,128,103],Se=[163],ve=[231],Me=[42,215,177],Ee=[174],Ie=[215],Ae=[22,84,174,107],Be=[131],Ce=[115,197],Le=[87,65];class _e{constructor(t){switch(t){case"opus":this.se="A_OPUS",this.ie=t=>[new Zt(ie,{contents:Zt.getUint32(Math.round(t.preSkip*this.ne))}),new Zt(ge,{contents:Zt.getUint32(Math.round(3840*this.ne))}),new Zt(re,{contents:t.data})];break;case"vorbis":this.se="A_VORBIS",this.ie=t=>[new Zt(re,{contents:[2,Jt(t.data,t.vorbisComments),t.data,t.vorbisComments,t.vorbisSetup]})]}}getInitializationSegment({header:t}){return this.ne=1e9/t.sampleRate,new Gt({children:[new Zt(ce,{children:[new Zt(fe,{contents:1}),new Zt(ue,{contents:1}),new Zt(de,{contents:4}),new Zt(le,{contents:8}),new Zt(ae,{contents:Zt.stringToByteArray("webm")}),new Zt(oe,{contents:4}),new Zt(he,{contents:2})]}),new Zt(be,{isUnknownLength:!0,children:[new Zt(ye,{children:[new Zt(Me,{contents:Zt.getUint32(Math.floor(this.ne))}),new Zt(we,{contents:Zt.stringToByteArray("mse-audio-wrapper")}),new Zt(Le,{contents:Zt.stringToByteArray("mse-audio-wrapper")})]}),new Zt(Ae,{children:[new Zt(Ee,{children:[new Zt(Ie,{contents:1}),new Zt(Ce,{contents:1}),new Zt(me,{contents:0}),new Zt(ne,{contents:Zt.stringToByteArray(this.se)}),new Zt(Be,{contents:2}),new Zt(Xt,{children:[new Zt(ee,{contents:t.channels}),new Zt(pe,{contents:Zt.getFloat64(t.sampleRate)}),new Zt(te,{contents:t.bitDepth})]}),...this.ie(t)]})]})]})]}).contents}getMediaSegment(t){const e=t[0].totalSamples;return new Zt(se,{children:[new Zt(ve,{contents:Zt.getUintVariable(e)}),...t.map((({data:t,totalSamples:s})=>new Zt(Se,{contents:[129,Zt.getInt16(s-e),128,t]})))]}).contents}}const xe=()=>{};const Te=class{constructor(t,e={}){this.Ut=t,this.PREFERRED_CONTAINER=e.preferredContainer||"webm",this.MIN_FRAMES=e.minFramesPerSegment||4,this.MAX_FRAMES=e.maxFramesPerSegment||50,this.MIN_FRAMES_LENGTH=e.minBytesPerSegment||1022,this.MAX_SAMPLES_PER_SEGMENT=1/0,this.re=e.onMimeType||xe,e.codec&&(this.ae=this.he(e.codec),this.re(this.oe)),this.Nt=[],this.Ot=new jt(t,{onCodec:t=>{this.ae=this.he(t),this.re(this.oe)},onCodecUpdate:e.onCodecUpdate})}get mimeType(){return this.oe}get inputMimeType(){return this.Ut}*iterator(t){t.constructor===Uint8Array?yield*this.ce([...this.Ot.iterator(t)]):Array.isArray(t)&&(yield*this.ce(t))}*ce(t){if(this.Nt.push(...t),this.Nt.length){const t=this.de();if(t.length){this.le||(this.le=!0,yield this.ae.getInitializationSegment(t[0][0]));for(const e of t)yield this.ae.getMediaSegment(e)}}}de(){const t=[[]];let e=t[0],s=0;for(const i of this.Nt)(e.length===this.MAX_FRAMES||s>=this.MAX_SAMPLES_PER_SEGMENT)&&(s=0,t.push(e=[])),e.push(i),s+=i.samples;return this.Nt=e.length<this.MIN_FRAMES||e.reduce(((t,e)=>t+e.data.length),0)<this.MIN_FRAMES_LENGTH?t.pop():[],t}he(t){switch(t){case"mpeg":return this.oe='audio/mp4;codecs="mp3"',new Qt("mp3");case"aac":return this.oe='audio/mp4;codecs="mp4a.40.2"',new Qt("mp4a.40.2");case"flac":return this.oe='audio/mp4;codecs="flac"',new Qt("flac");case"vorbis":return this.oe='audio/webm;codecs="vorbis"',this.MAX_SAMPLES_PER_SEGMENT=32767,new _e("vorbis");case"opus":return"webm"===this.PREFERRED_CONTAINER?(this.oe='audio/webm;codecs="opus"',this.MAX_SAMPLES_PER_SEGMENT=32767,new _e("opus")):(this.oe='audio/mp4;codecs="opus"',new Qt("opus"))}}};class De{constructor(t){const e=c.get(t);this.wt=t,this.ue=e[x],this.fe=e[L],this.me=e[_],this.I=e[T],this.A=e[D],this.ye=e[H],this.we=e[N]}get icyMetaInt(){return this.pe&&this.pe.icyMetaInt}async play(){return this.fetchStream().then((async t=>(this.wt[U](p),this.playResponse(t).finally((()=>{this.wt[U](b)})))))}async fetchStream(){const t=await fetch(this.fe,{method:"GET",headers:this.ye?{"Icy-MetaData":1}:{},signal:c.get(this.wt)[$].signal});if(!t.ok){const e=new Error(`${t.status} received from ${t.url}`);throw e.name="HTTP Response Error",e}return t}async playResponse(t){this.pe=new h(t,{onMetadata:this.getOnMetadata(),onStream:this.getOnStream(t),onError:(...t)=>this.wt[U](B,...t),metadataTypes:this.me,icyMetaInt:this.I,icyDetectionTimeout:this.A}),await this.pe.startReading()}getOnMetadata(){return t=>{this.we.addMetadata(t,this.metadataTimestamp,this.ue.currentTime)}}}class Re{constructor(t){this.CACHE_DURATION=6e4,this.wt=t,this.initSync(),this.initQueue()}initSync(){this.ge=[],this.be=0,this.Se=0}initQueue(){this.ve=[],this.Me=0}push({crc32:t,duration:e}){if(this.ve.push({crc32:t,duration:e}),this.Me+=e,this.Me>=this.CACHE_DURATION){const{duration:t}=this.ve.shift();this.Me-=t}}sync(t){this.ge.push(...t);t:for(;this.be<this.ve.length;){for(;this.Se<this.ge.length&&this.be+this.Se<this.ve.length;){if(this.ge[this.Se].crc32!==this.ve[this.be+this.Se].crc32){this.Se=0,this.be++;continue t}this.Se++}break}if(this.be===this.ve.length){this.wt[U](B,"Reconnected successfully after retry event.","Found no overlapping frames from previous request.","Unable to sync old and new request.");const t=this.ge;return this.initSync(),this.initQueue(),t}const e=this.ve.length-this.be;if(this.ge.length>e){this.wt[U](B,"Reconnected successfully after retry event.",`Found ${e} frames (${(this.ve.slice(this.be).reduce(((t,{duration:e})=>t+e),0)/1e3).toFixed(3)} seconds) of overlapping audio data in new request.`,"Synchronized old and new request.");const t=this.ge.slice(e);return this.initSync(),t}return[]}}const ze=Symbol(),Pe=Symbol(),Fe=Symbol();class ke extends De{constructor(t){super(t),this.reset(),this.wt.addEventListener(I,(()=>{this.Ee=ze}))}static isSupported(){try{new MediaSource}catch{return!1}return!0}static canPlayType(t){const e={mpeg:['audio/mp4;codecs="mp3"'],aac:['audio/mp4;codecs="mp4a.40.2"'],aacp:['audio/mp4;codecs="mp4a.40.2"'],ogg:{flac:['audio/mp4;codecs="flac"'],opus:['audio/mp4;codecs="opus"','audio/webm;codecs="opus"'],vorbis:['audio/webm;codecs="vorbis"']}};if(!ke.isSupported())return"";if(MediaSource.isTypeSupported(t))return"probably";const s=t.match(/^(?:application\/|audio\/|)(?<mime>[a-zA-Z]+)(?:$|;[ ]*codecs=(?:\'|\")(?<codecs>[a-zA-Z,]+)(?:\'|\"))/);if(s){const{mime:t,codecs:i}=s.groups;if(e[t])return(Array.isArray(e[t])?e[t]:i?i.split(",").flatMap((s=>e[t][s])):Object.values(e[t]).flat()).reduce(((t,e)=>MediaSource.isTypeSupported(e)?""===t?"maybe":"probably":t?"maybe":""),null)}return""}async reset(){this.Ee=Fe,this.Ie=new Re(this.wt),await this.Ae()}get metadataTimestamp(){return this.Be&&this.Be.sourceBuffers.length&&Math.max(this.Be.sourceBuffers[0].timestampOffset,this.Be.sourceBuffers[0].buffered.length?this.Be.sourceBuffers[0].buffered.end(0):0)||0}getOnStream(t){const e=t.headers.get("content-type"),s=this.Ce(e);return async({stream:t})=>{let e=[...this.Ot.iterator(t)];if(e.length){switch(this.Ee){case ze:this.Ie.initSync(),this.Ee=Pe;case Pe:e=this.Ie.sync(e),e.length&&(this.Ee=Fe)}e.map((t=>this.Ie.push(t))),await(await s)(e)}}}async Ce(t){const e=new Promise((e=>{this.Ot=new jt(t,{onCodecUpdate:(...t)=>this.wt[U](M,...t),onCodec:e})}));if(MediaSource.isTypeSupported(t))return await this.Le(t),async t=>{for await(const{data:e}of t)await this._e(e)};{const s=new Te(t,{codec:await e});if(!MediaSource.isTypeSupported(s.mimeType)){this.wt[U](C,`Media Source Extensions API in your browser does not support ${t} or ${s.mimeType}`,"See: https://caniuse.com/mediasource and https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API");const e=new Error(`Unsupported Media Source Codec ${s.mimeType}`);throw e.name="CodecError",e}return await this.Le(s.mimeType),async t=>{for await(const e of s.iterator(t))await this._e(e)}}}async Le(t){await this.xe,this.Be.sourceBuffers.length||(this.Te=0,this.Be.addSourceBuffer(t).mode="sequence")}async Ae(){return this.xe=new Promise((t=>{this.Be=new MediaSource,this.ue.src=URL.createObjectURL(this.Be),this.Be.addEventListener("sourceopen",t,{once:!0})})),this.xe}async De(){return new Promise((t=>{this.Be.sourceBuffers[0].addEventListener("updateend",t,{once:!0})}))}async _e(t){this.wt[U](g,t),this.Be.sourceBuffers.length||this.wt[U](B,"Attempting to append audio, but MediaSource has not been or is no longer initialized","Please be sure that `detachAudioElement()` was called and awaited before reusing the element with a new IcecastMetadataPlayer instance"),this.wt.state!==u&&this.Be.sourceBuffers.length&&(this.Be.sourceBuffers[0].appendBuffer(t),await this.De(),this.ue.currentTime>10&&this.Te+1e4<Date.now()&&(this.Te=Date.now(),this.Be.sourceBuffers[0].remove(0,this.ue.currentTime-10),await this.De()))}}class Ue extends De{constructor(t){super(t),this.Re=null,this.ze=0,this.Pe=0,this.ue.crossOrigin="anonymous",this.ue.preload="none",this.ue.src=this.fe}static canPlayType(t){return(new Audio).canPlayType(t)}async reset(){this.wt.state!==l&&(this.Re=null,this.ze=0,this.Pe=0,this.ue.removeAttribute("src"),this.ue.load(),this.ue.src=this.fe)}async play(){const t=new Promise(((t,e)=>{this.wt.addEventListener(u,t,{once:!0}),this.ue.addEventListener("playing",t,{once:!0}),this.ue.addEventListener("error",e,{once:!0})}));return this.ue.src=this.fe,this.ue.load(),this.me.length?t.then((async()=>{const t=performance.now(),e=await super.play();return this.Pe=performance.now()-t,e})):new Promise(((t,e)=>{const s=()=>e(new DOMException("Aborted","AbortError")),i=c.get(this.wt)[$];i.aborted?s():i.signal.addEventListener("abort",s,{once:!0})}))}get metadataTimestamp(){return this.Re?(this.Re.totalDuration+this.Pe)/1e3:0}getOnStream(t){return this.Ot=new jt(t.headers.get("content-type"),{onCodecUpdate:(...t)=>this.wt[U](M,...t)}),({stream:t})=>{this.wt[U](g,t);for(const e of this.Ot.iterator(t))this.Re=e}}}let Oe;try{new EventTarget,Oe=EventTarget}catch{Oe=q}const Ve=Symbol(),We=Symbol(),He=Symbol(),Ne=Symbol(),$e=Symbol(),qe=Symbol(),je=Symbol(),Ge=Symbol(),Ke=Symbol(),Ye=Symbol(),Qe=Symbol(),Je=Symbol();class Ze extends Oe{constructor(t,s={}){super(),c.set(this,{[L]:t,[x]:s.audioElement||new Audio,[T]:s.icyMetaInt,[D]:s.icyDetectionTimeout,[_]:s.metadataTypes||["icy"],[H]:(s.metadataTypes||["icy"]).includes("icy"),[R]:s.enableLogging||!1,[z]:(s.retryDelayRate||.1)+1,[P]:1e3*(s.retryDelayMin||.5),[F]:1e3*(s.retryDelayMax||2),[k]:1e3*(s.retryTimeout||30),[He]:{[y]:s.onPlay||o,[w]:s.onLoad||o,[p]:s.onStreamStart||o,[g]:s.onStream||o,[b]:s.onStreamEnd||o,[S]:s.onMetadata||o,[v]:s.onMetadataEnqueue||o,[M]:s.onCodecUpdate||o,[E]:s.onStop||o,[I]:s.onRetry||o,[A]:s.onRetryTimeout||o,[B]:(...t)=>{c.get(this)[R]&&console.warn("icecast-metadata-js",t.reduce(((t,e)=>t+"\n  "+e),"")),s.onWarn&&s.onWarn(...t)},[C]:(...t)=>{c.get(this)[R]&&console.error("icecast-metadata-js",t.reduce(((t,e)=>t+"\n  "+e),"")),s.onError&&s.onError(...t)}},[N]:new(e())({onMetadataUpdate:(...t)=>this[U](S,...t),onMetadataEnqueue:(...t)=>this[U](v,...t)}),[Ye]:()=>{clearTimeout(c.get(this)[Je]),this.removeEventListener(p,c.get(this)[Ye]),c.get(this)[x].removeEventListener("waiting",c.get(this)[Ke]),this.state!==m&&(c.get(this)[x].pause(),c.get(this)[N].purgeMetadataQueue(),c.get(this)[We]=c.get(this)[Ve].reset())},[qe]:()=>{this.play()},[$e]:()=>{this.stop()},[je]:()=>{this.state!==d&&this.state!==m||(c.get(this)[x].play(),this[Ne]=l,this[U](y))},[Ge]:t=>{const e={1:"MEDIA_ERR_ABORTED The fetching of the associated resource was aborted by the user's request.",2:"MEDIA_ERR_NETWORK Some kind of network error occurred which prevented the media from being successfully fetched, despite having previously been available.",3:"MEDIA_ERR_DECODE Despite having previously been determined to be usable, an error occurred while trying to decode the media resource, resulting in an error.",4:"MEDIA_ERR_SRC_NOT_SUPPORTED The associated resource or media provider object (such as a MediaStream) has been found to be unsuitable.",5:"MEDIA_ERR_ENCRYPTED"};this.state!==m?(this[U](C,"The audio element encountered an error",e[t.target.error.code]||`Code: ${t.target.error.code}`,`Message: ${t.target.error.message}`),this.stop()):c.get(this)[Ye]()}}),this[V](),this[Ne]=f,ke.isSupported()?c.get(this)[Ve]=new ke(this):(c.get(this)[Ve]=new Ue(this),this[U](B,"Media Source Extensions API in your browser is not supported. Using two requests, one for audio, and another for metadata.","See: https://caniuse.com/mediasource and https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API"))}static canPlayType(t){return{mediasource:ke.canPlayType(t),html5:Ue.canPlayType(t)}}get audioElement(){return c.get(this)[x]}get icyMetaInt(){return c.get(this)[Ve].icyMetaInt}get metadataQueue(){return c.get(this)[N].metadataQueue}get state(){return c.get(this)[Ne]}set[Ne](t){this.dispatchEvent(new CustomEvent(t)),c.get(this)[Ne]=t}[V](){const t=c.get(this)[x];t.addEventListener("pause",c.get(this)[$e]),t.addEventListener("play",c.get(this)[qe]),t.addEventListener("canplay",c.get(this)[je]),t.addEventListener("error",c.get(this)[Ge])}async detachAudioElement(){const t=c.get(this)[x];t.removeEventListener("pause",c.get(this)[$e]),t.removeEventListener("play",c.get(this)[qe]),t.removeEventListener("canplay",c.get(this)[je]),t.removeEventListener("error",c.get(this)[Ge]),await this.stop()}async play(){if(this.state===f){let t;c.get(this)[$]=new AbortController,this[Ne]=d,this[U](w);const e=()=>c.get(this)[Ve].play().catch((async s=>{if("AbortError"!==s.name){if(await this[W](s))return this[U](I),e();c.get(this)[$].abort(),c.get(this)[Ne]!==u&&c.get(this)[Ne]!==f&&(this[U](C,s),t=s)}}));e().finally((()=>{c.get(this)[Ye](),t&&!t.message.match(/network|fetch|offline/)&&this[O](),this[U](E),this[Ne]=f})),await new Promise((t=>{this.addEventListener(y,t,{once:!0})}))}}async stop(){this.state!==f&&this.state!==u&&(this[Ne]=u,c.get(this)[$].abort(),await new Promise((t=>{this.addEventListener(E,t,{once:!0})})))}async[W](t){if(0===c.get(this)[k])return!1;if(c.get(this)[Ne]===m)return await new Promise((t=>{this.addEventListener(u,t,{once:!0});const e=Math.min(c.get(this)[P]*c.get(this)[z]**c.get(this)[Qe]++,c.get(this)[F]);setTimeout((()=>{this.removeEventListener(u,t),t()}),e+.3*e*Math.random())})),c.get(this)[Ne]===m;if(c.get(this)[Ne]!==u&&c.get(this)[Ne]!==f&&(t.message.match(/network|fetch|offline|Error in body stream/i)||"HTTP Response Error"===t.name)){this[U](C,t),this[Ne]=m,this.addEventListener(p,c.get(this)[Ye],{once:!0}),c.get(this)[H]&&this[U](B,"This stream was requested with ICY metadata.",'If there is a CORS preflight failure, try removing "icy" from the metadataTypes option.',"See https://github.com/eshaz/icecast-metadata-js#cors for more details.");const e=new Promise((t=>{c.get(this)[Ke]=t,c.get(this)[x].addEventListener("waiting",c.get(this)[Ke],{once:!0})}));return c.get(this)[Je]=setTimeout((()=>{e.then((()=>{c.get(this)[Ne]===m&&(this[U](A),this.stop())}))}),c.get(this)[k]),c.get(this)[Qe]=0,!0}return!1}[U](t,...e){this.dispatchEvent(new CustomEvent(t,{detail:e})),c.get(this)[He][t](...e)}[O](){this[U](C,"Falling back to HTML5 audio by using two requests: one for audio, and another for metadata.","See the console for details on the error."),c.get(this)[Ve]=new Ue(this),c.get(this)[We].then((()=>this.play()))}}})(),IcecastMetadataPlayer=i.default})();
//# sourceMappingURL=icecast-metadata-player-1.3.0.min.js.map