/*! For license information please see icecast-metadata-player-1.15.0.main.min.js.LICENSE.txt */

/*! 
 * Copyright 2021-2023 Ethan Halsall
 * https://github.com/eshaz/icecast-metadata-js
 *
 * This file is part of icecast-metadata-player.
 *
 * icecast-metadata-player free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * icecast-metadata-player distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
var IcecastMetadataPlayer;(()=>{"use strict";var t,s,i,e={273:(t,s,i)=>{i.d(s,{Z:()=>Qt});const e=(t,s,i)=>{for(let e=0;e<t.length;e++){let h=s(e);for(let t=8;t>0;t--)h=i(h);t[e]=h}return t},h=e(new Uint8Array(256),(t=>t),(t=>128&t?7^t<<1:t<<1)),r=[e(new Uint16Array(256),(t=>t<<8),(t=>t<<1^(32768&t?32773:0)))],a=[e(new Uint32Array(256),(t=>t),(t=>t>>>1^3988292384*(1&t)))];for(let t=0;t<15;t++){r.push(new Uint16Array(256)),a.push(new Uint32Array(256));for(let s=0;s<=255;s++)r[t+1][s]=r[0][r[t][s]>>>8]^r[t][s]<<8,a[t+1][s]=a[t][s]>>>8^a[0][255&a[t][s]]}const n=t=>{const s=t.length,i=s-16;let e=0,h=0;for(;h<=i;)e=a[15][255&(t[h++]^e)]^a[14][255&(t[h++]^e>>>8)]^a[13][255&(t[h++]^e>>>16)]^a[12][t[h++]^e>>>24]^a[11][t[h++]]^a[10][t[h++]]^a[9][t[h++]]^a[8][t[h++]]^a[7][t[h++]]^a[6][t[h++]]^a[5][t[h++]]^a[4][t[h++]]^a[3][t[h++]]^a[2][t[h++]]^a[1][t[h++]]^a[0][t[h++]];for(;h!==s;)e=a[0][255&(e^t[h++])]^e>>>8;return-1^e},o=(...t)=>{const s=new Uint8Array(t.reduce(((t,s)=>t+s.length),0));return t.reduce(((t,i)=>(s.set(i,t),t+i.length)),0),s},c=t=>String.fromCharCode(...t),d=[0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15],l=t=>d[15&t]<<4|d[t>>4];class u{constructor(t){this.t=t,this.i=8*t.length}set position(t){this.i=t}get position(){return this.i}read(t){const s=Math.floor(this.i/8),i=this.i%8;this.i-=t;return(l(this.t[s-1])<<8)+l(this.t[s])>>7-i&255}}class m{constructor(t){this.h=t,this.reset()}enable(){this.S=!0}reset(){this.q=new Map,this.A=new WeakMap,this.M=!1,this.v=null,this.S=!1}checkCodecUpdate(t,s){if(this.h){this.v!==t&&(this.v=t,this.M=!0);const i=this.A.get(this.q.get(this.P));this.M&&i&&this.h({bitrate:t,...i},s),this.M=!1}}updateCurrentHeader(t){this.h&&t!==this.P&&(this.M=!0,this.P=t)}getHeader(t){const s=this.q.get(t);return s&&this.updateCurrentHeader(t),s}setHeader(t,s,i){this.S&&(this.updateCurrentHeader(t),this.q.set(t,s),this.A.set(s,i))}}const y=new WeakMap,f=new WeakMap;class p{constructor(t,s){this.T=t,this.q=s}*syncFrame(){let t;for(;;){if(t=yield*this.Frame.getFrame(this.T,this.q,0),t)return t;this.T.incrementRawData(1)}}*fixedLengthFrameSync(t){let s=yield*this.syncFrame();const i=f.get(s).length;if(t||this.T._||(yield*this.Header.getHeader(this.T,this.q,i)))return this.q.enable(),this.T.incrementRawData(i),this.T.mapFrameStats(s),s;this.T.logWarning(`Missing frame frame at ${i} bytes from current position.`,"Dropping current frame and trying again."),this.q.reset(),this.T.incrementRawData(1)}}class w{constructor(t,s){f.set(this,{header:t}),this.data=s}}class g extends w{static*getFrame(t,s,i,e,h){const r=yield*t.getHeader(i,e,h);if(r){const t=y.get(r).frameLength,e=y.get(r).samples;return new s(r,(yield*i.readRawData(t,h)).subarray(0,t),e)}return null}constructor(t,s,i){super(t,s),this.header=t,this.samples=i,this.duration=i/t.sampleRate*1e3,this.frameNumber=null,this.totalBytesOut=null,this.totalSamples=null,this.totalDuration=null,f.get(this).length=s.length}}const b="reserved",S="bad",q="free",A="none",M="16bit CRC",v="left",E="center",P="right",T=["","front ","side ","rear "].map((t=>[[v,P],[v,P,E],[v,E,P],[E,v,P],[E]].flatMap((s=>s.map((s=>t+s)).join(", "))))),_="LFE",I="monophonic (mono)",R="stereo",C="surround",x=[I,R,`linear ${C}`,"quadraphonic",`5.0 ${C}`,`5.1 ${C}`,`6.1 ${C}`,`7.1 ${C}`],B=(t,...s)=>`${x[t-1]} (${s.join(", ")})`,O=[I,B(2,T[0][0]),B(3,T[0][2]),B(4,T[1][0],T[3][0]),B(5,T[1][2],T[3][0]),B(6,T[1][2],T[3][0],_),B(7,T[1][2],T[2][0],T[3][4],_),B(8,T[1][2],T[2][0],T[3][0],_)],D=48e3,$=44100,k=32e3,U=24e3,F=22050,z=16e3,L=8e3;class N{static*getID3v2Header(t,s,i){const e={headerLength:10};let h=yield*t.readRawData(3,i);return 73!==h[0]||68!==h[1]||51!==h[2]?null:(h=yield*t.readRawData(e.headerLength,i),e.version=`id3v2.${h[3]}.${h[4]}`,15&h[5]?null:(e.unsynchronizationFlag=Boolean(128&h[5]),e.extendedHeaderFlag=Boolean(64&h[5]),e.experimentalFlag=Boolean(32&h[5]),e.footerPresent=Boolean(16&h[5]),128&h[6]||128&h[7]||128&h[8]||128&h[9]?null:(e.dataLength=h[6]<<21|h[7]<<14|h[8]<<7|h[9],e.length=e.headerLength+e.dataLength,new N(e))))}constructor(t){this.version=t.version,this.unsynchronizationFlag=t.unsynchronizationFlag,this.extendedHeaderFlag=t.extendedHeaderFlag,this.experimentalFlag=t.experimentalFlag,this.footerPresent=t.footerPresent,this.length=t.length}}class G{constructor(t){y.set(this,t),this.bitDepth=t.bitDepth,this.bitrate=null,this.channels=t.channels,this.channelMode=t.channelMode,this.sampleRate=t.sampleRate}}const H={0:[q,q,q,q,q],16:[32,32,32,32,8],240:[S,S,S,S,S]},W=(t,s,i)=>8*((t+i)%s+s)*(1<<(t+i)/s)-8*s*(s/8|0);for(let t=2;t<15;t++)H[t<<4]=[32*t,W(t,4,0),W(t,4,-1),W(t,8,4),W(t,8,0)];const j="bands ",V=" to 31",Q={0:j+4+V,16:j+8+V,32:j+12+V,48:j+16+V},Y="Intensity stereo ",K=", MS stereo ",Z="on",J="off",X={0:{description:b},2:{description:"Layer III",framePadding:1,modeExtensions:{0:Y+J+K+J,16:Y+Z+K+J,32:Y+J+K+Z,48:Y+Z+K+Z},v1:{bitrateIndex:2,samples:1152},v2:{bitrateIndex:4,samples:576}},4:{description:"Layer II",framePadding:1,modeExtensions:Q,samples:1152,v1:{bitrateIndex:1},v2:{bitrateIndex:4}},6:{description:"Layer I",framePadding:4,modeExtensions:Q,samples:384,v1:{bitrateIndex:0},v2:{bitrateIndex:3}}},tt="MPEG Version ",st="ISO/IEC ",it={0:{description:`${tt}2.5 (later extension of MPEG 2)`,layers:"v2",sampleRates:{0:11025,4:12e3,8:L,12:b}},8:{description:b},16:{description:`${tt}2 (${st}13818-3)`,layers:"v2",sampleRates:{0:F,4:U,8:z,12:b}},24:{description:`${tt}1 (${st}11172-3)`,layers:"v1",sampleRates:{0:$,4:D,8:k,12:b}}},et={0:M,1:A},ht={0:A,1:"50/15 ms",2:b,3:"CCIT J.17"},rt={0:{channels:2,description:R},64:{channels:2,description:"joint "+R},128:{channels:2,description:"dual channel"},192:{channels:1,description:I}};class at extends G{static*getHeader(t,s,i){const e={},h=yield*N.getID3v2Header(t,s,i);h&&(yield*t.readRawData(h.length,i),t.incrementRawData(h.length));const r=yield*t.readRawData(4,i),a=c(r.subarray(0,4)),n=s.getHeader(a);if(n)return new at(n);if(255!==r[0]||r[1]<224)return null;const o=it[24&r[1]];if(o.description===b)return null;const d=6&r[1];if(X[d].description===b)return null;const l={...X[d],...X[d][o.layers]};if(e.mpegVersion=o.description,e.layer=l.description,e.samples=l.samples,e.protection=et[1&r[1]],e.length=4,e.bitrate=H[240&r[2]][l.bitrateIndex],e.bitrate===S)return null;if(e.sampleRate=o.sampleRates[12&r[2]],e.sampleRate===b)return null;if(e.framePadding=2&r[2]&&l.framePadding,e.isPrivate=Boolean(1&r[2]),e.frameLength=Math.floor(125*e.bitrate*e.samples/e.sampleRate+e.framePadding),!e.frameLength)return null;const u=192&r[3];if(e.channelMode=rt[u].description,e.channels=rt[u].channels,e.modeExtension=l.modeExtensions[48&r[3]],e.isCopyrighted=Boolean(8&r[3]),e.isOriginal=Boolean(4&r[3]),e.emphasis=ht[3&r[3]],e.emphasis===b)return null;e.bitDepth=16;const{length:m,frameLength:y,samples:f,...p}=e;return s.setHeader(a,e,p),new at(e)}constructor(t){super(t),this.bitrate=t.bitrate,this.emphasis=t.emphasis,this.framePadding=t.framePadding,this.isCopyrighted=t.isCopyrighted,this.isOriginal=t.isOriginal,this.isPrivate=t.isPrivate,this.layer=t.layer,this.modeExtension=t.modeExtension,this.mpegVersion=t.mpegVersion,this.protection=t.protection}}class nt extends g{static*getFrame(t,s,i){return yield*super.getFrame(at,nt,t,s,i)}constructor(t,s,i){super(t,s,i)}}class ot extends p{constructor(t,s,i){super(t,s),this.Frame=nt,this.Header=at,i(this.codec)}get codec(){return"mpeg"}*parseFrame(){return yield*this.fixedLengthFrameSync()}}const ct={0:"MPEG-4",8:"MPEG-2"},dt={0:"valid",2:S,4:S,6:S},lt={0:M,1:A},ut={0:"AAC Main",64:"AAC LC (Low Complexity)",128:"AAC SSR (Scalable Sample Rate)",192:"AAC LTP (Long Term Prediction)"},mt={0:96e3,4:88200,8:64e3,12:D,16:$,20:k,24:U,28:F,32:z,36:12e3,40:11025,44:L,48:7350,52:b,56:b,60:"frequency is written explicitly"},yt={0:{channels:0,description:"Defined in AOT Specific Config"},64:{channels:1,description:I},128:{channels:2,description:B(2,T[0][0])},192:{channels:3,description:B(3,T[1][3])},256:{channels:4,description:B(4,T[1][3],T[3][4])},320:{channels:5,description:B(5,T[1][3],T[3][0])},384:{channels:6,description:B(6,T[1][3],T[3][0],_)},448:{channels:8,description:B(8,T[1][3],T[2][0],T[3][0],_)}};class ft extends G{static*getHeader(t,s,i){const e={},h=yield*t.readRawData(7,i),r=c([h[0],h[1],h[2],252&h[3]|3&h[6]]),a=s.getHeader(r);if(a)Object.assign(e,a);else{if(255!==h[0]||h[1]<240)return null;if(e.mpegVersion=ct[8&h[1]],e.layer=dt[6&h[1]],e.layer===S)return null;const t=1&h[1];e.protection=lt[t],e.length=t?7:9,e.profileBits=192&h[2],e.sampleRateBits=60&h[2];const i=2&h[2];if(e.profile=ut[e.profileBits],e.sampleRate=mt[e.sampleRateBits],e.sampleRate===b)return null;e.isPrivate=Boolean(i),e.channelModeBits=448&(h[2]<<8|h[3]),e.channelMode=yt[e.channelModeBits].description,e.channels=yt[e.channelModeBits].channels,e.isOriginal=Boolean(32&h[3]),e.isHome=Boolean(8&h[3]),e.copyrightId=Boolean(8&h[3]),e.copyrightIdStart=Boolean(4&h[3]),e.bitDepth=16,e.samples=1024,e.numberAACFrames=3&h[6];const{length:a,channelModeBits:n,profileBits:o,sampleRateBits:c,frameLength:d,samples:l,numberAACFrames:u,...m}=e;s.setHeader(r,e,m)}if(e.frameLength=8191&(h[3]<<11|h[4]<<3|h[5]>>5),!e.frameLength)return null;const n=2047&(h[5]<<6|h[6]>>2);return e.bufferFullness=2047===n?"VBR":n,new ft(e)}constructor(t){super(t),this.copyrightId=t.copyrightId,this.copyrightIdStart=t.copyrightIdStart,this.bufferFullness=t.bufferFullness,this.isHome=t.isHome,this.isOriginal=t.isOriginal,this.isPrivate=t.isPrivate,this.layer=t.layer,this.length=t.length,this.mpegVersion=t.mpegVersion,this.numberAACFrames=t.numberAACFrames,this.profile=t.profile,this.protection=t.protection}get audioSpecificConfig(){const t=y.get(this),s=t.profileBits+64<<5|t.sampleRateBits<<5|t.channelModeBits>>3,i=new Uint8Array(2);return new DataView(i.buffer).setUint16(0,s,!1),i}}class pt extends g{static*getFrame(t,s,i){return yield*super.getFrame(ft,pt,t,s,i)}constructor(t,s,i){super(t,s,i)}}class wt extends p{constructor(t,s,i){super(t,s),this.Frame=pt,this.Header=ft,i(this.codec)}get codec(){return"aac"}*parseFrame(){return yield*this.fixedLengthFrameSync()}}class gt extends g{static getFrameFooterCrc16(t){return(t[t.length-2]<<8)+t[t.length-1]}static checkFrameFooterCrc16(t){return gt.getFrameFooterCrc16(t)===(t=>{const s=t.length,i=s-16;let e=0,h=0;for(;h<=i;)e^=t[h++]<<8|t[h++],e=r[15][e>>8]^r[14][255&e]^r[13][t[h++]]^r[12][t[h++]]^r[11][t[h++]]^r[10][t[h++]]^r[9][t[h++]]^r[8][t[h++]]^r[7][t[h++]]^r[6][t[h++]]^r[5][t[h++]]^r[4][t[h++]]^r[3][t[h++]]^r[2][t[h++]]^r[1][t[h++]]^r[0][t[h++]];for(;h!==s;)e=(255&e)<<8^r[0][e>>8^t[h++]];return e})(t.subarray(0,-2))}constructor(t,s,i){s.streamInfo=i,s.crc16=gt.getFrameFooterCrc16(t),super(s,t,y.get(s).samples)}}const bt="get from STREAMINFO metadata block",St={0:"Fixed",1:"Variable"},qt={0:b,16:192};for(let t=2;t<16;t++)qt[t<<4]=t<6?576*2**(t-2):2**t;const At={0:bt,1:88200,2:176400,3:192e3,4:L,5:z,6:F,7:U,8:k,9:$,10:D,11:96e3,15:S},Mt={0:{channels:1,description:I},16:{channels:2,description:B(2,T[0][0])},32:{channels:3,description:B(3,T[0][1])},48:{channels:4,description:B(4,T[1][0],T[3][0])},64:{channels:5,description:B(5,T[1][1],T[3][0])},80:{channels:6,description:B(6,T[1][1],_,T[3][0])},96:{channels:7,description:B(7,T[1][1],_,T[3][4],T[2][0])},112:{channels:8,description:B(8,T[1][1],_,T[3][0],T[2][0])},128:{channels:2,description:`${R} (left, diff)`},144:{channels:2,description:`${R} (diff, right)`},160:{channels:2,description:`${R} (avg, diff)`},176:b,192:b,208:b,224:b,240:b},vt={0:bt,2:8,4:12,6:b,8:16,10:20,12:24,14:b};class Et extends G{static decodeUTF8Int(t){if(t[0]>254)return null;if(t[0]<128)return{value:t[0],length:1};let s=1;for(let i=64;i&t[0];i>>=1)s++;let i=s-1,e=0,h=0;for(;i>0;h+=6,i--){if(128!=(192&t[i]))return null;e|=(63&t[i])<<h}return e|=(t[i]&127>>s)<<h,{value:e,length:s}}static getHeaderFromUint8Array(t,s){const i={readRawData:function*(){return t}};return Et.getHeader(i,s,0).next().value}static*getHeader(t,s,i){let e=yield*t.readRawData(6,i);if(255!==e[0]||248!==e[1]&&249!==e[1])return null;const r={},a=c(e.subarray(0,4)),n=s.getHeader(a);if(n)Object.assign(r,n);else{if(r.blockingStrategyBits=1&e[1],r.blockingStrategy=St[r.blockingStrategyBits],r.blockSizeBits=240&e[2],r.sampleRateBits=15&e[2],r.blockSize=qt[r.blockSizeBits],r.blockSize===b)return null;if(r.sampleRate=At[r.sampleRateBits],r.sampleRate===S)return null;if(1&e[3])return null;const t=Mt[240&e[3]];if(t===b)return null;if(r.channels=t.channels,r.channelMode=t.description,r.bitDepth=vt[14&e[3]],r.bitDepth===b)return null}r.length=5,e=yield*t.readRawData(r.length+8,i);const o=Et.decodeUTF8Int(e.subarray(4));if(!o)return null;if(r.blockingStrategyBits?r.sampleNumber=o.value:r.frameNumber=o.value,r.length+=o.length,96===r.blockSizeBits?(e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.blockSize=e[r.length-1]+1,r.length+=1):112===r.blockSizeBits&&(e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.blockSize=(e[r.length-1]<<8)+e[r.length]+1,r.length+=2),r.samples=r.blockSize,12===r.sampleRateBits?(e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.sampleRate=1e3*e[r.length-1],r.length+=1):13===r.sampleRateBits?(e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.sampleRate=(e[r.length-1]<<8)+e[r.length],r.length+=2):14===r.sampleRateBits&&(e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.sampleRate=10*((e[r.length-1]<<8)+e[r.length]),r.length+=2),e.length<r.length&&(e=yield*t.readRawData(r.length,i)),r.crc=e[r.length-1],r.crc!==(t=>{let s=0;const i=t.length;for(let e=0;e!==i;e++)s=h[s^t[e]];return s})(e.subarray(0,r.length-1)))return null;if(!n){const{blockingStrategyBits:t,frameNumber:i,sampleNumber:e,samples:h,sampleRateBits:n,blockSizeBits:o,crc:c,length:d,...l}=r;s.setHeader(a,r,l)}return new Et(r)}constructor(t){super(t),this.crc16=null,this.blockingStrategy=t.blockingStrategy,this.blockSize=t.blockSize,this.frameNumber=t.frameNumber,this.sampleNumber=t.sampleNumber,this.streamInfo=null}}class Pt extends p{constructor(t,s){super(t,s),this.Frame=gt,this.Header=Et}get codec(){return"flac"}*I(t){const s=yield*this.T.readRawData(2,0),i=s.length-2;for(;t<i;){if(255===s[t]){const i=s[t+1];if(248===i||249===i)break;255!==i&&t++}t++}return t}*parseFrame(){for(;;){const t=yield*Et.getHeader(this.T,this.q,0);if(t){let s=y.get(t).length+2;for(;s<=524288;){if(this.T._||(yield*Et.getHeader(this.T,this.q,s))){let i=yield*this.T.readRawData(s);if(this.T._||(i=i.subarray(0,s)),gt.checkFrameFooterCrc16(i)){const e=new gt(i,t);return this.q.enable(),this.T.incrementRawData(s),this.T.mapFrameStats(e),e}}s=yield*this.I(s+1)}this.T.logWarning(`Unable to sync FLAC frame after searching ${s} bytes.`),this.T.incrementRawData(s)}else this.T.incrementRawData(yield*this.I(1))}}parseOggPage(t){return 0===t.pageSequenceNumber?(this.q.enable(),this.R=t.data.subarray(13)):1===t.pageSequenceNumber||(t.codecFrames=f.get(t).segments.map((t=>{const s=Et.getHeaderFromUint8Array(t,this.q);if(s)return new gt(t,s,this.R);this.T.logWarning("Failed to parse Ogg FLAC frame","Skipping invalid FLAC frame")})).filter((t=>Boolean(t)))),t}}class Tt{static*getHeader(t,s,i){const e={};let h=yield*t.readRawData(28,i);if(79!==h[0]||103!==h[1]||103!==h[2]||83!==h[3])return null;e.streamStructureVersion=h[4];if(248&h[5])return null;e.isLastPage=Boolean(4&h[5]),e.isFirstPage=Boolean(2&h[5]),e.isContinuedPacket=Boolean(1&h[5]);const r=new DataView(Uint8Array.from(h.subarray(0,28)).buffer);try{e.absoluteGranulePosition=r.getBigInt64(6,!0)}catch{}e.streamSerialNumber=r.getInt32(14,!0),e.pageSequenceNumber=r.getInt32(18,!0),e.pageChecksum=r.getInt32(22,!0);const a=h[26];e.length=a+27,h=yield*t.readRawData(e.length,i),e.frameLength=0,e.pageSegmentTable=[],e.pageSegmentBytes=Uint8Array.from(h.subarray(27,e.length));for(let t=0,s=0;t<a;t++){const i=e.pageSegmentBytes[t];e.frameLength+=i,s+=i,255===i&&t!==a-1||(e.pageSegmentTable.push(s),s=0)}return new Tt(e)}constructor(t){y.set(this,t),this.absoluteGranulePosition=t.absoluteGranulePosition,this.isContinuedPacket=t.isContinuedPacket,this.isFirstPage=t.isFirstPage,this.isLastPage=t.isLastPage,this.pageSegmentTable=t.pageSegmentTable,this.pageSequenceNumber=t.pageSequenceNumber,this.pageChecksum=t.pageChecksum,this.streamSerialNumber=t.streamSerialNumber}}class _t extends w{static*getFrame(t,s,i){const e=yield*Tt.getHeader(t,s,i);if(e){const s=y.get(e).frameLength,i=y.get(e).length,h=i+s,r=(yield*t.readRawData(h,0)).subarray(0,h),a=r.subarray(i,h);return new _t(e,a,r)}return null}constructor(t,s,i){super(t,s),f.get(this).length=i.length,this.codecFrames=[],this.rawData=i,this.absoluteGranulePosition=t.absoluteGranulePosition,this.crc32=t.pageChecksum,this.duration=0,this.isContinuedPacket=t.isContinuedPacket,this.isFirstPage=t.isFirstPage,this.isLastPage=t.isLastPage,this.pageSequenceNumber=t.pageSequenceNumber,this.samples=0,this.streamSerialNumber=t.streamSerialNumber}}class It extends g{constructor(t,s){super(s,t,s.frameSize*s.frameCount/1e3*s.sampleRate)}}const Rt={0:O.slice(0,2),1:O},Ct="SILK-only",xt="CELT-only",Bt="Hybrid",Ot="narrowband",Dt="medium-band",$t="wideband",kt="super-wideband",Ut="fullband",Ft={0:{mode:Ct,bandwidth:Ot,frameSize:10},8:{mode:Ct,bandwidth:Ot,frameSize:20},16:{mode:Ct,bandwidth:Ot,frameSize:40},24:{mode:Ct,bandwidth:Ot,frameSize:60},32:{mode:Ct,bandwidth:Dt,frameSize:10},40:{mode:Ct,bandwidth:Dt,frameSize:20},48:{mode:Ct,bandwidth:Dt,frameSize:40},56:{mode:Ct,bandwidth:Dt,frameSize:60},64:{mode:Ct,bandwidth:$t,frameSize:10},72:{mode:Ct,bandwidth:$t,frameSize:20},80:{mode:Ct,bandwidth:$t,frameSize:40},88:{mode:Ct,bandwidth:$t,frameSize:60},96:{mode:Bt,bandwidth:kt,frameSize:10},104:{mode:Bt,bandwidth:kt,frameSize:20},112:{mode:Bt,bandwidth:Ut,frameSize:10},120:{mode:Bt,bandwidth:Ut,frameSize:20},128:{mode:xt,bandwidth:Ot,frameSize:2.5},136:{mode:xt,bandwidth:Ot,frameSize:5},144:{mode:xt,bandwidth:Ot,frameSize:10},152:{mode:xt,bandwidth:Ot,frameSize:20},160:{mode:xt,bandwidth:$t,frameSize:2.5},168:{mode:xt,bandwidth:$t,frameSize:5},176:{mode:xt,bandwidth:$t,frameSize:10},184:{mode:xt,bandwidth:$t,frameSize:20},192:{mode:xt,bandwidth:kt,frameSize:2.5},200:{mode:xt,bandwidth:kt,frameSize:5},208:{mode:xt,bandwidth:kt,frameSize:10},216:{mode:xt,bandwidth:kt,frameSize:20},224:{mode:xt,bandwidth:Ut,frameSize:2.5},232:{mode:xt,bandwidth:Ut,frameSize:5},240:{mode:xt,bandwidth:Ut,frameSize:10},248:{mode:xt,bandwidth:Ut,frameSize:20}};class zt extends G{static getHeaderFromUint8Array(t,s,i){const e={};if(e.channels=t[9],e.channelMappingFamily=t[18],e.length=0!==e.channelMappingFamily?21+e.channels:19,t.length<e.length)throw new Error("Out of data while inside an Ogg Page");const h=3&s[0],r=3===h?2:1,a=c(t.subarray(0,e.length))+c(s.subarray(0,r)),n=i.getHeader(a);if(n)return new zt(n);if("OpusHead"!==a.substr(0,8))return null;if(1!==t[8])return null;e.data=Uint8Array.from(t.subarray(0,e.length));const o=new DataView(e.data.buffer);if(e.bitDepth=16,e.preSkip=o.getUint16(10,!0),e.inputSampleRate=o.getUint32(12,!0),e.sampleRate=D,e.outputGain=o.getInt16(16,!0),e.channelMappingFamily in Rt&&(e.channelMode=Rt[e.channelMappingFamily][e.channels-1],!e.channelMode))return null;0!==e.channelMappingFamily&&(e.streamCount=t[19],e.coupledStreamCount=t[20],e.channelMappingTable=[...t.subarray(21,e.channels+21)]);const d=Ft[248&s[0]];switch(e.mode=d.mode,e.bandwidth=d.bandwidth,e.frameSize=d.frameSize,h){case 0:e.frameCount=1;break;case 1:case 2:e.frameCount=2;break;case 3:e.isVbr=Boolean(128&s[1]),e.hasOpusPadding=Boolean(64&s[1]),e.frameCount=63&s[1];break;default:return null}const{length:l,data:u,channelMappingFamily:m,...y}=e;return i.setHeader(a,e,y),new zt(e)}constructor(t){super(t),this.data=t.data,this.bandwidth=t.bandwidth,this.channelMappingFamily=t.channelMappingFamily,this.channelMappingTable=t.channelMappingTable,this.coupledStreamCount=t.coupledStreamCount,this.frameCount=t.frameCount,this.frameSize=t.frameSize,this.hasOpusPadding=t.hasOpusPadding,this.inputSampleRate=t.inputSampleRate,this.isVbr=t.isVbr,this.mode=t.mode,this.outputGain=t.outputGain,this.preSkip=t.preSkip,this.streamCount=t.streamCount}}class Lt extends p{constructor(t,s){super(t,s),this.Frame=It,this.Header=zt,this.C=null}get codec(){return"opus"}parseOggPage(t){return 0===t.pageSequenceNumber?(this.q.enable(),this.C=t.data):1===t.pageSequenceNumber||(t.codecFrames=f.get(t).segments.map((t=>{const s=zt.getHeaderFromUint8Array(this.C,t,this.q);if(s)return new It(t,s);this.T.logError("Failed to parse Ogg Opus Header","Not a valid Ogg Opus file")}))),t}}class Nt extends g{constructor(t,s,i){super(s,t,i)}}const Gt={};for(let t=0;t<8;t++)Gt[t+6]=2**(6+t);class Ht extends G{static getHeaderFromUint8Array(t,s){if(t.length<30)throw new Error("Out of data while inside an Ogg Page");const i=c(t.subarray(0,30)),e=s.getHeader(i);if(e)return new Ht(e);const h={length:30};if("vorbis"!==i.substr(0,7))return null;h.data=Uint8Array.from(t.subarray(0,30));const r=new DataView(h.data.buffer);if(h.version=r.getUint32(7,!0),0!==h.version)return null;if(h.channels=t[11],h.channelMode=O[h.channels-1]||"application defined",h.sampleRate=r.getUint32(12,!0),h.bitrateMaximum=r.getInt32(16,!0),h.bitrateNominal=r.getInt32(20,!0),h.bitrateMinimum=r.getInt32(24,!0),h.blocksize1=Gt[(240&t[28])>>4],h.blocksize0=Gt[15&t[28]],h.blocksize0>h.blocksize1)return null;if(1!==t[29])return null;h.bitDepth=32;{const{length:t,data:e,version:r,...a}=h;s.setHeader(i,h,a)}return new Ht(h)}constructor(t){super(t),this.bitrateMaximum=t.bitrateMaximum,this.bitrateMinimum=t.bitrateMinimum,this.bitrateNominal=t.bitrateNominal,this.blocksize0=t.blocksize0,this.blocksize1=t.blocksize1,this.data=t.data,this.vorbisComments=null,this.vorbisSetup=null}}class Wt extends p{constructor(t,s){super(t,s),this.Frame=Nt,this.C=null,this.B={count:0},this.D=0,this.$=0}get codec(){return"vorbis"}parseOggPage(t){const s=f.get(t).segments;return 0===t.pageSequenceNumber?(this.q.enable(),this.C=t.data):1===t.pageSequenceNumber?s[1]&&(this.k=s[0],this.U=s[1],this.B=this.L(s[1])):t.codecFrames=s.map((t=>{const s=Ht.getHeaderFromUint8Array(this.C,this.q);if(s)return s.vorbisComments=this.k,s.vorbisSetup=this.U,new Nt(t,s,this.N(t,s));this.T.logError("Failed to parse Ogg Vorbis Header","Not a valid Ogg Vorbis file")})),t}N(t,s){const i=t[0]>>1,e=this.B[i&this.B.mask];e&&(this.D=i&this.B.prevMask?s.blocksize1:s.blocksize0),this.$=e?s.blocksize1:s.blocksize0;const h=this.D+this.$>>2;return this.D=this.$,h}L(t){const s=new u(t),i="Failed to read Vorbis stream",e=", failed to parse vorbis modes";let h,r={count:0};for(;1!=(1&s.read(1)););for(;r.count<64&&s.position>0;){const t=l(s.read(8));if(t in r&&(1!==r.count||0!==t))throw this.T.logError("received duplicate mode mapping"+e),new Error(i);let a=0;for(;0===s.read(8)&&a++<3;);if(4!==a){if(1+((126&l(h))>>1)!==r.count)throw this.T.logError("mode count did not match actual modes"+e),new Error(i);break}h=s.read(7),r[t]=1&h,s.position+=6,r.count++}return r.mask=(1<<Math.log2(r.count))-1,r.prevMask=1+(1|r.mask),r}}class jt extends p{constructor(t,s,i){super(t,s),this.G=i,this.Frame=_t,this.Header=Tt,this.H=null,this.W=new Uint8Array,this.V=0}get codec(){return this.H||""}Y(t,s){this.H!==t&&(this.K=new s(this.T,this.q),this.H=t,this.G(t))}J({data:t}){const s=c(t.subarray(0,8));switch(s){case"fishead\0":case"fisbone\0":case"index\0\0\0":return!1;case"OpusHead":return this.Y("opus",Lt),!0;case/^\x7fFLAC/.test(s)&&s:return this.Y("flac",Pt),!0;case/^\x01vorbis/.test(s)&&s:return this.Y("vorbis",Wt),!0}}X(t){t.pageSequenceNumber!==this.V+1&&this.V>1&&t.pageSequenceNumber>1&&this.T.logWarning("Unexpected gap in Ogg Page Sequence Number.",`Expected: ${this.V+1}, Got: ${t.pageSequenceNumber}`),this.V=t.pageSequenceNumber}*parseFrame(){const t=yield*this.fixedLengthFrameSync(!0);this.X(t);const s=f.get(t),{pageSegmentBytes:i,pageSegmentTable:e}=y.get(s.header);let h=0;if(s.segments=e.map((s=>t.data.subarray(h,h+=s))),255===i[i.length-1]?this.W=o(this.W,s.segments.pop()):this.W.length&&(s.segments[0]=o(this.W,s.segments[0]),this.W=new Uint8Array),this.H||this.J(t)){const s=this.K.parseOggPage(t);return this.T.mapFrameStats(s),s}}}const Vt=()=>{};const Qt=class{constructor(t,{onCodecUpdate:s,onCodec:i,enableLogging:e=!1,enableFrameCRC32:h=!0}={}){this.tt=t,this.G=i||Vt,this.h=s,this.st=e,this.it=h?n:Vt,this.et=this.ht(),this.et.next()}get codec(){return this.K.codec}*flush(){this._=!0;for(let t=this.et.next();t.value;t=this.et.next())yield t.value;this._=!1,this.et=this.ht(),this.et.next()}*parseChunk(t){for(let s=this.et.next(t);s.value;s=this.et.next())yield s.value}parseAll(t){return[...this.parseChunk(t),...this.flush()]}*ht(){if(this.q=new m(this.h),this.tt.match(/aac/))this.K=new wt(this,this.q,this.G);else if(this.tt.match(/mpeg/))this.K=new ot(this,this.q,this.G);else if(this.tt.match(/flac/))this.K=new Pt(this,this.q,this.G);else{if(!this.tt.match(/ogg/))throw new Error(`Unsupported Codec ${mimeType}`);this.K=new jt(this,this.q,this.G)}for(this.rt=0,this.nt=0,this.ot=0,this.ct=0,this.dt=0,this.lt=void 0,this.ut=new Uint8Array(0);;){const t=yield*this.K.parseFrame();t&&(yield t)}}*readRawData(t=0,s=0){let i;for(;this.ut.length<=t+s;){if(i=yield,this._)return this.ut.subarray(s);i&&(this.ot+=i.length,this.ut=o(this.ut,i))}return this.ut.subarray(s)}incrementRawData(t){this.nt+=t,this.ut=this.ut.subarray(t)}mapCodecFrameStats(t){this.lt=t.header.sampleRate,t.header.bitrate=8*Math.round(t.data.length/t.duration),t.frameNumber=this.rt++,t.totalBytesOut=this.ct,t.totalSamples=this.dt,t.totalDuration=this.dt/this.lt*1e3,t.crc32=this.it(t.data),this.q.checkCodecUpdate(t.header.bitrate,t.totalDuration),this.ct+=t.data.length,this.dt+=t.samples}mapFrameStats(t){t.codecFrames?(t.codecFrames.forEach((s=>{t.duration+=s.duration,t.samples+=s.samples,this.mapCodecFrameStats(s)})),t.totalSamples=this.dt,t.totalDuration=this.dt/this.lt*1e3||0,t.totalBytesOut=this.ct):this.mapCodecFrameStats(t)}yt(t,s){if(this.st){const i=[`codec:         ${this.codec}`,`inputMimeType: ${this.tt}`,`readPosition:  ${this.nt}`,`totalBytesIn:  ${this.ot}`,`totalBytesOut: ${this.ct}`],e=Math.max(...i.map((t=>t.length)));s.push(`--stats--${"-".repeat(e-9)}`,...i,"-".repeat(e)),t("codec-parser",s.reduce(((t,s)=>t+"\n  "+s),""))}}logWarning(...t){this.yt(console.warn,t)}logError(...t){this.yt(console.error,t)}}}},h={};function r(t){var s=h[t];if(void 0!==s)return s.exports;var i=h[t]={exports:{}};return e[t](i,i.exports,r),i.exports}r.m=e,t=[],r.O=(s,i,e,h)=>{if(!i){var a=1/0;for(d=0;d<t.length;d++){for(var[i,e,h]=t[d],n=!0,o=0;o<i.length;o++)(!1&h||a>=h)&&Object.keys(r.O).every((t=>r.O[t](i[o])))?i.splice(o--,1):(n=!1,h<a&&(a=h));if(n){t.splice(d--,1);var c=e();void 0!==c&&(s=c)}}return s}h=h||0;for(var d=t.length;d>0&&t[d-1][2]>h;d--)t[d]=t[d-1];t[d]=[i,e,h]},r.F={},r.E=t=>{Object.keys(r.F).map((s=>{r.F[s](t)}))},r.d=(t,s)=>{for(var i in s)r.o(s,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((s,i)=>(r.f[i](t,s),s)),[])),r.u=t=>"icecast-metadata-player-1.15.0."+({122:"vorbis",388:"mpeg",390:"opus",496:"synaudio",756:"mediasource",983:"flac"}[t]||t)+".min.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s),s={},i="IcecastMetadataPlayer:",r.l=(t,e,h,a)=>{if(s[t])s[t].push(e);else{var n,o;if(void 0!==h)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var l=c[d];if(l.getAttribute("src")==t||l.getAttribute("data-webpack")==i+h){n=l;break}}n||(o=!0,(n=document.createElement("script")).charset="utf-8",n.timeout=120,r.nc&&n.setAttribute("nonce",r.nc),n.setAttribute("data-webpack",i+h),n.src=t),s[t]=[e];var u=(i,e)=>{n.onerror=n.onload=null,clearTimeout(m);var h=s[t];if(delete s[t],n.parentNode&&n.parentNode.removeChild(n),h&&h.forEach((t=>t(e))),i)return i(e)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=u.bind(null,n.onerror),n.onload=u.bind(null,n.onload),o&&document.head.appendChild(n)}},r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"ft",{value:!0})},(()=>{var t;r.g.importScripts&&(t=r.g.location+"");var s=r.g.document;if(!t&&s&&(s.currentScript&&(t=s.currentScript.src),!t)){var i=s.getElementsByTagName("script");i.length&&(t=i[i.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=t})(),(()=>{var t={179:0};r.f.j=(s,i)=>{var e=r.o(t,s)?t[s]:void 0;if(0!==e)if(e)i.push(e[2]);else{var h=new Promise(((i,h)=>e=t[s]=[i,h]));i.push(e[2]=h);var a=r.p+r.u(s),n=new Error;r.l(a,(i=>{if(r.o(t,s)&&(0!==(e=t[s])&&(t[s]=void 0),e)){var h=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;n.message="Loading chunk "+s+" failed.\n("+h+": "+a+")",n.name="ChunkLoadError",n.type=h,n.request=a,e[1](n)}}),"chunk-"+s,s)}},r.F.j=s=>{if(!r.o(t,s)||void 0===t[s]){t[s]=null;var i=document.createElement("link");r.nc&&i.setAttribute("nonce",r.nc),i.rel="prefetch",i.as="script",i.href=r.p+r.u(s),document.head.appendChild(i)}},r.O.j=s=>0===t[s];var s=(s,i)=>{var e,h,[a,n,o]=i,c=0;if(a.some((s=>0!==t[s]))){for(e in n)r.o(n,e)&&(r.m[e]=n[e]);if(o)var d=o(r)}for(s&&s(i);c<a.length;c++)h=a[c],r.o(t,h)&&t[h]&&t[h][0](),t[h]=0;return r.O(d)},i=self.webpackChunkIcecastMetadataPlayer=self.webpackChunkIcecastMetadataPlayer||[];i.forEach(s.bind(null,0)),i.push=s.bind(null,i.push.bind(i))})(),r.O(0,[179],(()=>{r.E(496),r.E(756)}),5);var a={};(()=>{r.d(a,{default:()=>lt});const t=()=>{},s=new WeakMap,i={LOADING:"loading",PLAYING:"playing",STOPPING:"stopping",STOPPED:"stopped",RETRYING:"retrying",SWITCHING:"switching"},e={BUFFER:"buffer",PLAY:"play",PLAY_READY:"playready",LOAD:"load",STREAM_START:"streamstart",STREAM:"stream",STREAM_END:"streamend",METADATA:"metadata",METADATA_ENQUEUE:"metadataenqueue",CODEC_UPDATE:"codecupdate",STOP:"stop",RETRY:"retry",RETRY_TIMEOUT:"retrytimeout",SWITCH:"switch",WARN:"warn",ERROR:"error",PLAYBACK_ERROR:"playbackerror"},h=Symbol(),n=Symbol(),o=Symbol(),c=Symbol(),d=Symbol(),l=Symbol(),u=Symbol(),m=Symbol(),y=Symbol(),f=Symbol(),p=Symbol(),w=Symbol(),g=Symbol(),b=Symbol(),S=Symbol(),q=Symbol(),A=Symbol(),M=Symbol(),v=Symbol(),E=Symbol(),P=Symbol(),T=Symbol(),_=Symbol("synced"),I=Symbol("syncing"),R=Symbol("pcm_synced"),C=Symbol("not_synced"),x=t=>{const s=new Uint8Array(t.reduce(((t,s)=>t+s.length),0));return t.reduce(((t,i)=>(s.set(i,t),t+i.length)),0),s};class B{constructor(){this.wt=[]}hasEventListener(t,s){return this.wt.some((i=>i.type===t&&i.listener===s))}addEventListener(t,s,i={}){return this.hasEventListener(t,s)||this.wt.push({type:t,listener:s,options:i}),this}removeEventListener(t,s){const i=this.wt.findIndex((i=>i.type===t&&i.listener===s));return i>=0&&this.wt.splice(i,1),this}removeEventListeners(){return this.wt=[],this}dispatchEvent(t){return this.wt.filter((s=>s.type===t.type)).forEach((s=>{const{type:i,listener:e,options:{once:h}}=s;e.call(this,t),!0===h&&this.removeEventListener(i,e)})),this}}class O{constructor(){this.gt=0,this.bt=0,this.St=0,this.qt=0,this.At=0,this.Mt=0,this.vt=0}get stats(){return{totalBytesRead:this.gt,streamBytesRead:this.bt,metadataLengthBytesRead:this.St,metadataBytesRead:this.qt,currentBytesRemaining:this.At,currentStreamBytesRemaining:this.Mt,currentMetadataBytesRemaining:this.vt}}set currentStreamBytesRemaining(t){this.Mt+=t}set currentMetadataBytesRemaining(t){this.vt=t}addBytes(t){this.gt+=t,this.At-=t}addStreamBytes(t){this.bt+=t,this.Mt-=t}addMetadataLengthBytes(t){this.St+=t}addMetadataBytes(t){this.qt+=t,this.vt-=t}addCurrentBytesRemaining(t){this.At+=t}}const D=()=>{};class ${constructor(t){this.Et=0,this.Pt=0,this.Tt=new Uint8Array(0),this._t=[],this.It=0,this.Rt=new O,this.Ct=t.onStream||D,this.xt=t.onMetadata||D,this.Bt=t.onMetadataFailed||D,this.Ot=t.onError||D,this.st=t.enableLogging||!1,this.Dt=Promise.resolve(),this.$t=Promise.resolve(),this.et=this.kt(),this.et.next()}*kt(){for(this.Et=1/0;;)this.Ut(yield*this.Ft()),yield*this.zt()}static Lt(...t){const s=t.reduce(((t,s)=>t+s.length),0);return this.Nt(t,s)}static Nt(t,s){const i=new Uint8Array(s);return t.reduce(((t,s)=>(i.set(s,t),t+s.length)),0),i}*iterator(t){for(let s=this.et.next(t);s.value;s=this.et.next())yield s.value}readAll(t){for(let s=this.et.next(t);s.value;s=this.et.next());}async*asyncIterator(t){for(let s=this.et.next(t);s.value;s=this.et.next())await this.Dt,await this.$t,yield s.value}async asyncReadAll(t){for(let s=this.et.next(t);s.value;s=this.et.next())await this.Dt,await this.$t}Gt(...t){this.st&&console.warn("icecast-metadata-js",t.reduce(((t,s)=>t+"\n  "+s),"")),this.Ot(...t)}Ut(t){this._t.push(t),this.It+=t.length}*zt(){if(this._t.length){const t=$.Nt(this._t,this.It);this._t=[],this.It=0,this.Rt.addStreamBytes(t.length);const s={stream:t,stats:this.Rt.stats};this.Dt=this.Ct(s),yield s}}*Ht(t){yield*this.zt();const s={metadata:t,stats:this.Rt.stats};this.$t=this.xt(s),yield s}*Ft(t=0){for(this.Pt===this.Tt.length&&(this.Tt=yield*this.Wt(),this.Pt=0);this.Tt.length-this.Pt<t;)this.Tt=$.Lt(this.Tt,yield*this.Wt());const s=this.Tt.subarray(this.Pt,(t||this.Et)+this.Pt);return this.Rt.addBytes(s.length),this.Et=s.length<this.Et?this.Et-s.length:0,this.Pt+=s.length,s}*Wt(){let t;yield*this.zt();do{t=yield}while(!t||0===t.length);return this.Rt.addCurrentBytesRemaining(t.length),t}}class k extends ${constructor({icyMetaInt:t,icyDetectionTimeout:s=2e3,icyCharacterEncoding:i="utf-8",...e}){super(e),this.jt=new globalThis.TextDecoder(i),this.Vt=t,this.Qt=s,this.et=this.Yt(),this.et.next()}*Yt(){if(yield*this.Kt())for(;;)this.Et=this.Vt,yield*this.Zt(),yield*this.Jt(),this.Et&&(yield*this.Xt());this.Et=1/0,yield*this.Zt()}static parseIcyMetadata(t){const s=/(?<key>[^\0]+?)='(?<val>[^\0]*?)(;$|';|'$|$)/,i={};for(const e of t.match(new RegExp(s,"g"))||[]){const t=e.match(s);t&&(i[t.groups.key]=t.groups.val)}return i}get icyMetaInt(){return this.Vt}*Kt(){if(this.Vt>0)return!0;if(!this.Qt)return!1;this.Gt("Passed in Icy-MetaInt is invalid. Attempting to detect ICY Metadata.","See https://github.com/eshaz/icecast-metadata-js for information on how to properly request ICY Metadata.");const t=[null,83,116,114,101,97,109,84,105,116,108,101,61],s=Date.now();let i=0;for(;s+this.Qt>Date.now();){this.Tt=$.Lt(this.Tt,yield*this.Wt());t:for(;i<this.Tt.length-t.length;){for(let s=1;s<t.length;s++)if(this.Tt[s+i]!==t[s]){i++;continue t}return this.Gt(`Found ICY Metadata! Setting Icy-MetaInt to ${i}.`),this.Vt=i,!0}}return this.Gt("ICY Metadata not detected, but continuing anyway. Audio errors will occur if there is ICY metadata.",`Searched ${this.Tt.length} bytes for ${(Date.now()-s)/1e3} seconds.`,"Try increasing the `icyDetectionTimeout` value if ICY metadata is present in the stream."),this.Bt("icy"),!1}*Zt(){for(this.Rt.currentStreamBytesRemaining=this.Et;this.Et;)this.Ut(yield*super.Ft())}*Jt(){this.Et=1;do{this.Et=16*(yield*this.Ft())[0]}while(1===this.Et);this.Rt.addMetadataLengthBytes(1)}*Xt(){this.Rt.currentMetadataBytesRemaining=this.Et;const t=yield*this.Ft(this.Et);this.Rt.addMetadataBytes(t.length),yield*this.Ht(k.parseIcyMetadata(this.jt.decode(t)))}}class U extends ${constructor(t){super(t),this.jt=new globalThis.TextDecoder("utf-8"),this.et=this.ts(),this.et.next(),this.ss=!1}*ts(){if(yield*this.es()){const t=yield*this.hs();if(t)for(;yield*this.es();)this.ss||(yield*this.Xt(t)),yield*this.Zt()}this.Et=1/0,yield*this.Zt()}rs(t,s=0){return new DataView(Uint8Array.from([...t.subarray(s,s+4)]).buffer).getUint32(0,!0)}ns(t,s){return String.fromCharCode(...s).match(t)}*es(){let t=[];for(;t.length<=65307;){const s=yield*super.Ft(6);if(79===s[0]&&103===s[1]&&103===s[2]&&83===s[3]&&!(248&s[5])){this.ss=1&s[5],this.Pt-=6,this.Et+=6,this.Rt.gt-=6,this.Rt.At+=6;break}t.push(s[0]),this.Pt-=5,this.Rt.gt-=5,this.Rt.At+=5}if(t.length&&this.Ut(Uint8Array.from(t)),t.length>65307)return this.Gt("This stream is not an OGG stream. No OGG metadata will be returned.","See https://github.com/eshaz/icecast-metadata-js for information on OGG metadata."),this.Bt("ogg"),!1;const s=yield*this.Ft(27),i=yield*this.Ft(s[26]);return this.Et=i.reduce(((t,s)=>t+s),0),!0}*hs(){const t=yield*this.Ft(8);return yield*this.Zt(),this.ns(/\x7fFLAC/,t.subarray(0,5))?{regex:/^[\x84|\x04]/,length:4}:this.ns(/OpusHead/,t.subarray(0,8))?{regex:/OpusTags/,length:8}:this.ns(/\x01vorbis/,t.subarray(0,7))?{regex:/\x03vorbis/,length:7}:void 0}*Xt({regex:t,length:s}){this.ns(t,yield*this.Ft(s))&&(yield*this.Ht(yield*this.os()))}*Zt(){for(;this.Et;)yield*this.Ft()}*Ft(t){const s=yield*super.Ft(t);return this.Ut(s),s}*Wt(){const t=yield*super.Wt();return this.Rt.currentStreamBytesRemaining=t.length,t}*os(){const t=this.rs(yield*this.Ft(4));this.Rt.addMetadataBytes(4);const s=this.jt.decode(yield*this.Ft(t));this.Rt.addMetadataBytes(t);const i=this.rs(yield*this.Ft(4));this.Rt.addMetadataBytes(4);const e=[];for(let t=0;t<i;t++){const t=yield*this.Ft(4);this.Rt.addMetadataBytes(4),e.push(yield*this.Ft(this.rs(t))),this.Rt.addMetadataBytes(e[e.length-1].length)}return this.Rt.currentMetadataBytesRemaining=0,e.reduce(((t,s)=>{const i=s.indexOf(61),e=String.fromCharCode(...s.subarray(0,i)).toUpperCase(),h=this.jt.decode(s.subarray(i+1));return t[e]=t[e]?`${t[e]}; ${h}`:h,t}),{VENDOR_STRING:s})}}class F{constructor(t){const{onStream:s,...i}=t;this.cs=new U(t),this.ds=new k(i)}get icyMetaInt(){return this.ds.icyMetaInt}*iterator(t){for(const s of this.ds.iterator(t))s.stream?yield*this.cs.iterator(s.stream):yield s}readAll(t){for(const s of this.ds.iterator(t))s.stream&&this.cs.readAll(s.stream)}async*asyncIterator(t){for await(const s of this.ds.asyncIterator(t))if(s.stream)for await(const t of this.cs.asyncIterator(s.stream))yield t;else yield s}async asyncReadAll(t){for await(const s of this.ds.iterator(t))s.stream&&await this.cs.asyncReadAll(s.stream)}}class z{constructor({metadataTypes:t=["icy"],...s}={}){const i=t.includes("icy"),e=t.includes("ogg");this.ls=i&&e?new F(s):e?new U(s):i?new k(s):new $(s)}static parseIcyMetadata(t){return k.parseIcyMetadata(t)}get icyMetaInt(){return this.ls.icyMetaInt}*iterator(t){yield*this.ls.iterator(t)}readAll(t){this.ls.readAll(t)}async*asyncIterator(t){return yield*this.ls.asyncIterator(t)}async asyncReadAll(t){return this.ls.asyncReadAll(t)}}const L=()=>{};class N{constructor(t,{onStream:s=L,...i}){let e;this.us=new ReadableStream({async start(h){e=new z({icyMetaInt:parseInt(t.headers.get("Icy-MetaInt")),...i,onStream:async t=>(h.enqueue(t.stream),s(t))});for await(const s of N.asyncIterator(t.body))await e.asyncReadAll(s);h.close()}}),this.ys=e}get icyMetaInt(){return this.ys.icyMetaInt}get readableStream(){return this.us}async startReading(){try{for await(const t of N.asyncIterator(this.us));}catch(t){if("AbortError"!==t.name)throw t}}static asyncIterator(t){const s=t.getReader();return{[Symbol.asyncIterator]:()=>({next:()=>s.read()})}}}const G=()=>{};class H{constructor({icyBr:t,onMetadataUpdate:s=G,onMetadataEnqueue:i=G,paused:e=!1}){this.fs=t,this.ps=s,this.ws=i,this.gs=e,this.bs=e,this.Ss=!0,this.qs=[],this.As=[]}get metadataQueue(){return this.As.map((({Ms:t,...s})=>s))}addMetadata({metadata:t,stats:s},i,e=0){const h={metadata:t,timestampOffset:i,timestamp:e+=s?this.getTimeByBytes(s.currentStreamPosition):0};this.bs?this.qs.push(h):this.vs(h)}getTimeByBytes(t){return this.fs?t/(125*this.fs):0}startQueue(t){this.bs&&(this.qs.forEach((s=>{void 0!==t&&(s.timestamp=t),(void 0===t||s.timestampOffset>=s.timestamp)&&this.vs(s)})),this.qs=[],this.bs=!1)}purgeMetadataQueue(){this.As.forEach((t=>clearTimeout(t.Ms))),this.As=[],this.qs=[],this.bs=this.gs,this.Ss=!0}vs(t){this.As.push(t),this.ws(t.metadata,t.timestampOffset,t.timestamp),this.Ss?(this.Es(),this.Ss=!1):t.Ms=setTimeout((()=>{this.Es()}),1e3*(t.timestampOffset-t.timestamp))}Es(){if(this.As.length){const{metadata:t,timestampOffset:s,timestamp:i}=this.As.shift();this.ps(t,s,i)}}}var W=r(273);class j{constructor(t,s){this.CRC_DURATION=3e5,this.PCM_DURATION=6e4,this.ys=t,this.Ps=s,this.initSync(),this.initQueue()}initSync(){clearTimeout(this.Ts),this.Ts=null,this._s=null,this.Is=!1,this.Rs=[],this.Cs=0,this.xs=null,this.Bs=null,this.Os=null}initQueue(){this.Ds=0,this.$s=0,this.ks=0,this.Us=[],this.Fs=0,this.zs={},this.Ls=[],this.Ns=0}get buffered(){return this.$s/this.ks-this.Ps.currentTime||0}add(t){const{crc32:s,duration:i,samples:e}=t;this.$s+=e,this.ks=t.header.sampleRate,this.Us.push({crc32:s,duration:i}),this.Fs+=i;let h=this.zs[s];if(h||(h=[],this.zs[s]=h),h.push(this.Ds++),this.Fs>=this.CRC_DURATION){const{crc32:t,duration:s}=this.Us.shift();this.Fs-=s;const i=this.zs[t];i.shift(),i.length||delete this.zs[t]}this.Ls.push(t),this.Ns+=i,this.Ns>=this.PCM_DURATION&&(this.Ns-=this.Ls.shift().duration)}addAll(t){t.forEach((t=>this.add(t)))}Gs(t){for(const s of t)this.Cs+=s.duration,this.Rs.push(s)}async sync(s){if(null===this.Ts){const s=this.buffered;this.Hs=t,this.Ts=setTimeout((()=>{this._s=`Buffer underrun after syncing for ${s.toFixed(2)} seconds.`,this.Hs(this._s)}),1e3*s)}return this.Gs(s),new Promise((async(t,s)=>{let i;null!==this._s?s(this._s):this.Hs=s,this.Is&&(i=this.Ws()),i||(this.Is=!1,i=await this.js()),i?t(i):s("Old and new request do not match.")})).catch((t=>{this.ys.state!==i.STOPPING&&this.ys.state!==i.STOPPED&&this.ys[q](e.WARN,`Reconnected successfully after ${this.ys.state}.`,"Unable to sync old and new request.",t);const s=this.Rs;return this.initSync(),this.initQueue(),[s,C]})).then((t=>([_,R].includes(t[1])&&this.initSync(),t)))}Ws(){if(!this.Rs.length)return[[],I];const t=this.Rs[0].crc32,s=this.zs[t];let i,h,r;if(s){t:for(const t of s){r=t-(this.Ds-this.Us.length);for(let t=0;t<this.Rs.length&&r+t<this.Us.length;t++)if(this.Us[r+t].crc32!==this.Rs[t].crc32)continue t;h=r+this.Rs.length<=this.Us.length,i=!0;break}if(h)return[[],I];if(i){const t=this.Us.length-r;return this.ys[q](e.WARN,`Reconnected successfully after ${this.ys.state}.`,`Found ${t} frames (${(this.Us.slice(r).reduce(((t,{duration:s})=>t+s),0)/1e3).toFixed(3)} seconds) of overlapping audio data in new request.`,"Synchronized old and new request."),[this.Rs.slice(t),_]}}}async js(){try{const t=1,s=16,i=(t,s)=>t/s;if(!this.xs){let h;try{h=(await r.e(496).then(r.bind(r,379))).default}catch(t){return void this.ys[q](e.WARN,"Failed to synchronize old and new stream","Missing `synaudio` dependency.")}const[a,n,o]=await this.Vs(),c=o*t;if(n.samplesDecoded<=c)return[[],I];const d=new h({correlationSampleSize:c,initialGranularity:s});this.xs=await d.syncWorkerConcurrent(a,n,Math.max(navigator.hardwareConcurrency-1,1)),this.xs.offsetFromEnd=i(a.samplesDecoded-this.xs.sampleOffset,o)}const{correlation:h,offsetFromEnd:a}=this.xs;let n=1e3*(this.buffered-a);if(-n>this.Cs)return[[],I];const o=0;if(n<0){let t=0;for(let s=0;t<this.Rs.length-o&&s>n;t++)s-=this.Rs[t].duration;this.Rs=this.Rs.slice(t-o)}else for(let t=0;t<o&&t<this.Rs.length;t++)n-=this.Rs[t].duration;return this.ys[q](e.WARN,`Reconnected successfully after ${this.ys.state}.`,`Synchronized old and new request with ${(Math.round(1e4*h)/100).toFixed(2)}% confidence.`),this.initQueue(),[this.Rs,R,n]}catch{}}async Vs(){const t=(t,s)=>{let i=t.length-1;for(let e=0;e<s&&i>0;i--)e+=t[i].duration;return this.ys[c].decodeAudioData(x(t.slice(i).map((({data:t})=>t))).buffer)};[this.Bs,this.Os]=await Promise.all([this.Bs?this.Bs:t(this.Ls,2e3*this.buffered),t(this.Rs,1/0)]);const s=t=>{const s={channelData:[],samplesDecoded:t.length};for(let i=0;i<t.numberOfChannels;i++)s.channelData.push(Float32Array.from(t.getChannelData(i)));return s};return[s(this.Bs),s(this.Os),this.Bs.sampleRate]}}class V{constructor(t,i,e){this.ys=t,this.tt=i,this.H=e;const r=s.get(this.ys);this.Qs=r[d],this.Ys=r[h],this.Ks=r[l],this.Zs=0,this.Js=0,this.Xs=()=>{this.syncState=C}}static parseMimeType(t){return t.match(/^(?:application\/|audio\/|)(?<mime>[a-zA-Z]+)(?:$|;[ ]*codecs=(?:\'|\")(?<codecs>[a-zA-Z,]+)(?:\'|\"))/)}static canPlayType(t,s,i){const e=V.parseMimeType(s),h=s=>s.reduce(((s,i)=>{if(""===s)return"";const e=t(i);return e?"maybe"===e||"maybe"===s?"maybe":!0===e||"probably"===e?"probably":void 0:""}),null);if(e){const{mime:t,codecs:r}=e.groups,a=i&&i[t];if(!a||Array.isArray(a))return h(a||[s])||h([`audio/${t}`]);if("object"==typeof a){if(r){const t=r.split(",");return t.length>1?"":a[t[0]]?h(a[t[0]]):""}return"maybe"}}return""}enablePlayButton(t){this.Qs.removeAttribute("src"),this.Qs.srcObject=null,t.includes("mediasource")?this.Qs.src=URL.createObjectURL(new MediaSource):t.includes("webaudio")?(this.ti=new MediaStream,this.Qs.srcObject=this.ti):t.includes("html5")&&(this.Qs.src="data:audio/mpeg;base64,//sQxAAABFgC/SCEYACCgB9AAAAAppppVCAHBAEIgBByw9WD5+J8ufwxiDEDsMfE+D4fwG/RUGCx6VO4awVxV3qDtQNPiXKnZUNSwKuUDR6IgaeoGg7Fg6pMQU1FMy4xMDCqqqqqqqr/+xLEB4PAAAGkAAAAIAAANIAAAASqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo=",this.Qs.loop=!0)}get syncStateUpdate(){return this.si}get syncState(){return this.ii}set syncState(t){this.ii=t,this.ei&&this.ei(t),this.si=new Promise((t=>{this.ei=t}))}get isSupported(){return!1}get isAudioPlayer(){return!1}get metadataTimestamp(){return 0}get currentTime(){return 0}get waiting(){return Promise.resolve()}get icecastMetadataQueue(){return this.hi}set icecastMetadataQueue(t){this.hi=t}get codecUpdateQueue(){return this.ri}set codecUpdateQueue(t){this.ri=t}get metadataQueue(){return this.hi?this.hi.metadataQueue:[]}ai(){this.hi.startQueue(this.ni),this.ri.startQueue(this.ni)}async oi(){this.syncState=_,this.syncFrames=[],this.syncDelay=null,this.ci=new j(this.ys,this)}async start(t){let s;this.ni=t,[e.RETRY,e.SWITCH].forEach((t=>this.ys.addEventListener(t,this.Xs)));const h=new Promise((t=>{s=t,[i.PLAYING,i.STOPPING].forEach((t=>this.ys.addEventListener(t,s,{once:!0})))})).finally((()=>{[i.PLAYING,i.STOPPING].forEach((t=>this.ys.removeEventListener(t,s)))}));await h}async end(){[e.RETRY,e.SWITCH].forEach((t=>this.ys.removeEventListener(t,this.Xs))),this.hi.purgeMetadataQueue(),this.ri.purgeMetadataQueue()}onStream(t){return t}onMetadata(t){this.hi.addMetadata(t,this.metadataTimestamp,this.currentTime)}onCodecUpdate(t,s){const i=this.currentTime;s<i&&(this.Js+=this.Zs),this.Zs=s,this.ri.addMetadata({metadata:t},(s+this.Js)/1e3,i)}}class Q extends V{constructor(t){super(t),this.Qs.crossOrigin="anonymous",this.Qs.loop=!1,this.Qs.preload="none",this.ys.addEventListener(e.STREAM_START,(()=>{this.di||this.end()})),this.oi()}static canPlayType(t){return Q.isSupported?super.canPlayType((t=>(new Audio).canPlayType(t)),t):""}static get isSupported(){return Boolean(window.Audio)}static get name(){return"html5"}get isAudioPlayer(){return!0}get metadataTimestamp(){return this.li?(this.li.totalDuration+this.ui)/1e3:0}get currentTime(){return this.mi&&(performance.now()-this.mi)/1e3}get waiting(){return new Promise((t=>{this.Qs.addEventListener("waiting",t,{once:!0})}))}async oi(){super.oi(),this.li=null,this.mi=0,this.ui=0,this.di=!1}async start(t){const s=super.start(t);this.yi=performance.now(),this.Qs.src=null,this.Qs.srcObject=null,this.Qs.src=this.Ys,this.ys.state!==i.STOPPING&&this.ys.state!==i.STOPPED&&(this.Qs.addEventListener("playing",(()=>{this.mi=performance.now(),this.ui=performance.now()-this.yi,this.ai(),this.ys[q](e.PLAY)}),{once:!0}),this.ys[q](e.PLAY_READY),this.di=!0),await s}async end(){super.end(),this.Qs.src=null,this.Qs.srcObject=null,this.oi()}onStream(t){this.li=t[t.length-1]||this.li,this.syncState===C&&(this.syncState=C)}}class Y extends V{constructor(t,s,i){super(t,s,i),this.fi=r.e(756).then(r.bind(r,910)),this.oi()}static canPlayType(t){return Y.isSupported?MediaSource.isTypeSupported(t)?"probably":super.canPlayType(MediaSource.isTypeSupported,t,{mpeg:['audio/mp4;codecs="mp3"'],aac:['audio/mp4;codecs="mp4a.40.2"'],aacp:['audio/mp4;codecs="mp4a.40.2"'],flac:['audio/mp4;codecs="flac"'],ogg:{flac:['audio/mp4;codecs="flac"'],opus:['audio/mp4;codecs="opus"','audio/webm;codecs="opus"'],vorbis:['audio/webm;codecs="vorbis"']}}):""}static get isSupported(){return Boolean(window.MediaSource)}static get name(){return"mediasource"}get isAudioPlayer(){return!0}get metadataTimestamp(){return this.pi&&this.pi.sourceBuffers.length&&Math.max(this.pi.sourceBuffers[0].timestampOffset,this.pi.sourceBuffers[0].buffered.length?this.pi.sourceBuffers[0].buffered.end(0):0)||0}get currentTime(){return this.Qs.currentTime}get waiting(){return new Promise((t=>{this.Qs.addEventListener("waiting",t,{once:!0})}))}async oi(){super.oi(),this.wi=[],this.di=!1,this.gi=!1,this.bi=new Promise((t=>{this.Si=t})),this.qi=new Promise((t=>{this.Ai=t})),this.Mi=this.vi(this.tt,this.H),await this.qi}async start(t){const s=super.start(t);await this.bi,await this.Ei(),await s}async end(){super.end(),await this.oi()}async onStream(t){if((t=t.flatMap((t=>t.codecFrames?t.codecFrames.map((s=>(s.isLastPage=t.isLastPage,s))):t))).length){switch(this.syncState){case C:this.ci.initSync(),this.syncState=I;case I:[this.syncFrames,this.syncState,this.syncDelay]=await this.ci.sync(t),t=this.syncFrames}switch(this.syncState){case R:break;case _:await this.qi,await this.Mi(t),this.ci.addAll(t)}}}vi(t,s){return MediaSource.isTypeSupported(t)?(this.Pi(t),async t=>this.Ti(x(t.map((t=>t.data))))):(this._i(t,s).then((()=>{this.Pi(this.Ii.mimeType)})),async i=>{let e=[];for await(const h of i)this.gi!==h.isLastPage&&(h.isLastPage?this.gi=!0:(await this.Ti(x(e)),e=[],await this._i(t,s),this.gi=!1)),e.push(...this.Ii.iterator([h]));await this.Ti(x(e))})}async _i(t,s){this.Ii=new(await this.fi).default(t,{codec:s,preferredContainer:"fmp4"}),MediaSource.isTypeSupported(this.Ii.mimeType)||this.ys[q](e.PLAYBACK_ERROR,`Media Source Extensions API in your browser does not support ${t} or ${this.Ii.mimeType}.See: https://caniuse.com/mediasource and https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API`)}Pi(t){this.pi=new MediaSource,this.Si(),this.pi.addEventListener("sourceopen",(()=>{this.Ri=0,this.pi.addSourceBuffer(t).mode="sequence",this.Ai()}),{once:!0})}async Ei(){this.Qs.loop=!1,this.Qs.src=URL.createObjectURL(this.pi),await this.qi}async Ci(){return new Promise((t=>{const s=this.pi.sourceBuffers[0];s.updating?s.addEventListener("updateend",t,{once:!0}):t()}))}async Ti(t){if(this.ys[q](e.STREAM,t),this.pi.sourceBuffers.length||this.ys[q](e.WARN,"Attempting to append audio, but MediaSource has not been or is no longer initialized","Please be sure that `detachAudioElement()` was called and awaited before reusing the element with a new IcecastMetadataPlayer instance"),this.ys.state!==i.STOPPING&&this.pi.sourceBuffers.length){this.wi.push(t);try{for(;this.wi.length;)this.pi.sourceBuffers[0].appendBuffer(this.wi.shift()),await this.Ci()}catch(t){if("QuotaExceededError"!==t.name)throw t}this.di||(this.Ks<=this.metadataTimestamp?(this.Qs.addEventListener("playing",(()=>{this.ai(),this.ys[q](e.PLAY)}),{once:!0}),this.ys[q](e.PLAY_READY),this.di=!0):this.ys[q](e.BUFFER,this.metadataTimestamp)),this.Qs.currentTime>5+this.Ks&&this.Ri+5e3<performance.now()&&(this.Ri=performance.now(),this.pi.sourceBuffers[0].remove(0,this.Qs.currentTime-5+this.Ks),await this.Ci())}}}class K extends V{constructor(t,s,i){super(t,s,i),this.xi=t[c],this.oi()}static canPlayType(t){return K.isSupported?super.canPlayType((t=>'audio/ogg;codecs="opus"'===t||'audio/ogg;codecs="flac"'===t||'audio/ogg;codecs="vorbis"'===t||"audio/mpeg"===t||"audio/flac"===t),t,{flac:["audio/flac"],mpeg:["audio/mpeg"],ogg:{flac:['audio/ogg;codecs="flac"'],opus:['audio/ogg;codecs="opus"'],vorbis:['audio/ogg;codecs="vorbis"']}}):""}static get isSupported(){return Boolean(window.WebAssembly&&(window.AudioContext||window.webkitAudioContext)&&window.MediaStream)}static get name(){return"webaudio"}get isAudioPlayer(){return!0}get metadataTimestamp(){return this.Bi/1e3}get currentTime(){return(performance.now()-this.Oi)/1e3||0}get waiting(){return this.Di}$i(t){let s;this.ki+=t,s=setTimeout((()=>{this.ki-=t,this.Ui.delete(s),this.Ui.size||this.Fi()}),this.ki),this.Ui.add(s)}Fi(){this.zi&&this.zi(),this.Di=new Promise((t=>{this.zi=t}))}Li(){this.Ui&&this.Ui.forEach((t=>clearTimeout(t))),this.Ui=new Set,this.ki=0,this.Fi()}async Ni(){let t;this.Gi=new Promise((t=>{this.Hi=t}));try{switch(this.H){case"mpeg":const{MPEGDecoderWebWorker:s}=await Promise.all([r.e(968),r.e(388)]).then(r.bind(r,775));t=s;break;case"opus":const{OpusDecoderWebWorker:i}=await Promise.all([r.e(968),r.e(390)]).then(r.bind(r,879));t=i;break;case"flac":const{FLACDecoderWebWorker:e}=await Promise.all([r.e(968),r.e(983)]).then(r.bind(r,259));t=e;break;case"vorbis":const{OggVorbisDecoderWebWorker:h}=await Promise.all([r.e(968),r.e(122)]).then(r.bind(r,115));t=h}}catch(t){return void this.ys[q](e.PLAYBACK_ERROR,`Missing \`webaudio-${this.H}\` dependency.`,`Unable to playback playback \`${this.H}\` audio.`)}t?(this.Hi(),this.Wi=new t):this.ys[q](e.PLAYBACK_ERROR,"Unsupported `webaudio` playback codec: "+this.H)}async oi(){super.oi(),this.Bi=0,this.ji=0,this.Vi=0,this.lt=0,this.Oi=void 0,this.di=!1,this.Li(),this.Qi=new Promise((t=>{this.Yi=t}))}async start(t){this.Wi||await this.Ni();const s=super.start(t);this.Yi(),await s}async end(){super.end(),this.Wi&&(this.Wi.terminate(),this.Wi=null),this.ti&&this.ti.stream.getTracks().forEach((t=>this.ti.stream.removeTrack(t))),this.oi()}async onStream(t){if("vorbis"!==this.H)switch(t=t.flatMap((t=>t.codecFrames||t)),this.syncState){case C:this.ci.initSync(),this.syncState=I;case I:[this.syncFrames,this.syncState,this.syncDelay]=await this.ci.sync(t),t=this.syncFrames}switch(this.syncState){case R:break;case _:t.length&&(this.Bi=t[t.length-1].totalDuration,this.Ki(t))}}async Ki(t){if(await this.Gi,this.Wi){let s;await this.Wi.ready,"vorbis"===this.H?s=this.Wi.decodeOggPages(t):(s=this.Wi.decodeFrames(t.map((t=>t.data))),this.ci.addAll(t)),s.then((t=>this.Zi(t)))}}async Zi({channelData:t,samplesDecoded:s,sampleRate:h}){if(await this.Qi,this.ys.state!==i.STOPPING&&this.ys.state!==i.STOPPED&&s){this.ys[q](e.STREAM,{channelData:t,samplesDecoded:s,sampleRate:h}),this.lt||(this.lt=h,this.ti=this.xi.createMediaStreamDestination(),this.Qs.srcObject=this.ti.stream);const i=this.xi.createBuffer(t.length,s,this.lt);t.forEach(((t,s)=>i.getChannelData(s).set(t)));const r=this.xi.createBufferSource();r.buffer=i,r.connect(this.ti);const a=100,n=this.ji*a+this.Vi,o=Math.round(this.xi.currentTime*this.lt*a);n<o&&(this.Vi+=o-n),r.start(n/this.lt/a),this.$i(s/this.lt*1e3),this.di||(this.Ks<=this.metadataTimestamp?(this.ys[q](e.PLAY_READY),this.Oi=performance.now(),this.ai(),this.ys[q](e.PLAY),this.di=!0):this.ys[q](e.BUFFER,this.metadataTimestamp)),this.ji+=s}}}class Z{constructor(i){const e=s.get(i);this.ys=i,this.Qs=e[d],this.st=e[f],this.Ji=e[S],this.Xi="",this.te(),this.Ps=new V(this.ys),this.Ps.icecastMetadataQueue=this.hi,this.Ps.codecUpdateQueue=this.ri,this.Ps.enablePlayButton(Z.supportedPlaybackMethods),this.se=[],this.T=void 0,this.tt="",this.H="",this.ie=Promise.resolve(),this.ee=t}static get supportedPlaybackMethods(){return[Y,K,Q].map((t=>t.isSupported?t.name:""))}static canPlayType(t){return{mediasource:Y.canPlayType(t),html5:Q.canPlayType(t),webaudio:K.canPlayType(t)}}get player(){return this.Ps}get playbackMethod(){return this.Xi}get icyMetaInt(){return this.he&&this.he.icyMetaInt}async playStream(){return this.fetchStream().then((async t=>(this.ys[q](e.STREAM_START),this.readIcecastResponse(t).finally((()=>{this.ys[q](e.STREAM_END)}))))).catch((t=>{if(this.ys.state!==i.SWITCHING)throw t}))}async switchStream(){this.ys.state!==i.PLAYING&&(this.ee(),await this.ie);const t=s.get(this.ys);t[T]=i.SWITCHING,t[P].abort(),t[P]=new AbortController}async fetchStream(){const t=s.get(this.ys);this.Ys=t[h];const i=await fetch(this.Ys,{method:"GET",headers:t[E]?{"Icy-MetaData":1}:{},signal:t[P].signal});if(!i.ok){const t=new Error(`${i.status} received from ${i.url}`);throw t.name="HTTP Response Error",t}return i}async readIcecastResponse(t){const i=t.headers.get("content-type"),h=s.get(this.ys),r=new Promise((t=>{this.T=new W.Z(i,{onCodecUpdate:this.Ji&&((...t)=>this.Ps.onCodecUpdate(...t)),onCodec:t,enableLogging:this.st})}));this.he=new N(t,{onMetadata:async t=>{this.Ps.onMetadata(t)},onStream:async({stream:t})=>{this.ys[q](e.STREAM,t);const s=[...this.T.parseChunk(t)];if(this.Ps.isAudioPlayer){const t=[...this.se,...s];this.se=[],await this.Ps.onStream(t)}else this.se.push(...s)},onError:(...t)=>this.ys[q](e.WARN,...t),metadataTypes:h[n],icyCharacterEncoding:h[m],icyDetectionTimeout:h[y],...h[u]?{icyMetaInt:h[u]}:{}});const a=this.he.startReading(),o=await r;this.Ps.isAudioPlayer||([this.Ps,this.Xi]=this.re(i,o)),this.Ps.syncState===_?this.Ps.start():await this.ae(i,o),await a}async ae(t,s){let e,h,r=!1,a=!1;const n=this.Ps,o=this.Ps.icecastMetadataQueue,c=this.Ps.codecUpdateQueue;this.te(),n.icecastMetadataQueue=this.hi,n.codecUpdateQueue=this.ri;const d=()=>{a=!0,this.ys.state===i.STOPPING&&this.ys.state===i.STOPPED||(n.icecastMetadataQueue.purgeMetadataQueue(),n.codecUpdateQueue.purgeMetadataQueue(),this.Ps.start(Math.max(0,n.syncDelay/1e3)).then((()=>n.end())).then(h))};this.ee=()=>{r=!0,this.hi.purgeMetadataQueue(),this.ri.purgeMetadataQueue(),this.Ps.icecastMetadataQueue=o,this.Ps.codecUpdateQueue=c,void 0===e||a||(clearTimeout(e),d())};const l=()=>this.Ps.syncStateUpdate.then((a=>{if(r)h();else switch(a){case I:return l();case _:this.hi.purgeMetadataQueue(),this.ri.purgeMetadataQueue(),this.Ps.icecastMetadataQueue=o,this.Ps.codecUpdateQueue=c,this.ys.state===i.STOPPING&&this.ys.state===i.STOPPED||(this.ys[T]=i.PLAYING),h();break;case R:case C:n.icecastMetadataQueue=o,n.codecUpdateQueue=c,[this.Ps,this.Xi]=this.re(t,s),this.se.push(...n.syncFrames),e=setTimeout(d,Math.max(n.syncDelay,0))}}));let u;this.ie=new Promise((t=>{h=t,u=()=>{this.ee(),h()},this.ys.addEventListener(i.STOPPING,u,{once:!0}),l()})).finally((()=>{this.ys.removeEventListener(i.STOPPING,u)}))}te(){this.hi=new H({onMetadataUpdate:(...t)=>this.ys[q](e.METADATA,...t),onMetadataEnqueue:(...t)=>this.ys[q](e.METADATA_ENQUEUE,...t),paused:!0}),this.ri=new H({onMetadataUpdate:(...t)=>this.ys[q](e.CODEC_UPDATE,...t),paused:!0})}re(t,i){const{[s.get(this.ys)[o]]:e,...h}={mediasource:Y,webaudio:K,html5:Q};let r,a;for(const s of Object.values({firstMethod:e,...h})){const e=s.canPlayType(`${t};codecs="${i}"`);if("probably"===e||"maybe"===e){a=s.name,r=new s(this.ys,t,i),r.icecastMetadataQueue=this.hi,r.codecUpdateQueue=this.ri;break}}if(!r)throw new Error(`Your browser does not support this audio codec ${t}${i&&`;codecs="${i}"`}`);return[r,a]}}let J;try{new window.EventTarget,J=window.EventTarget}catch{J=B}const X=Symbol(),tt=Symbol(),st=Symbol(),it=Symbol(),et=Symbol(),ht=Symbol(),rt=Symbol(),at=Symbol(),nt=Symbol(),ot=Symbol(),ct=Symbol(),dt=Symbol();class lt extends J{static getDefaults(t,s={}){return{[l]:t.bufferLength??s[l]??1,[u]:t.icyMetaInt??s[u],[m]:t.icyCharacterEncoding??s[m],[y]:t.icyDetectionTimeout??s[y],[n]:(t.metadataTypes??s[n])||["icy"],[E]:((t.metadataTypes??s[n])||["icy"]).includes("icy"),[f]:t.enableLogging??s[f]??!1,[S]:Boolean(t.enableCodecUpdate??s[S]??t.onCodecUpdate),[p]:t.retryDelayRate??s[p]??.1,[w]:t.retryDelayMin??s[w]??.5,[g]:t.retryDelayMax??s[g]??2,[b]:t.retryTimeout??s[b]??30,[o]:(t.playbackMethod??s[o])||"mediasource"}}constructor(r,a={}){super(),s.set(this,{[h]:r,[d]:a.audioElement||new Audio,...lt.getDefaults(a),[st]:{[e.PLAY]:a.onPlay||t,[e.PLAY_READY]:t,[e.LOAD]:a.onLoad||t,[e.STREAM_START]:a.onStreamStart||t,[e.BUFFER]:a.onBuffer||t,[e.STREAM]:a.onStream||t,[e.STREAM_END]:a.onStreamEnd||t,[e.METADATA]:a.onMetadata||t,[e.METADATA_ENQUEUE]:a.onMetadataEnqueue||t,[e.CODEC_UPDATE]:a.onCodecUpdate||t,[e.STOP]:a.onStop||t,[e.RETRY]:a.onRetry||t,[e.RETRY_TIMEOUT]:a.onRetryTimeout||t,[e.SWITCH]:a.onSwitch||t,[e.WARN]:(...t)=>{this[v](console.warn,a.onWarn,t)},[e.ERROR]:(...t)=>{this[v](console.error,a.onError,t)},[e.PLAYBACK_ERROR]:(...t)=>{this.state!==i.RETRYING?(this[q](e.ERROR,...t),this.stop()):s.get(this)[ot]()}},[ot]:()=>{clearTimeout(s.get(this)[dt]),this.removeEventListener(e.STREAM_START,s.get(this)[ot]),s.get(this)[d].removeEventListener("waiting",s.get(this)[at]);try{s.get(this)[d].pause()}catch(t){s.get(this)[rt](t)}try{s.get(this)[tt]=s.get(this)[X].player.end()}catch{}},[et]:()=>{this.play()},[it]:()=>{this.stop()},[rt]:t=>{const s=t?.target?.error||t;this[q](e.PLAYBACK_ERROR,"The audio element encountered an error."+({1:" MEDIA_ERR_ABORTED The fetching of the associated resource was aborted by the user's request.",2:" MEDIA_ERR_NETWORK Some kind of network error occurred which prevented the media from being successfully fetched, despite having previously been available.",3:" MEDIA_ERR_DECODE Despite having previously been determined to be usable, an error occurred while trying to decode the media resource, resulting in an error.",4:" MEDIA_ERR_SRC_NOT_SUPPORTED The associated resource or media provider object (such as a MediaStream) has been found to be unsuitable.",5:" MEDIA_ERR_ENCRYPTED"}[s?.code]||""))},[ht]:()=>{const t=s.get(this)[d];(this.state===i.LOADING||!t.loop&&this.state!==i.STOPPING&&this.state!==i.STOPPED)&&t.play().then((()=>{this[T]=i.PLAYING})).catch((t=>{this[q](e.PLAYBACK_ERROR,t,"Playback failed.")}))},[nt]:t}),this[A](),this[T]=i.STOPPED,s.get(this)[X]=new Z(this)}static canPlayType(t){return Z.canPlayType(t)}get audioElement(){return s.get(this)[d]}get[c](){return lt.constructor[c]}get icyMetaInt(){return s.get(this)[X].icyMetaInt}get metadataQueue(){return s.get(this)[X].player.metadataQueue}get state(){return s.get(this)[T]}get playbackMethod(){return s.get(this)[X].playbackMethod}set[T](t){this.dispatchEvent(new CustomEvent(t)),s.get(this)[T]=t}[A](){const t=s.get(this)[d];t.addEventListener("pause",s.get(this)[it]),t.addEventListener("play",s.get(this)[et]),t.addEventListener("error",s.get(this)[rt]),this.addEventListener(e.PLAY_READY,s.get(this)[ht])}async detachAudioElement(){const t=s.get(this)[d];t.removeEventListener("pause",s.get(this)[it]),t.removeEventListener("play",s.get(this)[et]),t.removeEventListener("error",s.get(this)[rt]),this.removeEventListener(e.PLAY_READY,s.get(this)[ht]),await this.stop()}async play(){if(this.state===i.STOPPED){s.get(this)[P]=new AbortController,this[T]=i.LOADING,this[q](e.LOAD);const t=async()=>s.get(this)[X].playStream().then((()=>this.state===i.SWITCHING?(this[q](e.SWITCH),t()):this.state!==i.STOPPING&&this.state!==i.STOPPED?s.get(this)[X].player.waiting:void 0)).catch((async h=>{if(h&&"AbortError"!==h.name){if(await this[M](h))return this[q](e.RETRY),t();s.get(this)[P].abort(),this.state!==i.STOPPING&&this.state!==i.STOPPED&&this[q](e.ERROR,h.message.match(/network|fetch|offline|codec/i)?h:h.stack,h)}}));new Promise(((i,e)=>{s.get(this)[nt]=e,t().then(i)})).catch((t=>{if(this.state!==i.STOPPING)throw t})).finally((()=>{s.get(this)[ot](),this[q](e.STOP),this[T]=i.STOPPED})),await new Promise((t=>{this.addEventListener(e.PLAY,t,{once:!0})}))}}async stop(){this.state!==i.STOPPED&&this.state!==i.STOPPING&&(this[T]=i.STOPPING,s.get(this)[P].abort(),s.get(this)[nt](),await new Promise((t=>{this.addEventListener(e.STOP,t,{once:!0})})))}async switchEndpoint(t,e){if(this.state!==i.STOPPED&&this.state!==i.STOPPING){const i=s.get(this);return Object.assign(i,{[h]:t,...lt.getDefaults(e,i)}),i[X].switchStream()}}async[M](t){if(0===s.get(this)[b])return!1;if(s.get(this)[T]===i.RETRYING)return await new Promise((t=>{this.addEventListener(i.STOPPING,t,{once:!0});const e=Math.min(1e3*s.get(this)[w]*(s.get(this)[p]+1)**s.get(this)[ct]++,1e3*s.get(this)[g]);setTimeout((()=>{this.removeEventListener(i.STOPPING,t),t()}),e+.3*e*Math.random())})),s.get(this)[T]===i.RETRYING;if(s.get(this)[T]!==i.STOPPING&&s.get(this)[T]!==i.STOPPED&&(t.message.match(/network|fetch|offline|Error in body stream/i)||"HTTP Response Error"===t.name)){this[q](e.ERROR,t.name,t),this[T]=i.RETRYING,s.get(this)[E]&&this[q](e.WARN,"This stream was requested with ICY metadata.",'If there is a CORS preflight failure, try removing "icy" from the metadataTypes option.',"See https://github.com/eshaz/icecast-metadata-js#cors for more details.");const h=new Promise((t=>{s.get(this)[at]=t,s.get(this)[d].addEventListener("waiting",s.get(this)[at],{once:!0})}));return s.get(this)[dt]=setTimeout((()=>{h.then((()=>{s.get(this)[T]===i.RETRYING&&(this[q](e.RETRY_TIMEOUT),this.stop())}))}),1e3*s.get(this)[b]),s.get(this)[ct]=0,!0}return!1}[q](t,...i){this.dispatchEvent(new CustomEvent(t,{detail:i})),s.get(this)[st][t](...i)}[v](t,i,e){s.get(this)[f]&&t("icecast-metadata-js",e.reduce(((t,s)=>t+"\n  "+s),"")),i&&i(...e)}}const ut=window.AudioContext||window.webkitAudioContext;if(ut&&!lt.constructor[c]){lt.constructor[c]="audio context pending";const t=t=>{console.error("icecast-metadata-js","Failed to start the AudioContext. WebAudio playback will not be possible.",t)},s=["touchstart","touchend","mousedown","keydown"],i=()=>{s.forEach((t=>document.removeEventListener(t,i)));const e=new ut({latencyHint:"interactive"});e.resume().then((()=>{e.createScriptProcessor(16384,2,2).connect(e.destination),e.onstatechange=()=>{"running"!==e.state&&e.resume().catch(t)}})).catch(t),lt.constructor[c]=e};s.forEach((t=>document.addEventListener(t,i)))}})(),a=r.O(a),IcecastMetadataPlayer=a.default})();
//# sourceMappingURL=icecast-metadata-player-1.15.0.main.min.js.map