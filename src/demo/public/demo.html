<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Icecast Metadata Player Demo</title>
    <meta name="theme-color" content="#000000" />
    <meta name="title" content="Icecast Metadata Player Demo" />
    <script src="/icecast-metadata-js/icecast-metadata-player-1.1.2.min.js"></script>
    <script src="/icecast-metadata-js/icecast-metadata-stats-0.0.1.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: monospace;
        margin: 0 10%;
      }
      header {
        text-align: center;
      }
      .header-links {
        font-size: 16px;
        font-family: sans-serif;
        text-decoration: none;
        user-select: none;
      }
      .header-link {
        text-decoration: none;
      }
      strong {
        font-family: sans-serif;
      }
      input,
      label,
      button,
      select {
        margin: 5px;
      }
      pre {
        margin: 0px;
      }
      select {
        width: 97%;
      }
      label {
        user-select: none;
      }
      button {
        width: 80%;
      }
      .stream-endpoint {
        width: 95%;
      }
      hr {
        margin: 20px 0;
      }
      .column {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .row {
        display: flex;
        flex-direction: row;
      }
      .options-group {
        justify-content: center;
      }
      .time {
        text-align: right;
      }
      .metadata {
        padding-left: 10px;
        text-align: left;
      }
      .metadata-info {
        font-size: 12px;
        min-height: 500px;
      }
      .metadata-header {
        text-align: left;
        padding-left: 10px;
      }
      .query-endpoint {
        min-width: 300px;
      }
      .stats-table {
        text-align: center;
      }
      .stats-row-name {
        text-align: left;
      }
    </style>
    <script>
      let playerFormData, statsFormData;
      const stations = fetch("/icecast-metadata-js/stations.json")
        .then((res) => res.text())
        .then((text) => JSON.parse(text));

      const manualQuery = (button, promise) => {
        button.disabled = true;
        //button.innerHTML = "Fetching...";

        promise.then((stats) => {
          button.disabled = false;
          //button.innerHTML = "Fetch";
          console.log(stats);
        });
      };

      // helper functions
      const formatTime = (seconds) =>
        new Date(seconds * 1000).toISOString().substr(14, 8);

      const formatMetadata = (metadata) =>
        JSON.stringify(metadata, null, 1)
          .replace(/\{\n|\n\}/g, "")
          .replace(/^ "|\n "/g, '\n"');

      const bodyLoad = async () => {
        document.playerForm.reset();
        document.statsForm.reset();

        document.playerForm.addEventListener("change", () => {
          playerFormData = Object.fromEntries(
            new FormData(playerForm).entries()
          );

          getIcecastMetadataStats();
        });

        document.statsForm.addEventListener("change", () => {
          statsFormData = Object.fromEntries(new FormData(statsForm).entries());

          getIcecastMetadataStats();
        });

        const stationsEl = document.getElementById("stations");

        (await stations).forEach(
          ({ name, codec, metadataTypes, endpoint }, idx) => {
            const option = document.createElement("option");
            option.text = `${name} - ${codec}`;
            option.value = endpoint;
            option.name = endpoint;
            option.id = idx;
            stationsEl.add(option);
          }
        );

        stationsEl.addEventListener("change", async () => {
          const station = (await stations)[stationsEl.selectedIndex];
          // prettier-ignore
          {
            document.getElementById("endpoint").value = station.endpoint;
            document.getElementById("icy").checked = station.metadataTypes.includes("icy");
            document.getElementById("ogg").checked = station.metadataTypes.includes("ogg");
  
            document.getElementById("icy-auto-query").checked = station.statsSources.includes("icy");
            document.getElementById("ogg-auto-query").checked = station.statsSources.includes("ogg");
            document.getElementById("sevenhtml-auto-query").checked = station.statsSources.includes("sevenhtml");
            document.getElementById("stats-auto-query").checked = station.statsSources.includes("stats");
            document.getElementById("icestats-auto-query").checked = station.statsSources.includes("icestats");
            document.getElementById("nextsongs-auto-query").checked = station.statsSources.includes("nextsongs");
          }

          playerFormData = Object.fromEntries(
            new FormData(playerForm).entries()
          );
          statsFormData = Object.fromEntries(new FormData(statsForm).entries());

          getIcecastMetadataStats();
        });

        stationsEl.selectedIndex = 0;
        stationsEl.dispatchEvent(new Event("change"));
      };
    </script>
  </head>
  <body onload="bodyLoad();">
    <header>
      <h1 style="margin-bottom: 0px">
        <a href="https://github.com/eshaz/icecast-metadata-js"
          ><b>icecast-metadata-js</b></a
        >
      </h1>
      <p>
        Javascript library that reads, parses, and queues real-time metadata
        from an Icecast stream.
      </p>
      <div class="header-links">
        <a class="header-link" href="/icecast-metadata-js">React Demo</a
        >&nbsp;&nbsp; | &nbsp;&nbsp;<a
          class="header-link"
          style="font-weight: bold"
          href="/icecast-metadata-js/demo.html"
          >HTML Demo</a
        >&nbsp;&nbsp; | &nbsp;&nbsp;<a
          class="header-link"
          href="/icecast-metadata-js/bare-minimum-demo.html"
          ><i>"Bare Minimum"</i> HTML Demo</a
        >
      </div>
    </header>
    <hr />
    <strong>Icecast Metadata Player HTML Demo</strong>
    <a
      href="https://github.com/eshaz/icecast-metadata-js/blob/master/src/demo/public/demo.html"
      >Source for this demo</a
    >
    <p>
      <b
        ><a
          >This module is a part of
          <a href="https://github.com/eshaz/icecast-metadata-js"
            >icecast-metadata-js</a
          >. See the links in the header for more information.</a
        ></b
      >
    </p>
    <p>
      This page demonstrates the IcecastMetadataPlayer module.
      <i>IcecastMetadataPlayer</i> is designed to be as simple as possible to
      use, as it handles all of the MSE logic, fetch logic, error handling,
      audio functionality, metadata parsing, and metadata synchronization. See
      the other packages available in
      <a href="https://github.com/eshaz/icecast-metadata-js"
        >icecast-metadata-js</a
      >
      for other Icecast compatible tools.
    </p>
    <strong>Usage</strong>
    <ol>
      <li>
        Download the
        <a
          href="https://raw.githubusercontent.com/eshaz/icecast-metadata-js/master/src/icecast-metadata-player/build/icecast-metadata-player-1.1.2.min.js"
          download
          >latest build</a
        >, or install via
        <a href="https://www.npmjs.com/package/icecast-metadata-player">NPM</a>.
      </li>
      <li>Include the file in a <i>&lt;script&gt;</i> tag in your html.</li>
      <li>
        <i>IcecastMetadataReader</i> is made available as a global variable in
        your webpage to use wherever.
      </li>
      <li>
        Checkout the
        <a
          href="https://github.com/eshaz/icecast-metadata-js/tree/master/src/icecast-metadata-player#readme"
          >README</a
        >
        for more information.
      </li>
    </ol>
    <b>Example</b>
    <pre>
      &lt;script src="icecast-metadata-player-1.1.2.min.js"&gt;&lt;/script&gt;
      &lt;script&gt;
        const onMetadata = (metadata) =&gt; {
          document.getElementById("metadata").innerHTML = metadata.StreamTitle;
        };
        const player = 
          new IcecastMetadataPlayer(
            "https://dsmrad.io/stream/isics-all", // stream endpoint
            { onMetadata }                        // options (onMetadata callback)
          );
      &lt;/script&gt;
      &lt;body&gt;
        &lt;button onclick="player.play();"&gt; Play &lt;/button&gt;
        &lt;button onclick="player.stop();"&gt; Stop &lt;/button&gt;
        &lt;p&gt; Now Playing: &lt;span id="metadata"&gt;&lt;/span&gt; &lt;/p&gt;
      &lt;/body&gt;
    </pre>
    <hr />
    <h3>Controls</h3>
    <ul>
      <li>
        <b>Stream Endpoint</b> selects which URL to request by using the
        pre-selected streams, or entered manually in the input field.
      </li>
      <li>
        <b>Metadata Types</b> select which metadata types to read from the
        response.
      </li>
      <li>
        <b>ICY Metadata Interval</b> shows the detected metadata interval either
        from the <i>Icy-MetaInt</i> header value or the value detected in the
        stream.
      </li>
      <li>
        <b>ICY Detection Timeout</b> is the time in milliseconds to wait before
        giving up on detecting ICY metadata in the response. (Note: If a stream
        actually contains ICY metadata and times out, there will be errors in
        the decoded audio.
      </li>
    </ul>
    <div class="row options-group">
      <fieldset name="audio-controls" class="column">
        <legend>Audio Controls</legend>
        <button id="play">Play</button>
        <button id="stop">Stop</button>
        <button id="reset" onclick="document.playerForm.reset();">Reset</button>
      </fieldset>
      <form name="playerForm" id="playerForm">
        <fieldset name="stream-endpoint" class="column">
          <legend>Stream Endpoint</legend>
          <input
            class="stream-endpoint"
            name="endpoint"
            id="endpoint"
            type="url"
          />
          <select id="stations" name="stations"></select>
        </fieldset>
        <div class="row">
          <fieldset name="metadata-types" class="column">
            <legend>Metadata Types</legend>
            <div class="row">
              <label for="icy">ICY</label>
              <input id="icy" name="icy" type="checkbox" />
            </div>
            <div class="row">
              <label for="ogg">OGG</label>
              <input id="ogg" name="ogg" type="checkbox" />
            </div>
          </fieldset>
          <fieldset name="icy-metadata-options" class="row">
            <legend>ICY Metadata Options</legend>
            <div class="column">
              <label for="icyMetaInt">ICY Metadata Interval</label>
              <input name="icyMetaInt" id="icyMetaInt" disabled />
            </div>
            <div class="column">
              <label for="icyDetectionTimeout"
                >ICY Detection Timeout (ms)</label
              >
              <input
                type="number"
                id="icyDetectionTimeout"
                name="icyDetectionTimeout"
                value="2000"
              />
            </div>
          </fieldset>
        </div>
      </form>
    </div>
    <div class="row options-group">
      <fieldset name="metadata-stats-controls" class="column">
        <legend>Stats Controls</legend>
        <button id="stats-start">Start</button>
        <button id="stats-stop">Stop</button>
        <button id="stats-reset" onclick="document.statsForm.reset();">
          Reset
        </button>
      </fieldset>
      <form name="statsForm" id="statsForm" onsubmit="return false;">
        <fieldset>
          <legend>Stats</legend>
          <table class="stats-table">
            <th>Type</th>
            <th>Auto</th>
            <th>Manual</th>
            <th>Endpoint</th>
            <tr>
              <td class="stats-row-name">
                <label for="icy-auto-query">ICY</label>
              </td>
              <td>
                <input
                  id="icy-auto-query"
                  name="icy-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="icy-manual-query"
                  name="icy-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getIcyMetadata())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="icy-query-endpoint"
                  id="icy-query-endpoint"
                  type="url"
                  disabled
                />
              </td>
            </tr>
            <tr>
              <td class="stats-row-name">
                <label for="ogg-auto-query">Ogg</label>
              </td>
              <td>
                <input
                  id="ogg-auto-query"
                  name="ogg-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="ogg-manual-query"
                  name="ogg-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getOggMetadata())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="ogg-query-endpoint"
                  id="ogg-query-endpoint"
                  type="url"
                  disabled
                />
              </td>
            </tr>
            <tr>
              <td class="stats-row-name">
                <label for="sevenhtml-auto-query">7.html</label>
              </td>
              <td>
                <input
                  id="sevenhtml-auto-query"
                  name="sevenhtml-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="sevenhtml-manual-query"
                  name="sevenhtml-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getSevenhtml())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="sevenhtml-query-endpoint"
                  id="sevenhtml-query-endpoint"
                  type="url"
                />
              </td>
            </tr>
            <tr>
              <td class="stats-row-name">
                <label for="icestats-auto-query">status-json.xsl</label>
              </td>
              <td>
                <input
                  id="icestats-auto-query"
                  name="icestats-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="icestats-manual-query"
                  name="icestats-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getIcestats())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="icestats-query-endpoint"
                  id="icestats-query-endpoint"
                  type="url"
                />
              </td>
            </tr>
            <tr>
              <td class="stats-row-name">
                <label for="stats-auto-query">stats</label>
              </td>
              <td>
                <input
                  id="stats-auto-query"
                  name="stats-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="stats-manual-query"
                  name="stats-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getStats())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="stats-query-endpoint"
                  id="stats-query-endpoint"
                  type="url"
                />
              </td>
            </tr>
            <tr>
              <td class="stats-row-name">
                <label for="nextsongs-auto-query">nextsongs</label>
              </td>
              <td>
                <input
                  id="nextsongs-auto-query"
                  name="nextsongs-auto-query"
                  type="checkbox"
                />
              </td>
              <td>
                <button
                  id="nextsongs-manual-query"
                  name="nextsongs-manual-query"
                  onclick="manualQuery(this, icecastMetadataStats.getNextsongs())"
                >
                  Fetch
                </button>
              </td>
              <td>
                <input
                  class="query-endpoint"
                  name="nextsongs-query-endpoint"
                  id="nextsongs-query-endpoint"
                  type="url"
                />
              </td>
            </tr>
          </table>
          <div class="column">
            <label for="interval">Stats Update Interval (S)</label>
            <input
              type="number"
              id="interval"
              name="interval"
              min="1"
              value="30"
            />
          </div>
        </fieldset>
      </form>
    </div>
    <div id="audioInfo"></div>
    <hr />
    <strong>Metadata</strong>
    <div class="metadata-info">
      <table>
        <th>Current Time</th>
        <th class="metadata-header">Now Playing</th>
        <tr>
          <td class="time"><div id="currentTime"></div></td>
          <td class="metadata"><div id="metadata"></div></td>
        </tr>
      </table>
      <table id="metadataQueue"></table>
    </div>
  </body>
  <script>
    const icyMetaIntEl = document.getElementById("icyMetaInt");
    const metadataEl = document.getElementById("metadata");
    const metadataQueueEl = document.getElementById("metadataQueue");

    const currentTimeEl = document.getElementById("currentTime");
    currentTimeEl.attachShadow({ mode: "open" });
    const audioInfoEl = document.getElementById("audioInfo");
    audioInfoEl.attachShadow({ mode: "open" });

    let icecastMetadataPlayer, icecastMetadataStats, timer;

    const onMetadata = (metadata) => {
      metadataEl.innerHTML = `<pre>${formatMetadata(metadata)}</pre>`;

      onMetadataEnqueue();
    };

    const onMetadataEnqueue = () => {
      metadataQueueEl.innerHTML = icecastMetadataPlayer.metadataQueue.reduce(
        (acc, { metadata, timestampOffset }) =>
          acc +
          `<tr><td class="time">${formatTime(timestampOffset)}</td>` +
          `<td class="metadata"><pre>${formatMetadata(
            metadata
          )}</pre></td></tr>`,
        `<th>Update Time&nbsp</th><th class="metadata-header">Up Next</th>`
      );
    };

    const onCodecUpdate = (audioCodecData) => {
      audioInfoEl.shadowRoot.innerHTML = `<pre>${formatMetadata(
        audioCodecData
      )}</pre>`;
    };

    const getIcecastMetadataStats = () => {
      if (icecastMetadataStats) icecastMetadataStats.stop();

      const sources = [];
      statsFormData["icy-auto-query"] && sources.push("icy");
      statsFormData["ogg-auto-query"] && sources.push("ogg");
      statsFormData["sevenhtml-auto-query"] && sources.push("sevenhtml");
      statsFormData["icestats-auto-query"] && sources.push("icestats");
      statsFormData["stats-auto-query"] && sources.push("stats");
      statsFormData["nextsongs-auto-query"] && sources.push("nextsongs");

      icecastMetadataStats = new IcecastMetadataStats(playerFormData.endpoint, {
        onStats: (stats) => {
          console.log(stats);
        },
        onStatsFetch: (sources) => {
          console.log(sources);
        },
        sources,
        interval: statsFormData.interval,
        icyDetectionTimeout: parseInt(playerFormData.icyDetectionTimeout),
        icestatsEndpoint: statsFormData.icestatsEndpoint,
        statsEndpoint: statsFormData.statsEndpoint,
        nextsongsEndpoint: statsFormData.nextsongsEndpoint,
        sevenhtmlEndpoint: statsFormData.sevenhtmlEndpoint,
      });

      document.getElementById("icy-query-endpoint").value =
        playerFormData.endpoint;
      document.getElementById("ogg-query-endpoint").value =
        playerFormData.endpoint;
      document.getElementById("icestats-query-endpoint").value =
        icecastMetadataStats.icestatsEndpoint;
      document.getElementById("stats-query-endpoint").value =
        icecastMetadataStats.statsEndpoint;
      document.getElementById("nextsongs-query-endpoint").value =
        icecastMetadataStats.nextsongsEndpoint;
      document.getElementById("sevenhtml-query-endpoint").value =
        icecastMetadataStats.sevenhtmlEndpoint;
    };

    document.getElementById("stats-start").addEventListener("click", () => {
      getIcecastMetadataStats();
      icecastMetadataStats.start();
    });

    document.getElementById("stats-stop").addEventListener("click", () => {
      icecastMetadataStats.stop();
    });

    // gets a new instance of the IcecastMetadataPlayer and starts a timer
    const getIcecastMetadataPlayer = () => {
      const metadataTypes = [];
      playerFormData.icy && metadataTypes.push("icy");
      playerFormData.ogg && metadataTypes.push("ogg");

      icecastMetadataPlayer = new IcecastMetadataPlayer(
        playerFormData.endpoint,
        {
          onMetadata,
          onMetadataEnqueue,
          onCodecUpdate,
          metadataTypes,
          icyDetectionTimeout: parseInt(playerFormData.icyDetectionTimeout),
          enableLogging: true,
          onPlay: () => {
            icyMetaIntEl.value = icecastMetadataPlayer.icyMetaInt || "";

            let time = 0;
            clearInterval(timer);
            timer = setInterval(() => {
              time += 0.1;
              currentTimeEl.shadowRoot.innerHTML = formatTime(time.toFixed(2));
            }, 100);
          },
          onStop: () => {
            clearInterval(timer);
          },
          onError: (message) => {
            metadataEl.innerHTML = message;
          },
        }
      );

      icecastMetadataPlayer.addEventListener("metadata", (...args) => {
        console.log(args);
      });
    };

    document.getElementById("play").addEventListener("click", () => {
      if (icecastMetadataPlayer) icecastMetadataPlayer.stop();

      currentTimeEl.shadowRoot.innerHTML = "";
      audioInfoEl.shadowRoot.innerHTML = "";
      metadataEl.innerHTML = "Loading...";
      metadataQueueEl.innerHTML = "";
      currentTimeEl.innerHTML = "00:00.00";

      getIcecastMetadataPlayer();
      icecastMetadataPlayer.play();
    });

    document.getElementById("stop").addEventListener("click", () => {
      icecastMetadataPlayer.stop();
    });
  </script>
</html>
