/*! 
 * Copyright 2021 Ethan Halsall
 * https://github.com/eshaz/icecast-metadata-js
 *
 * This file is part of icecast-metadata-stats.
 *
 * icecast-metadata-stats free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * icecast-metadata-stats distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
var IcecastMetadataStats;(()=>{var t={764:t=>{const s=()=>{};t.exports=class{constructor({icyBr:t,onMetadataUpdate:e=s,onMetadataEnqueue:i=s}){this.t=t,this.i=e,this.h=i,this.l=!0,this.u=[]}get metadataQueue(){return this.u.map((({m:t,...s})=>s))}addMetadata({metadata:t,stats:s},e,i=0){this.g(t,e,i+this.getTimeByBytes(s.currentStreamPosition))}getTimeByBytes(t){return this.t?t/(125*this.t):0}purgeMetadataQueue(){this.u.forEach((t=>clearTimeout(t.m))),this.u=[]}g(t,s,e){const i={metadata:t,timestampOffset:s,timestamp:e};this.u.push(i),this.h(t,s,e),this.l?(this.p(),this.l=!1):i.m=setTimeout((()=>{this.p()}),1e3*(s-e))}p(){const{metadata:t,timestampOffset:s,timestamp:e}=this.u.shift();this.i(t,s,e)}}},420:(t,s,e)=>{const i=e(395),a=e(103),r=e(361),n=e(399);t.exports=class{constructor({metadataTypes:t=["icy"],...s}={}){const e=t.includes("icy"),h=t.includes("ogg");this.S=e&&h?new n(s):h?new r(s):e?new a(s):new i(s)}static parseIcyMetadata(t){return a.parseIcyMetadata(t)}get icyMetaInt(){return this.S.icyMetaInt}*iterator(t){yield*this.S.iterator(t)}readAll(t){this.S.readAll(t)}async*asyncIterator(t){return yield*this.S.asyncIterator(t)}async asyncReadAll(t){return this.S.asyncReadAll(t)}}},705:(t,s,e)=>{const i=e(420),a=()=>{};class r{constructor(t,{icyMetaInt:s,onStream:e=a,...n}){let h;this.I=new ReadableStream({async start(a){h=new i({...n,icyMetaInt:parseInt(t.headers.get("Icy-MetaInt"))||s,onStream:async t=>(a.enqueue(t.stream),e(t))});for await(const s of r.asyncIterator(t.body))await h.asyncReadAll(s);a.close()}}),this.M=h}get icyMetaInt(){return this.M.icyMetaInt}get readableStream(){return this.I}async startReading(){try{for await(const t of r.asyncIterator(this.I));}catch(t){if("AbortError"!==t.name)throw t}}static asyncIterator(t){const s=t.getReader();return{[Symbol.asyncIterator]:()=>({next:()=>s.read()})}}}t.exports=r},399:(t,s,e)=>{const i=e(103),a=e(361);t.exports=class{constructor(t){const{onStream:s,...e}=t;this.A=new a(t),this._=new i(e)}get icyMetaInt(){return this._.icyMetaInt}*iterator(t){for(const s of this._.iterator(t))s.stream?yield*this.A.iterator(s.stream):yield s}readAll(t){for(const s of this._.iterator(t))s.stream&&this.A.readAll(s.stream)}async*asyncIterator(t){for await(const s of this._.asyncIterator(t))if(s.stream)for await(const t of this.A.asyncIterator(s.stream))yield t;else yield s}async asyncReadAll(t){for await(const s of this._.iterator(t))s.stream&&await this.A.asyncReadAll(s.stream)}}},103:(t,s,e)=>{const i=e(395);class a extends i{constructor({icyMetaInt:t,icyDetectionTimeout:s=2e3,...e}){super(e),this.v=t,this.C=s,this.T=this.B(),this.T.next()}*B(){if(yield*this.R())for(;;)this.$=this.v,yield*this.D(),yield*this.O(),this.$&&(yield*this.L());this.$=1/0,yield*this.D()}static parseIcyMetadata(t){const s=/(?<key>[^\0]+?)='(?<val>[^\0]*?)(;$|';|'$|$)/,e={};for(const i of t.match(new RegExp(s,"g"))||[]){const t=i.match(s);t&&(e[t.groups.key]=t.groups.val)}return e}get icyMetaInt(){return this.v}*R(){if(this.v>0)return!0;if(!this.C)return!1;this.P("Passed in Icy-MetaInt is invalid. Attempting to detect ICY Metadata.","See https://github.com/eshaz/icecast-metadata-js for information on how to properly request ICY Metadata.");const t=[null,83,116,114,101,97,109,84,105,116,108,101,61],s=Date.now();let e=0;for(;s+this.C>Date.now();){this.N=i.G(this.N,yield*this.j());t:for(;e<this.N.length-t.length;){for(let s=1;s<t.length;s++)if(this.N[s+e]!==t[s]){e++;continue t}return this.P(`Found ICY Metadata! Setting Icy-MetaInt to ${e}.`),this.v=e,!0}}return this.P("ICY Metadata not detected, but continuing anyway. Audio errors will occur if there is ICY metadata.",`Searched ${this.N.length} bytes for ${(Date.now()-s)/1e3} seconds.`,"Try increasing the `icyDetectionTimeout` value if ICY metadata is present in the stream."),this.U("icy"),!1}*D(){for(this.Y.currentStreamBytesRemaining=this.$;this.$;)yield*this.k(yield*super.V())}*O(){this.$=1;do{this.$=16*(yield*this.V())[0]}while(1===this.$);this.Y.addMetadataLengthBytes(1)}*L(){this.Y.currentMetadataBytesRemaining=this.$;const t=yield*this.V(this.$);this.Y.addMetadataBytes(t.length),yield*this.q(a.parseIcyMetadata(this.F.decode(t)))}}t.exports=a},395:(t,s,e)=>{const i=e(792).TextDecoder||TextDecoder,a=e(4),r=()=>{};class n{constructor(t){this.$=0,this.H=0,this.N=new Uint8Array(0),this.Y=new a,this.F=new i("utf-8"),this.J=t.onStream||r,this.W=t.onMetadata||r,this.U=t.onMetadataFailed||r,this.K=t.onError||r,this.X=t.enableLogging||!1,this.Z=Promise.resolve(),this.tt=Promise.resolve(),this.T=this.st(),this.T.next()}*st(){for(this.$=1/0;;)yield*this.k(yield*this.V())}static G(t,s){const e=new Uint8Array(t.length+s.length);return e.set(t),e.set(s,t.length),e}*iterator(t){for(let s=this.T.next(t);s.value;s=this.T.next())yield s.value}readAll(t){for(let s=this.T.next(t);s.value;s=this.T.next());}async*asyncIterator(t){for(let s=this.T.next(t);s.value;s=this.T.next())await this.Z,await this.tt,yield s.value}async asyncReadAll(t){for(let s=this.T.next(t);s.value;s=this.T.next())await this.Z,await this.tt}P(...t){this.X&&console.warn("icecast-metadata-js",t.reduce(((t,s)=>t+"\n  "+s),"")),this.K(...t)}*k(t){this.Y.addStreamBytes(t.length);const s={stream:t,stats:this.Y.stats};this.Z=this.J(s),yield s}*q(t){const s={metadata:t,stats:this.Y.stats};this.tt=this.W(s),yield s}*V(t=0){for(this.H===this.N.length&&(this.N=yield*this.j(),this.H=0);this.N.length-this.H<t;)this.N=n.G(this.N,yield*this.j());const s=this.N.subarray(this.H,(t||this.$)+this.H);return this.Y.addBytes(s.length),this.$=s.length<this.$?this.$-s.length:0,this.H+=s.length,s}*j(){let t;do{t=yield}while(!t||0===t.length);return this.Y.addCurrentBytesRemaining(t.length),t}}t.exports=n},361:(t,s,e)=>{const i=e(395);t.exports=class extends i{constructor(t){super(t),this.T=this.et(),this.T.next()}*et(){if(yield*this.it()){const t=yield*this.at();if(t)for(;yield*this.it();)yield*this.L(t),yield*this.D()}this.$=1/0,yield*this.D()}rt(t,s=0){return new DataView(Uint8Array.from([...t.subarray(s,s+4)]).buffer).getUint32(0,!0)}nt(t,s){return String.fromCharCode(...s).match(t)}*it(){let t=[];for(;t.length<=65307;){const s=yield*super.V(5);if(79===s[0]&&103===s[1]&&103===s[2]&&83===s[3]&&!(248&s[5])){this.H-=5,this.$+=5,this.Y.ht-=5,this.Y.ot+=5;break}t.push(s[0]),this.H-=4,this.Y.ht-=4,this.Y.ot+=4}if(t.length&&(yield*this.k(Uint8Array.from(t))),t.length>65307)return this.P("This stream is not an OGG stream. No OGG metadata will be returned.","See https://github.com/eshaz/icecast-metadata-js for information on OGG metadata."),this.U("ogg"),!1;const s=yield*this.V(27),e=yield*this.V(s[26]);return this.$=e.reduce(((t,s)=>t+s),0),!0}*at(){const t=yield*this.V(8);return yield*this.D(),this.nt(/\x7fFLAC/,t.subarray(0,5))?{regex:/^[\x84|\x04]/,length:4}:this.nt(/OpusHead/,t.subarray(0,8))?{regex:/OpusTags/,length:8}:this.nt(/\x01vorbis/,t.subarray(0,7))?{regex:/\x03vorbis/,length:7}:void 0}*L({regex:t,length:s}){this.nt(t,yield*this.V(s))&&(yield*this.q(yield*this.ct()))}*D(){for(;this.$;)yield*this.V()}*V(t){const s=yield*super.V(t);return yield*this.k(s),s}*j(){const t=yield*super.j();return this.Y.currentStreamBytesRemaining=t.length,t}*ct(){const t=this.rt(yield*this.V(4));this.Y.addMetadataBytes(4);const s=this.F.decode(yield*this.V(t));this.Y.addMetadataBytes(t);const e=this.rt(yield*this.V(4));this.Y.addMetadataBytes(4);const i=[];for(let t=0;t<e;t++){const t=yield*this.V(4);this.Y.addMetadataBytes(4),i.push(yield*this.V(this.rt(t))),this.Y.addMetadataBytes(i[i.length-1].length)}return this.Y.currentMetadataBytesRemaining=0,i.reduce(((t,s)=>{const e=s.indexOf(61),i=String.fromCharCode(...s.subarray(0,e)).toUpperCase(),a=this.F.decode(s.subarray(e+1));return t[i]=t[i]?`${t[i]}; ${a}`:a,t}),{VENDOR_STRING:s})}}},4:t=>{t.exports=class{constructor(){this.ht=0,this.lt=0,this.dt=0,this.yt=0,this.ot=0,this.ut=0,this.gt=0}get stats(){return{totalBytesRead:this.ht,streamBytesRead:this.lt,metadataLengthBytesRead:this.dt,metadataBytesRead:this.yt,currentBytesRemaining:this.ot,currentStreamBytesRemaining:this.ut,currentMetadataBytesRemaining:this.gt}}set currentStreamBytesRemaining(t){this.ut+=t}set currentMetadataBytesRemaining(t){this.gt=t}addBytes(t){this.ht+=t,this.ot-=t}addStreamBytes(t){this.lt+=t,this.ut-=t}addMetadataLengthBytes(t){this.dt+=t}addMetadataBytes(t){this.yt+=t,this.gt-=t}addCurrentBytesRemaining(t){this.ot+=t}}},792:()=>{}},s={};function e(i){var a=s[i];if(void 0!==a)return a.exports;var r=s[i]={exports:{}};return t[i](r,r.exports,e),r.exports}e.n=t=>{var s=t&&t.ft?()=>t.default:()=>t;return e.d(s,{a:s}),s},e.d=(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},e.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s);var i={};(()=>{"use strict";e.d(i,{default:()=>L});e(764),e(420);var t=e(705),s=e.n(t);const a=()=>{},r="stopped",n="fetching",h=new WeakMap,o=Symbol(),c=Symbol(),l=Symbol(),d=Symbol(),y=Symbol(),u=Symbol(),m=Symbol(),g=Symbol(),p=Symbol(),f=Symbol(),b=Symbol(),w=Symbol(),S=Symbol(),I=Symbol(),M=Symbol(),x=Symbol(),A=Symbol(),_=Symbol(),v=Symbol(),C=Symbol(),T=Symbol(),B=Symbol(),R=Symbol(),$=Symbol(),D=Symbol(),E=Symbol(),O=Symbol();class L{constructor(t,s={}){h.set(this,{}),h.get(this)[A]=t;const e=h.get(this)[A].split("/");e.pop();const i=e.join("/");h.get(this)[y]=s.icestatsEndpoint||`${i}/status-json.xsl`,h.get(this)[g]=s.statsEndpoint||`${i}/stats`,h.get(this)[b]=s.nextsongsEndpoint||`${i}/nextsongs`,h.get(this)[I]=s.sevenhtmlEndpoint||`${i}/7.html`,h.get(this)[C]=s.sources||["icestats","stats","nextsongs","sevenhtml","icy","ogg"],h.get(this)[_]=s.icyMetaInt,h.get(this)[v]=s.icyDetectionTimeout,h.get(this)[T]=1e3*(s.interval||30),h.get(this)[B]=s.onStats||a,h.get(this)[R]=s.onStatsFetch||a,h.get(this)[o]=new AbortController,h.get(this)[l]=new AbortController,h.get(this)[u]=new AbortController,h.get(this)[p]=new AbortController,h.get(this)[w]=new AbortController,h.get(this)[M]=new AbortController,h.get(this)[$]=r}static xml2Json(t){const s=t=>{if(!t.children.length)return Number.isNaN(Number(t.innerHTML))?t.innerHTML:Number(t.innerHTML);const e={};for(const i of t.children)i.nodeName in e?Array.isArray(e[i.nodeName])?e[i.nodeName].push(s(i)):e[i.nodeName]=[e[i.nodeName],s(i)]:e[i.nodeName]=s(i);return e};return s((t=>(new DOMParser).parseFromString(t,"application/xml"))(t))}get state(){return h.get(this)[$]}get icestatsEndpoint(){return h.get(this)[y]}get statsEndpoint(){return h.get(this)[g]}get nextsongsEndpoint(){return h.get(this)[b]}get sevenhtmlEndpoint(){return h.get(this)[I]}start(){h.get(this)[$]===r&&(h.get(this)[$]="running",this.fetch().then(h.get(this)[B]),h.get(this)[D]=setInterval((()=>{this.fetch().then(h.get(this)[B])}),h.get(this)[T]))}stop(){h.get(this)[$]!==r&&(h.get(this)[$]=r,clearInterval(h.get(this)[D]),h.get(this)[o].abort(),h.get(this)[l].abort(),h.get(this)[u].abort(),h.get(this)[p].abort(),h.get(this)[M].abort())}async fetch(){if(h.get(this)[$]!==n){const t=h.get(this)[$];h.get(this)[$]=n,h.get(this)[R](h.get(this)[C]);const s=[];h.get(this)[C].includes("icestats")&&s.push(this.getIcestats()),h.get(this)[C].includes("sevenhtml")&&s.push(this.getSevenhtml()),h.get(this)[C].includes("stats")&&s.push(this.getStats()),h.get(this)[C].includes("nextsongs")&&s.push(this.getNextsongs()),h.get(this)[C].includes("icy")&&s.push(this.getIcyMetadata()),h.get(this)[C].includes("ogg")&&s.push(this.getOggMetadata());const e=await Promise.all(s).then((t=>t.reduce(((t,s)=>({...t,...s})),{})));return h.get(this)[$]=h.get(this)[$]!==n?h.get(this)[$]:t,e}}async getIcestats(){return this[E]({status:m,endpoint:h.get(this)[y],controller:h.get(this)[u],mapper:t=>t.json()}).then((t=>({icestats:t&&t.icestats}))).finally((()=>{h.get(this)[u]=new AbortController}))}async getSevenhtml(){return this[E]({status:x,endpoint:h.get(this)[I],controller:h.get(this)[M],mapper:async t=>(await t.text()).match(/(.*?)<\/body>/gi).map((t=>{const s=t.match(/(<body>|,)(?<stats>.*)<\/body>/i).groups.stats.split(",");return 7===s.length?{StreamTitle:s[6],currentListeners:parseInt(s[4]),peakListeners:parseInt(s[2]),maxListeners:parseInt(s[3]),bitrate:parseInt(s[5]),status:parseInt(s[1]),serverListeners:parseInt(s[0])}:{StreamTitle:s[4],currentListeners:parseInt(s[2]),peakListeners:parseInt(s[0]),maxListeners:parseInt(s[1]),bitrate:parseInt(s[3])}}))}).then((t=>({sevenhtml:t}))).finally((()=>{h.get(this)[M]=new AbortController}))}async getStats(){return this[E]({status:f,endpoint:h.get(this)[g],controller:h.get(this)[p],mapper:async t=>t.text().then((t=>L.xml2Json(t).SHOUTCASTSERVER.STREAMSTATS))}).then((t=>({stats:t}))).finally((()=>{h.get(this)[p]=new AbortController}))}async getNextsongs(){return this[E]({status:S,endpoint:h.get(this)[b],controller:h.get(this)[w],mapper:async t=>t.text().then((t=>L.xml2Json(t).SHOUTCASTSERVER.NEXTSONGS))}).then((t=>({nextsongs:t}))).finally((()=>{h.get(this)[w]=new AbortController}))}async getIcyMetadata(){return this[O]({status:c,endpoint:h.get(this)[A],controller:h.get(this)[o],metadataType:"icy",headers:{"Icy-MetaData":1}}).finally((()=>{h.get(this)[o]=new AbortController}))}async getOggMetadata(){return this[O]({status:d,endpoint:h.get(this)[A],controller:h.get(this)[l],metadataType:"ogg"}).finally((()=>{h.get(this)[l]=new AbortController}))}async[O]({status:t,endpoint:e,controller:i,headers:a,metadataType:r}){return this[E]({status:t,endpoint:e,controller:i,headers:a,mapper:async t=>new Promise((e=>{new(s())(t,{onMetadata:({metadata:t})=>{i.abort(),e(t)},onMetadataFailed:()=>{i.abort(),e()},metadataTypes:r,icyMetaInt:h.get(this)[_],icyDetectionTimeout:h.get(this)[v]}).startReading()}))}).then((t=>({[r]:t})))}async[E]({status:t,endpoint:s,controller:e,mapper:i,headers:a={}}){if(!h.get(this)[t])return h.get(this)[t]=!0,fetch(s,{method:"GET",headers:a,signal:e.signal}).then((s=>{if(h.get(this)[t]=!1,!s.ok)throw new Error(`HTTP Error ${s.status}`);return s})).then(i).catch((t=>{"AbortError"!==t.name&&console.warn(`Failed to fetch ${s}`,t)}))}}})(),IcecastMetadataStats=i.default})();
//# sourceMappingURL=icecast-metadata-stats-0.0.1.min.js.map