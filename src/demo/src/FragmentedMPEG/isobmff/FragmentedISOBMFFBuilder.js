/* Copyright 2020 Ethan Halsall

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>
*/

import Box from "./Box";

/**
 * @description Fragmented ISO Base Media File Format Builder is a class to
 * wrap MPEG frames in a MP4 container for streaming MP3 compatibility in Firefox.
 */
export default class FragmentedISOBMFFBuilder {
  static getBoxContents(boxes) {
    return Uint8Array.from(boxes.flatMap((box) => [...box.contents]));
  }

  /**
   * @returns {Uint8Array} Generic Filetype and Movie Box information for MP3
   */
  static getMp3MovieBox({ sampleRate = 44100 } = {}) {
    const boxes = [
      new Box("ftyp", {
        /* prettier-ignore */
        contents: [0x69,0x73,0x6F,0x6D,0x00,0x00,0x02,0x00,0x69,0x73,0x6F,0x6D,0x69,0x73,0x6F,0x32,0x69,0x73,0x6F,0x36,0x6D,0x70,0x34,0x31],
      }),
      new Box("moov", {
        boxes: [
          new Box("mvhd", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xe8,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02],
          }),
          new Box("trak", {
            boxes: [
              new Box("tkhd", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
              }),
              new Box("mdia", {
                boxes: [
                  new Box("mdhd", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                      ...Box.getUint32(sampleRate),
                      0x00,0x00,0x00,0x00,0x55,0xc4,0x00,0x00],
                  }),
                  new Box("hdlr", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6f,0x75,0x6e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6f,0x75,0x6e,0x64,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00],
                  }),
                  new Box("minf", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x10,0x73,0x6d,0x68,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0x64,0x69,0x6e,0x66,0x00,0x00,0x00,0x1c,0x64,0x72,0x65,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0c,0x75,0x72,0x6c,0x20,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xac,0x73,0x74,0x62,0x6c,0x00,0x00,0x00,0x60,0x73,0x74,0x73,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x50,0x6d,0x70,0x34,0x61,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x10,0x00,0x00,0x00,0x00,0xac,0x44,0x00,0x00,0x00,0x00,0x00,0x2c,0x65,0x73,0x64,0x73,0x00,0x00,0x00,0x00,0x03,0x80,0x80,0x80,0x1b,0x00,0x01,0x00,0x04,0x80,0x80,0x80,0x0d,0x6b,0x15,0x00,0x00,0x00,0x00,0x04,0xe2,0x00,0x00,0x00,0x00,0x00,0x06,0x80,0x80,0x80,0x01,0x02,0x00,0x00,0x00,0x10,0x73,0x74,0x74,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x73,0x74,0x73,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x14,0x73,0x74,0x73,0x7a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x73,0x74,0x63,0x6f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
                  }),
                ],
              }),
            ],
          }),
          new Box("mvex", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x20,0x74,0x72,0x65,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
          }),
          new Box("udta", {
            boxes: [
              new Box("meta", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x00],
              }),
              new Box("hdlr", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6d,0x64,0x69,0x72,0x61,0x70,0x70,0x6c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
              }),
              new Box("ilst", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x25,0xa9,0x74,0x6f,0x6f,0x00,0x00,0x00,0x1d,0x64,0x61,0x74,0x61,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x4c,0x61,0x76,0x66,0x35,0x38,0x2e,0x32,0x39,0x2e,0x31,0x30,0x30],
              }),
            ],
          }),
        ],
      }),
    ];

    return FragmentedISOBMFFBuilder.getBoxContents(boxes);
  }

  /**
   * @description Wraps MPEG frames into a Movie Fragment
   * @param {Array<Uint8Array>} frames MPEG frames to contain in this Movie Fragment
   * @returns {Uint8Array} Movie Fragment containing the MPEG frames
   */
  static wrapMp3InMovieFragment(frames) {
    const trun = new Box("trun", {
      /* prettier-ignore */
      contents: [
        0x00,0x00,0x02,0x01, //flags
        ...Box.getUint32(frames.length), // number of samples
        ...frames.flatMap((frame) => [...Box.getUint32(frame.length)]), // samples lengths
      ],
    });

    const boxes = [
      new Box("moof", {
        boxes: [
          new Box("traf", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x14,0x74,0x66,0x64,0x74,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
            boxes: [
              new Box("tfhd", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x39,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xBF,0x00,0x00,0x04,0x80,
                  ...Box.getUint32(frames[0].length), // default sample size
                  0x02,0x00,0x00,0x00],
              }),
              trun,
            ],
          }),
        ],
      }),
      new Box("mdat", {
        contents: frames.flatMap((frame) => [...frame]),
      }),
    ];

    trun.insertBytes(Box.getUint32(boxes[0].length + 12), 8); // data offset (moof length + mdat length + mdat)

    return FragmentedISOBMFFBuilder.getBoxContents(boxes);
  }
}
