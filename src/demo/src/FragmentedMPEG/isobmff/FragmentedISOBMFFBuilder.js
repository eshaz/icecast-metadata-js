/* Copyright 2020 Ethan Halsall

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>
*/

import Box from "./Box";
import ESDescriptor from "./ESDescriptor";

/**
 * @description Fragmented ISO Base Media File Format Builder is a class to
 * wrap MPEG frames in a MP4 container for streaming MP3 compatibility in Firefox.
 */
export default class FragmentedISOBMFFBuilder {
  static getBoxContents(boxes) {
    return Uint8Array.from(boxes.flatMap((box) => [...box.contents]));
  }

  /**
   * @param {Header} header MPEG header
   * @returns {Uint8Array} Generic Filetype and Movie Box information for MP3
   */
  getMpegMovieBox(header) {
    const boxes = [
      new Box("ftyp", {
        /* prettier-ignore */
        contents: [0x69,0x73,0x6F,0x6D,0x00,0x00,0x02,0x00,
          0x69,0x73,0x6F,0x6D,0x69,0x73,0x6F,0x32,
          0x69,0x73,0x6F,0x36,0x6D,0x70,0x34,0x31],
      }),
      new Box("moov", {
        boxes: [
          new Box("mvhd", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xe8,
              0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
              0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
              0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
              0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
              0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
              0x00,0x00,0x00,0x02],
          }),
          new Box("trak", {
            boxes: [
              new Box("tkhd", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
                  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x00],
              }),
              new Box("mdia", {
                boxes: [
                  new Box("mdhd", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                      0x00,0x00,0x00,0x00,
                      ...Box.getUint32(header.sampleRate), // sample rate
                      0x00,0x00,0x00,0x00,0x55,0xc4,0x00,0x00],
                  }),
                  new Box("hdlr", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6f,0x75,0x6e,0x00,0x00,0x00,0x00,
                      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6f,0x75,0x6e,0x64,0x48,0x61,0x6e,
                      0x64,0x6c,0x65,0x72,0x00],
                  }),
                  new Box("minf", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x10,0x73,0x6d,0x68,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                      0x00,0x00,0x00,0x24,0x64,0x69,0x6e,0x66,0x00,0x00,0x00,0x1c,0x64,0x72,0x65,0x66,
                      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0c,0x75,0x72,0x6c,0x20,
                      0x00,0x00,0x00,0x01],
                    boxes: [
                      new Box("stbl", {
                        boxes: [
                          new Box("stsd", {
                            /* prettier-ignore */
                            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01],
                            boxes: [
                              new Box("mp4a", {
                                /* prettier-ignore */
                                contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                                  0x00,header.channels, // channel count
                                  0x00,0x10, // PCM bitrate (16bit)
                                  0x00,0x00,
                                  ...Box.getUint32(header.sampleRate), // sample rate
                                  0x00,0x00],
                                boxes: [new ESDescriptor(header)],
                              }),
                            ],
                          }),
                          new Box("stts", {
                            /* prettier-ignore */
                            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
                          }),
                          new Box("stsc", {
                            /* prettier-ignore */
                            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
                          }),
                          new Box("stsz", {
                            /* prettier-ignore */
                            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                              0x00,0x00,0x00,0x00],
                          }),
                          new Box("stco", {
                            /* prettier-ignore */
                            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
                          }),
                        ],
                      }),
                    ],
                  }),
                ],
              }),
            ],
          }),
          new Box("mvex", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x20,0x74,0x72,0x65,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
              0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
          }),
          new Box("udta", {
            boxes: [
              new Box("meta", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x00],
                boxes: [
                  new Box("hdlr", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6d,0x64,0x69,0x72,0x61,0x70,0x70,0x6c,
                      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
                  }),
                  new Box("ilst", {
                    /* prettier-ignore */
                    contents: [0x00,0x00,0x00,0x25,0xa9,0x74,0x6f,0x6f,0x00,0x00,0x00,0x1d,0x64,0x61,0x74,0x61,
                      0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x4c,0x61,0x76,0x66,0x35,0x38,0x2e,0x32,
                      0x39,0x2e,0x31,0x30,0x30],
                  }),
                ],
              }),
            ],
          }),
        ],
      }),
    ];

    const contents = FragmentedISOBMFFBuilder.getBoxContents(boxes);

    this._moovLength = contents.length;

    return contents;
  }

  /**
   * @description Wraps MPEG frames into a Movie Fragment
   * @param {Array<Frame>} frames MPEG frames to contain in this Movie Fragment
   * @returns {Uint8Array} Movie Fragment containing the MPEG frames
   */
  wrapMpegFrames(frames) {
    const trun = new Box("trun", {
      /* prettier-ignore */
      contents: [
        0x00,0x00,0x02,0x01, //flags
        ...Box.getUint32(frames.length), // number of frames
        ...frames.flatMap((frame) => [...Box.getUint32(frame.data.length)]), // samples lengths per frame
      ],
    });

    const boxes = [
      new Box("moof", {
        boxes: [
          new Box("mfhd", {
            /* prettier-ignore */
            contents: [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01],
          }),
          new Box("traf", {
            boxes: [
              new Box("tfhd", {
                /* prettier-ignore */
                contents: [0x00,0x00,0x00,0x39,0x00,0x00,0x00,0x01,
                  0x00,0x00,0x00,0x00,
                  ...Box.getUint32(this._moovLength), // base data offset length of moov box, mp3: 0x00,0x00,0x02,0xbf
                  ...Box.getUint32(frames[0].header.sampleLength), // default sample duration
                  ...Box.getUint32(frames[0].data.length), // default sample size (avg of all frames)
                  0x02,0x00,0x00,0x00],
              }),
              new Box("tfdt", {
                /* prettier-ignore */
                contents: [0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x00],
              }),
              trun,
            ],
          }),
        ],
      }),
      new Box("mdat", {
        contents: frames.flatMap((frame) => [...frame.data]),
      }),
    ];

    trun.insertBytes(Box.getUint32(boxes[0].length + 12), 8); // data offset (moof length + mdat length + mdat)

    return FragmentedISOBMFFBuilder.getBoxContents(boxes);
  }
}
